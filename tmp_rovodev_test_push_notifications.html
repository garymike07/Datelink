<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Push Notification Test - PureMatch254</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-top: 0; }
        h2 { color: #666; font-size: 18px; border-bottom: 2px solid #e91e63; padding-bottom: 8px; }
        button {
            background: #e91e63;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 8px 8px 8px 0;
            font-weight: 500;
        }
        button:hover { background: #c2185b; }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            font-size: 14px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .status.warning { background: #fff3cd; color: #856404; }
        pre {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>ðŸ”” Push Notification Test</h1>
        <p>Test the push notification system for PureMatch254</p>
    </div>

    <div class="card">
        <h2>1. Browser Support & Permission</h2>
        <div id="support-status" class="status info">Checking browser support...</div>
        <button id="request-permission" disabled>Request Permission</button>
        <button id="check-subscription" disabled>Check Subscription</button>
    </div>

    <div class="card">
        <h2>2. Service Worker</h2>
        <div id="sw-status" class="status info">Checking service worker...</div>
        <button id="register-sw" disabled>Register Service Worker</button>
        <button id="unregister-sw" disabled>Unregister Service Worker</button>
    </div>

    <div class="card">
        <h2>3. Test Notifications</h2>
        <div class="grid">
            <button id="test-basic" disabled>Basic Notification</button>
            <button id="test-message" disabled>Message Notification</button>
            <button id="test-call" disabled>Incoming Call</button>
            <button id="test-match" disabled>New Match</button>
        </div>
        <div id="test-status" class="status info" style="display:none;"></div>
    </div>

    <div class="card">
        <h2>4. Debug Info</h2>
        <button id="show-debug">Show Debug Info</button>
        <pre id="debug-info" style="display:none;"></pre>
    </div>

    <script>
        const statusEl = document.getElementById('support-status');
        const swStatusEl = document.getElementById('sw-status');
        const testStatusEl = document.getElementById('test-status');
        const debugInfoEl = document.getElementById('debug-info');

        let registration = null;

        // Check browser support
        function checkSupport() {
            const hasNotifications = 'Notification' in window;
            const hasSW = 'serviceWorker' in navigator;
            const hasPush = 'PushManager' in window;

            if (hasNotifications && hasSW && hasPush) {
                statusEl.textContent = `âœ… Browser supports push notifications. Current permission: ${Notification.permission}`;
                statusEl.className = 'status success';
                document.getElementById('request-permission').disabled = false;
                document.getElementById('register-sw').disabled = false;
            } else {
                const missing = [];
                if (!hasNotifications) missing.push('Notifications API');
                if (!hasSW) missing.push('Service Workers');
                if (!hasPush) missing.push('Push Manager');
                statusEl.textContent = `âŒ Missing: ${missing.join(', ')}`;
                statusEl.className = 'status error';
            }
        }

        // Request notification permission
        async function requestPermission() {
            try {
                const permission = await Notification.requestPermission();
                statusEl.textContent = `Permission: ${permission}`;
                statusEl.className = permission === 'granted' ? 'status success' : 'status warning';
                
                if (permission === 'granted') {
                    enableTestButtons();
                }
            } catch (error) {
                statusEl.textContent = `Error: ${error.message}`;
                statusEl.className = 'status error';
            }
        }

        // Register service worker
        async function registerServiceWorker() {
            try {
                registration = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
                await navigator.serviceWorker.ready;
                
                swStatusEl.textContent = `âœ… Service Worker registered. State: ${registration.active?.state}`;
                swStatusEl.className = 'status success';
                
                document.getElementById('unregister-sw').disabled = false;
                document.getElementById('check-subscription').disabled = false;
                
                enableTestButtons();
            } catch (error) {
                swStatusEl.textContent = `âŒ Error: ${error.message}`;
                swStatusEl.className = 'status error';
            }
        }

        // Unregister service worker
        async function unregisterServiceWorker() {
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (let reg of registrations) {
                    await reg.unregister();
                }
                swStatusEl.textContent = 'âœ… Service Worker unregistered';
                swStatusEl.className = 'status info';
                registration = null;
                disableTestButtons();
            } catch (error) {
                swStatusEl.textContent = `âŒ Error: ${error.message}`;
                swStatusEl.className = 'status error';
            }
        }

        // Check subscription status
        async function checkSubscription() {
            try {
                const reg = await navigator.serviceWorker.ready;
                const subscription = await reg.pushManager.getSubscription();
                
                if (subscription) {
                    testStatusEl.textContent = 'âœ… Push subscription active';
                    testStatusEl.className = 'status success';
                } else {
                    testStatusEl.textContent = 'âš ï¸ No active push subscription';
                    testStatusEl.className = 'status warning';
                }
                testStatusEl.style.display = 'block';
            } catch (error) {
                testStatusEl.textContent = `âŒ Error: ${error.message}`;
                testStatusEl.className = 'status error';
                testStatusEl.style.display = 'block';
            }
        }

        // Enable test buttons
        function enableTestButtons() {
            document.getElementById('test-basic').disabled = false;
            document.getElementById('test-message').disabled = false;
            document.getElementById('test-call').disabled = false;
            document.getElementById('test-match').disabled = false;
        }

        // Disable test buttons
        function disableTestButtons() {
            document.getElementById('test-basic').disabled = true;
            document.getElementById('test-message').disabled = true;
            document.getElementById('test-call').disabled = true;
            document.getElementById('test-match').disabled = true;
        }

        // Test basic notification
        async function testBasic() {
            const reg = await navigator.serviceWorker.ready;
            await reg.showNotification('Test Notification', {
                body: 'This is a basic test notification',
                icon: '/logo.svg',
                badge: '/favicon.svg',
                tag: 'test-basic',
                data: { url: '/', type: 'test' }
            });
            showTestStatus('Basic notification sent!');
        }

        // Test message notification
        async function testMessage() {
            const reg = await navigator.serviceWorker.ready;
            await reg.showNotification('John Doe', {
                body: 'Hey! How are you doing? ðŸ˜Š',
                icon: '/logo.svg',
                badge: '/favicon.svg',
                tag: 'message-test',
                data: { 
                    url: '/messages',
                    type: 'message',
                    senderId: 'test123'
                },
                actions: [
                    { action: 'reply', title: 'ðŸ’¬ Reply', icon: '/logo.svg' },
                    { action: 'view', title: 'ðŸ‘ï¸ View', icon: '/logo.svg' }
                ],
                vibrate: [200, 100, 200]
            });
            showTestStatus('Message notification sent!');
        }

        // Test incoming call notification
        async function testCall() {
            const reg = await navigator.serviceWorker.ready;
            await reg.showNotification('Incoming Video Call ðŸ“ž', {
                body: 'Sarah Johnson is calling you...',
                icon: '/logo.svg',
                badge: '/favicon.svg',
                tag: 'incoming-call',
                requireInteraction: true,
                data: { 
                    url: '/call/test123',
                    type: 'call_incoming',
                    callId: 'test123',
                    callType: 'video'
                },
                actions: [
                    { action: 'answer', title: 'ðŸ“ž Answer', icon: '/logo.svg' },
                    { action: 'decline', title: 'âŒ Decline', icon: '/logo.svg' }
                ],
                vibrate: [500, 200, 500, 200, 500]
            });
            showTestStatus('Call notification sent! (will stay until you interact)');
        }

        // Test match notification
        async function testMatch() {
            const reg = await navigator.serviceWorker.ready;
            await reg.showNotification('New Match! ðŸ’–', {
                body: 'You and Emma matched! Say hi.',
                icon: '/logo.svg',
                badge: '/favicon.svg',
                tag: 'match-test',
                data: { 
                    url: '/matches',
                    type: 'match'
                },
                actions: [
                    { action: 'view', title: 'ðŸ‘‹ Say Hi', icon: '/logo.svg' }
                ],
                vibrate: [300, 100, 300]
            });
            showTestStatus('Match notification sent!');
        }

        // Show test status
        function showTestStatus(message) {
            testStatusEl.textContent = message;
            testStatusEl.className = 'status success';
            testStatusEl.style.display = 'block';
            setTimeout(() => {
                testStatusEl.style.display = 'none';
            }, 3000);
        }

        // Show debug info
        async function showDebug() {
            const info = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                notificationPermission: Notification.permission,
                serviceWorkerSupport: 'serviceWorker' in navigator,
                pushSupport: 'PushManager' in window,
            };

            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                info.serviceWorkerRegistrations = registrations.length;
                
                if (registrations.length > 0) {
                    const reg = registrations[0];
                    info.serviceWorkerState = reg.active?.state;
                    info.serviceWorkerScope = reg.scope;
                    
                    const subscription = await reg.pushManager.getSubscription();
                    info.hasPushSubscription = !!subscription;
                    if (subscription) {
                        info.subscriptionEndpoint = subscription.endpoint.substring(0, 50) + '...';
                    }
                }
            }

            debugInfoEl.textContent = JSON.stringify(info, null, 2);
            debugInfoEl.style.display = 'block';
        }

        // Event listeners
        document.getElementById('request-permission').addEventListener('click', requestPermission);
        document.getElementById('register-sw').addEventListener('click', registerServiceWorker);
        document.getElementById('unregister-sw').addEventListener('click', unregisterServiceWorker);
        document.getElementById('check-subscription').addEventListener('click', checkSubscription);
        document.getElementById('test-basic').addEventListener('click', testBasic);
        document.getElementById('test-message').addEventListener('click', testMessage);
        document.getElementById('test-call').addEventListener('click', testCall);
        document.getElementById('test-match').addEventListener('click', testMatch);
        document.getElementById('show-debug').addEventListener('click', showDebug);

        // Initialize
        checkSupport();

        // Check if service worker is already registered
        navigator.serviceWorker.getRegistrations().then(registrations => {
            if (registrations.length > 0) {
                registration = registrations[0];
                swStatusEl.textContent = `âœ… Service Worker already registered. State: ${registration.active?.state}`;
                swStatusEl.className = 'status success';
                document.getElementById('unregister-sw').disabled = false;
                document.getElementById('check-subscription').disabled = false;
                
                if (Notification.permission === 'granted') {
                    enableTestButtons();
                }
            }
        });
    </script>
</body>
</html>
