{"data":"aW1wb3J0IHsgdiB9IGZyb20gImNvbnZleC92YWx1ZXMiOwppbXBvcnQgeyBtdXRhdGlvbiwgcXVlcnkgfSBmcm9tICIuL19nZW5lcmF0ZWQvc2VydmVyIjsKaW1wb3J0IHR5cGUgeyBNdXRhdGlvbkN0eCB9IGZyb20gIi4vX2dlbmVyYXRlZC9zZXJ2ZXIiOwppbXBvcnQgeyBJZCB9IGZyb20gIi4vX2dlbmVyYXRlZC9kYXRhTW9kZWwiOwoKLy8gWFAgbGV2ZWxzIGNvbmZpZ3VyYXRpb24KY29uc3QgWFBfUEVSX0xFVkVMID0gMTAwMDsgLy8gQmFzZSBYUCBuZWVkZWQgZm9yIGxldmVsIDIKY29uc3QgTEVWRUxfTVVMVElQTElFUiA9IDEuNTsgLy8gRWFjaCBsZXZlbCByZXF1aXJlcyAxLjV4IG1vcmUgWFAKCi8vIENhbGN1bGF0ZSBYUCBuZWVkZWQgZm9yIGEgc3BlY2lmaWMgbGV2ZWwKZnVuY3Rpb24gZ2V0WFBGb3JMZXZlbChsZXZlbDogbnVtYmVyKTogbnVtYmVyIHsKICBpZiAobGV2ZWwgPD0gMSkgcmV0dXJuIDA7CiAgbGV0IHRvdGFsWFAgPSAwOwogIGZvciAobGV0IGkgPSAyOyBpIDw9IGxldmVsOyBpKyspIHsKICAgIHRvdGFsWFAgKz0gTWF0aC5mbG9vcihYUF9QRVJfTEVWRUwgKiBNYXRoLnBvdyhMRVZFTF9NVUxUSVBMSUVSLCBpIC0gMikpOwogIH0KICByZXR1cm4gdG90YWxYUDsKfQoKLy8gQ2FsY3VsYXRlIGxldmVsIGZyb20gWFAKZnVuY3Rpb24gZ2V0TGV2ZWxGcm9tWFAoeHA6IG51bWJlcik6IG51bWJlciB7CiAgbGV0IGxldmVsID0gMTsKICB3aGlsZSAoeHAgPj0gZ2V0WFBGb3JMZXZlbChsZXZlbCArIDEpKSB7CiAgICBsZXZlbCsrOwogIH0KICByZXR1cm4gbGV2ZWw7Cn0KCmFzeW5jIGZ1bmN0aW9uIGF3YXJkWFAoCiAgY3R4OiBNdXRhdGlvbkN0eCwKICBhcmdzOiB7IHVzZXJJZDogSWQ8InVzZXJzIj47IGFtb3VudDogbnVtYmVyOyByZWFzb246IHN0cmluZyB9CikgewogIC8vIEdldCBvciBjcmVhdGUgdXNlciBwcm9ncmVzcwogIGxldCBwcm9ncmVzcyA9IGF3YWl0IGN0eC5kYgogICAgLnF1ZXJ5KCJ1c2VyUHJvZ3Jlc3MiKQogICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIGFyZ3MudXNlcklkKSkKICAgIC5maXJzdCgpOwoKICBpZiAoIXByb2dyZXNzKSB7CiAgICBjb25zdCBwcm9ncmVzc0lkID0gYXdhaXQgY3R4LmRiLmluc2VydCgidXNlclByb2dyZXNzIiwgewogICAgICB1c2VySWQ6IGFyZ3MudXNlcklkLAogICAgICBsZXZlbDogMSwKICAgICAgeHA6IDAsCiAgICAgIGJhZGdlczogW10sCiAgICAgIGNyZWF0ZWRBdDogRGF0ZS5ub3coKSwKICAgICAgdXBkYXRlZEF0OiBEYXRlLm5vdygpLAogICAgfSk7CiAgICBwcm9ncmVzcyA9IGF3YWl0IGN0eC5kYi5nZXQocHJvZ3Jlc3NJZCk7CiAgfQoKICBpZiAoIXByb2dyZXNzKSB0aHJvdyBuZXcgRXJyb3IoIkZhaWxlZCB0byBjcmVhdGUgdXNlciBwcm9ncmVzcyIpOwoKICBjb25zdCBvbGRMZXZlbCA9IHByb2dyZXNzLmxldmVsOwogIGNvbnN0IG5ld1hQID0gcHJvZ3Jlc3MueHAgKyBhcmdzLmFtb3VudDsKICBjb25zdCBuZXdMZXZlbCA9IGdldExldmVsRnJvbVhQKG5ld1hQKTsKICBjb25zdCBsZXZlbGVkVXAgPSBuZXdMZXZlbCA+IG9sZExldmVsOwoKICBhd2FpdCBjdHguZGIucGF0Y2gocHJvZ3Jlc3MuX2lkLCB7CiAgICB4cDogbmV3WFAsCiAgICBsZXZlbDogbmV3TGV2ZWwsCiAgICB1cGRhdGVkQXQ6IERhdGUubm93KCksCiAgfSk7CgogIC8vIExvZyBhY3Rpdml0eQogIGF3YWl0IGN0eC5kYi5pbnNlcnQoImFjdGl2aXR5TG9nIiwgewogICAgdXNlcklkOiBhcmdzLnVzZXJJZCwKICAgIGFjdGl2aXR5VHlwZTogInhwX2Vhcm5lZCIsCiAgICBtZXRhZGF0YTogeyBhbW91bnQ6IGFyZ3MuYW1vdW50LCByZWFzb246IGFyZ3MucmVhc29uIH0sCiAgICB0aW1lc3RhbXA6IERhdGUubm93KCksCiAgfSk7CgogIHJldHVybiB7CiAgICBuZXdYUCwKICAgIGxldmVsZWRVcCwKICAgIG5ld0xldmVsLAogICAgb2xkTGV2ZWwsCiAgICB4cEZvck5leHRMZXZlbDogZ2V0WFBGb3JMZXZlbChuZXdMZXZlbCArIDEpLAogIH07Cn0KCi8vIEluaXRpYWxpemUgdXNlciBwcm9ncmVzcwpleHBvcnQgY29uc3QgaW5pdGlhbGl6ZVVzZXJQcm9ncmVzcyA9IG11dGF0aW9uKHsKICBhcmdzOiB7IHVzZXJJZDogdi5pZCgidXNlcnMiKSB9LAogIGhhbmRsZXI6IGFzeW5jIChjdHgsIGFyZ3MpID0+IHsKICAgIGNvbnN0IGV4aXN0aW5nID0gYXdhaXQgY3R4LmRiCiAgICAgIC5xdWVyeSgidXNlclByb2dyZXNzIikKICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIGFyZ3MudXNlcklkKSkKICAgICAgLmZpcnN0KCk7CgogICAgaWYgKGV4aXN0aW5nKSByZXR1cm4gZXhpc3Rpbmc7CgogICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsKICAgIHJldHVybiBhd2FpdCBjdHguZGIuaW5zZXJ0KCJ1c2VyUHJvZ3Jlc3MiLCB7CiAgICAgIHVzZXJJZDogYXJncy51c2VySWQsCiAgICAgIGxldmVsOiAxLAogICAgICB4cDogMCwKICAgICAgYmFkZ2VzOiBbXSwKICAgICAgY3JlYXRlZEF0OiBub3csCiAgICAgIHVwZGF0ZWRBdDogbm93LAogICAgfSk7CiAgfSwKfSk7CgovLyBBZGQgWFAgdG8gdXNlcgpleHBvcnQgY29uc3QgYWRkWFAgPSBtdXRhdGlvbih7CiAgYXJnczogewogICAgdXNlcklkOiB2LmlkKCJ1c2VycyIpLAogICAgYW1vdW50OiB2Lm51bWJlcigpLAogICAgcmVhc29uOiB2LnN0cmluZygpLAogIH0sCiAgaGFuZGxlcjogYXN5bmMgKGN0eCwgYXJncykgPT4gewogICAgcmV0dXJuIGF3YWl0IGF3YXJkWFAoY3R4LCBhcmdzKTsKICB9LAp9KTsKCi8vIEdldCB1c2VyIHByb2dyZXNzCmV4cG9ydCBjb25zdCBnZXRVc2VyUHJvZ3Jlc3MgPSBxdWVyeSh7CiAgYXJnczogeyB1c2VySWQ6IHYuaWQoInVzZXJzIikgfSwKICBoYW5kbGVyOiBhc3luYyAoY3R4LCBhcmdzKSA9PiB7CiAgICBjb25zdCBwcm9ncmVzcyA9IGF3YWl0IGN0eC5kYgogICAgICAucXVlcnkoInVzZXJQcm9ncmVzcyIpCiAgICAgIC53aXRoSW5kZXgoInVzZXJJZCIsIChxKSA9PiBxLmVxKCJ1c2VySWQiLCBhcmdzLnVzZXJJZCkpCiAgICAgIC5maXJzdCgpOwoKICAgIGlmICghcHJvZ3Jlc3MpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBsZXZlbDogMSwKICAgICAgICB4cDogMCwKICAgICAgICBiYWRnZXM6IFtdLAogICAgICAgIHhwRm9yTmV4dExldmVsOiBnZXRYUEZvckxldmVsKDIpLAogICAgICAgIHhwUHJvZ3Jlc3M6IDAsCiAgICAgIH07CiAgICB9CgogICAgY29uc3QgeHBGb3JOZXh0TGV2ZWwgPSBnZXRYUEZvckxldmVsKHByb2dyZXNzLmxldmVsICsgMSk7CiAgICBjb25zdCB4cEZvckN1cnJlbnRMZXZlbCA9IGdldFhQRm9yTGV2ZWwocHJvZ3Jlc3MubGV2ZWwpOwogICAgY29uc3QgeHBQcm9ncmVzcyA9IHByb2dyZXNzLnhwIC0geHBGb3JDdXJyZW50TGV2ZWw7CiAgICBjb25zdCB4cE5lZWRlZCA9IHhwRm9yTmV4dExldmVsIC0geHBGb3JDdXJyZW50TGV2ZWw7CiAgICBjb25zdCBwcm9ncmVzc1BlcmNlbnQgPSAoeHBQcm9ncmVzcyAvIHhwTmVlZGVkKSAqIDEwMDsKCiAgICByZXR1cm4gewogICAgICAuLi5wcm9ncmVzcywKICAgICAgeHBGb3JOZXh0TGV2ZWwsCiAgICAgIHhwUHJvZ3Jlc3MsCiAgICAgIHhwTmVlZGVkLAogICAgICBwcm9ncmVzc1BlcmNlbnQsCiAgICB9OwogIH0sCn0pOwoKLy8gUXVlc3QgdHlwZXMgYW5kIGNvbmZpZ3VyYXRpb25zCmNvbnN0IFFVRVNUX1RZUEVTID0gewogIGNvbXBsZXRlX3Byb2ZpbGU6IHsKICAgIG5hbWU6ICJDb21wbGV0ZSBZb3VyIFByb2ZpbGUiLAogICAgZGVzY3JpcHRpb246ICJBZGQgMyBtb3JlIHBob3RvcyB0byB5b3VyIHByb2ZpbGUiLAogICAgdGFyZ2V0OiAzLAogICAgeHBSZXdhcmQ6IDUwLAogIH0sCiAgc2VuZF9tZXNzYWdlczogewogICAgbmFtZTogIkJlIFNvY2lhYmxlIiwKICAgIGRlc2NyaXB0aW9uOiAiU2VuZCA1IG1lc3NhZ2VzIHRvZGF5IiwKICAgIHRhcmdldDogNSwKICAgIHhwUmV3YXJkOiAxMDAsCiAgfSwKICBzd2lwZV9wcm9maWxlczogewogICAgbmFtZTogIk1ha2UgQ29ubmVjdGlvbnMiLAogICAgZGVzY3JpcHRpb246ICJTd2lwZSBvbiA1MCBwcm9maWxlcyIsCiAgICB0YXJnZXQ6IDUwLAogICAgeHBSZXdhcmQ6IDc1LAogIH0sCiAgZ2V0X3JlcGxpZXM6IHsKICAgIG5hbWU6ICJDb252ZXJzYXRpb24gU3RhcnRlciIsCiAgICBkZXNjcmlwdGlvbjogIkdldCAzIHJlcGxpZXMgdG8geW91ciBtZXNzYWdlcyIsCiAgICB0YXJnZXQ6IDMsCiAgICB4cFJld2FyZDogMTUwLAogIH0sCiAgdXBkYXRlX3Bob3RvOiB7CiAgICBuYW1lOiAiRmlyc3QgSW1wcmVzc2lvbiIsCiAgICBkZXNjcmlwdGlvbjogIlVwZGF0ZSB5b3VyIHByb2ZpbGUgcGhvdG8iLAogICAgdGFyZ2V0OiAxLAogICAgeHBSZXdhcmQ6IDI1LAogIH0sCn07CgovLyBHZW5lcmF0ZSBkYWlseSBxdWVzdHMKZXhwb3J0IGNvbnN0IGdlbmVyYXRlRGFpbHlRdWVzdHMgPSBtdXRhdGlvbih7CiAgYXJnczogeyB1c2VySWQ6IHYuaWQoInVzZXJzIikgfSwKICBoYW5kbGVyOiBhc3luYyAoY3R4LCBhcmdzKSA9PiB7CiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpOwogICAgY29uc3QgZW5kT2ZEYXkgPSBuZXcgRGF0ZSgpOwogICAgZW5kT2ZEYXkuc2V0SG91cnMoMjMsIDU5LCA1OSwgOTk5KTsKICAgIGNvbnN0IGV4cGlyZXNBdCA9IGVuZE9mRGF5LmdldFRpbWUoKTsKCiAgICAvLyBDaGVjayBpZiB1c2VyIGFscmVhZHkgaGFzIGFjdGl2ZSBxdWVzdHMgZm9yIHRvZGF5CiAgICBjb25zdCBleGlzdGluZ1F1ZXN0cyA9IGF3YWl0IGN0eC5kYgogICAgICAucXVlcnkoInF1ZXN0cyIpCiAgICAgIC53aXRoSW5kZXgoInVzZXJJZCIsIChxKSA9PiBxLmVxKCJ1c2VySWQiLCBhcmdzLnVzZXJJZCkpCiAgICAgIC5maWx0ZXIoKHEpID0+IHEuZ3QocS5maWVsZCgiZXhwaXJlc0F0IiksIG5vdykpCiAgICAgIC5jb2xsZWN0KCk7CgogICAgaWYgKGV4aXN0aW5nUXVlc3RzLmxlbmd0aCA+IDApIHsKICAgICAgcmV0dXJuIGV4aXN0aW5nUXVlc3RzOwogICAgfQoKICAgIC8vIEdlbmVyYXRlIDMgcmFuZG9tIHF1ZXN0cwogICAgY29uc3QgcXVlc3RUeXBlS2V5cyA9IE9iamVjdC5rZXlzKFFVRVNUX1RZUEVTKSBhcyAoa2V5b2YgdHlwZW9mIFFVRVNUX1RZUEVTKVtdOwogICAgY29uc3Qgc2VsZWN0ZWRRdWVzdHMgPSBxdWVzdFR5cGVLZXlzCiAgICAgIC5zb3J0KCgpID0+IE1hdGgucmFuZG9tKCkgLSAwLjUpCiAgICAgIC5zbGljZSgwLCAzKTsKCiAgICBjb25zdCBxdWVzdHMgPSBbXTsKICAgIGZvciAoY29uc3QgcXVlc3RUeXBlIG9mIHNlbGVjdGVkUXVlc3RzKSB7CiAgICAgIGNvbnN0IGNvbmZpZyA9IFFVRVNUX1RZUEVTW3F1ZXN0VHlwZV07CiAgICAgIGNvbnN0IHF1ZXN0SWQgPSBhd2FpdCBjdHguZGIuaW5zZXJ0KCJxdWVzdHMiLCB7CiAgICAgICAgdXNlcklkOiBhcmdzLnVzZXJJZCwKICAgICAgICBxdWVzdFR5cGUsCiAgICAgICAgcHJvZ3Jlc3M6IDAsCiAgICAgICAgdGFyZ2V0OiBjb25maWcudGFyZ2V0LAogICAgICAgIHhwUmV3YXJkOiBjb25maWcueHBSZXdhcmQsCiAgICAgICAgZXhwaXJlc0F0LAogICAgICAgIGNyZWF0ZWRBdDogbm93LAogICAgICB9KTsKICAgICAgcXVlc3RzLnB1c2goewogICAgICAgIF9pZDogcXVlc3RJZCwKICAgICAgICBxdWVzdFR5cGUsCiAgICAgICAgLi4uY29uZmlnLAogICAgICAgIHByb2dyZXNzOiAwLAogICAgICAgIGV4cGlyZXNBdCwKICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIHF1ZXN0czsKICB9LAp9KTsKCi8vIEdldCBhY3RpdmUgcXVlc3RzIGZvciB1c2VyCmV4cG9ydCBjb25zdCBnZXRBY3RpdmVRdWVzdHMgPSBxdWVyeSh7CiAgYXJnczogeyB1c2VySWQ6IHYuaWQoInVzZXJzIikgfSwKICBoYW5kbGVyOiBhc3luYyAoY3R4LCBhcmdzKSA9PiB7CiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpOwogICAgY29uc3QgcXVlc3RzID0gYXdhaXQgY3R4LmRiCiAgICAgIC5xdWVyeSgicXVlc3RzIikKICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIGFyZ3MudXNlcklkKSkKICAgICAgLmZpbHRlcigocSkgPT4gcS5ndChxLmZpZWxkKCJleHBpcmVzQXQiKSwgbm93KSkKICAgICAgLmNvbGxlY3QoKTsKCiAgICByZXR1cm4gcXVlc3RzLm1hcCgocXVlc3QpID0+IHsKICAgICAgY29uc3QgY29uZmlnID0gUVVFU1RfVFlQRVNbcXVlc3QucXVlc3RUeXBlIGFzIGtleW9mIHR5cGVvZiBRVUVTVF9UWVBFU107CiAgICAgIHJldHVybiB7CiAgICAgICAgLi4ucXVlc3QsCiAgICAgICAgbmFtZTogY29uZmlnPy5uYW1lIHx8ICJRdWVzdCIsCiAgICAgICAgZGVzY3JpcHRpb246IGNvbmZpZz8uZGVzY3JpcHRpb24gfHwgIiIsCiAgICAgICAgcHJvZ3Jlc3NQZXJjZW50OiAocXVlc3QucHJvZ3Jlc3MgLyBxdWVzdC50YXJnZXQpICogMTAwLAogICAgICB9OwogICAgfSk7CiAgfSwKfSk7CgovLyBVcGRhdGUgcXVlc3QgcHJvZ3Jlc3MKZXhwb3J0IGNvbnN0IHVwZGF0ZVF1ZXN0UHJvZ3Jlc3MgPSBtdXRhdGlvbih7CiAgYXJnczogewogICAgdXNlcklkOiB2LmlkKCJ1c2VycyIpLAogICAgcXVlc3RUeXBlOiB2LnN0cmluZygpLAogICAgaW5jcmVtZW50OiB2Lm9wdGlvbmFsKHYubnVtYmVyKCkpLAogIH0sCiAgaGFuZGxlcjogYXN5bmMgKGN0eCwgYXJncykgPT4gewogICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsKICAgIGNvbnN0IHF1ZXN0ID0gYXdhaXQgY3R4LmRiCiAgICAgIC5xdWVyeSgicXVlc3RzIikKICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIGFyZ3MudXNlcklkKSkKICAgICAgLmZpbHRlcigocSkgPT4KICAgICAgICBxLmFuZCgKICAgICAgICAgIHEuZXEocS5maWVsZCgicXVlc3RUeXBlIiksIGFyZ3MucXVlc3RUeXBlKSwKICAgICAgICAgIHEuZ3QocS5maWVsZCgiZXhwaXJlc0F0IiksIG5vdyksCiAgICAgICAgICBxLmVxKHEuZmllbGQoImNvbXBsZXRlZEF0IiksIHVuZGVmaW5lZCkKICAgICAgICApCiAgICAgICkKICAgICAgLmZpcnN0KCk7CgogICAgaWYgKCFxdWVzdCkgcmV0dXJuIG51bGw7CgogICAgY29uc3QgbmV3UHJvZ3Jlc3MgPSBxdWVzdC5wcm9ncmVzcyArIChhcmdzLmluY3JlbWVudCB8fCAxKTsKICAgIGNvbnN0IGlzQ29tcGxldGVkID0gbmV3UHJvZ3Jlc3MgPj0gcXVlc3QudGFyZ2V0OwoKICAgIGF3YWl0IGN0eC5kYi5wYXRjaChxdWVzdC5faWQsIHsKICAgICAgcHJvZ3Jlc3M6IE1hdGgubWluKG5ld1Byb2dyZXNzLCBxdWVzdC50YXJnZXQpLAogICAgICAuLi4oaXNDb21wbGV0ZWQgPyB7IGNvbXBsZXRlZEF0OiBub3cgfSA6IHt9KSwKICAgIH0pOwoKICAgIC8vIEF3YXJkIFhQIGlmIGNvbXBsZXRlZAogICAgaWYgKGlzQ29tcGxldGVkKSB7CiAgICAgIGF3YWl0IGF3YXJkWFAoY3R4LCB7CiAgICAgICAgdXNlcklkOiBhcmdzLnVzZXJJZCwKICAgICAgICBhbW91bnQ6IHF1ZXN0LnhwUmV3YXJkLAogICAgICAgIHJlYXNvbjogYENvbXBsZXRlZCBxdWVzdDogJHthcmdzLnF1ZXN0VHlwZX1gLAogICAgICB9KTsKICAgIH0KCiAgICByZXR1cm4gewogICAgICBxdWVzdCwKICAgICAgY29tcGxldGVkOiBpc0NvbXBsZXRlZCwKICAgICAgcHJvZ3Jlc3M6IG5ld1Byb2dyZXNzLAogICAgfTsKICB9LAp9KTsKCi8vIENvbXBsZXRlIGEgcXVlc3QgbWFudWFsbHkKZXhwb3J0IGNvbnN0IGNvbXBsZXRlUXVlc3QgPSBtdXRhdGlvbih7CiAgYXJnczogewogICAgcXVlc3RJZDogdi5pZCgicXVlc3RzIiksCiAgfSwKICBoYW5kbGVyOiBhc3luYyAoY3R4LCBhcmdzKSA9PiB7CiAgICBjb25zdCBxdWVzdCA9IGF3YWl0IGN0eC5kYi5nZXQoYXJncy5xdWVzdElkKTsKICAgIGlmICghcXVlc3QgfHwgcXVlc3QuY29tcGxldGVkQXQpIHJldHVybiBudWxsOwoKICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7CiAgICBhd2FpdCBjdHguZGIucGF0Y2goYXJncy5xdWVzdElkLCB7CiAgICAgIGNvbXBsZXRlZEF0OiBub3csCiAgICAgIHByb2dyZXNzOiBxdWVzdC50YXJnZXQsCiAgICB9KTsKCiAgICAvLyBBd2FyZCBYUAogICAgYXdhaXQgYXdhcmRYUChjdHgsIHsKICAgICAgdXNlcklkOiBxdWVzdC51c2VySWQsCiAgICAgIGFtb3VudDogcXVlc3QueHBSZXdhcmQsCiAgICAgIHJlYXNvbjogYENvbXBsZXRlZCBxdWVzdDogJHtxdWVzdC5xdWVzdFR5cGV9YCwKICAgIH0pOwoKICAgIHJldHVybiBxdWVzdDsKICB9LAp9KTsK"}