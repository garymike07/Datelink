{"data":"aW1wb3J0IHsgbXV0YXRpb24sIHF1ZXJ5IH0gZnJvbSAiLi9fZ2VuZXJhdGVkL3NlcnZlciI7CmltcG9ydCB7IHYgfSBmcm9tICJjb252ZXgvdmFsdWVzIjsKCmZ1bmN0aW9uIGdldERheUtleVV0Yyhub3dNczogbnVtYmVyKSB7CiAgY29uc3QgZCA9IG5ldyBEYXRlKG5vd01zKTsKICBjb25zdCB5ID0gZC5nZXRVVENGdWxsWWVhcigpOwogIGNvbnN0IG0gPSBTdHJpbmcoZC5nZXRVVENNb250aCgpICsgMSkucGFkU3RhcnQoMiwgIjAiKTsKICBjb25zdCBkYXkgPSBTdHJpbmcoZC5nZXRVVENEYXRlKCkpLnBhZFN0YXJ0KDIsICIwIik7CiAgcmV0dXJuIGAke3l9LSR7bX0tJHtkYXl9YDsKfQoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGlzVXNlclByZW1pdW0oY3R4OiBhbnksIHVzZXJJZDogYW55KSB7CiAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsKICBjb25zdCBzdWIgPSBhd2FpdCBjdHguZGIKICAgIC5xdWVyeSgic3Vic2NyaXB0aW9ucyIpCiAgICAud2l0aEluZGV4KCJ1c2VySWQiLCAocTogYW55KSA9PiBxLmVxKCJ1c2VySWQiLCB1c2VySWQpKQogICAgLm9yZGVyKCJkZXNjIikKICAgIC5maXJzdCgpOwoKICBpZiAoIXN1YikgcmV0dXJuIGZhbHNlOwogIGlmIChzdWIuc3RhdHVzICE9PSAiYWN0aXZlIikgcmV0dXJuIGZhbHNlOwogIGlmIChzdWIucGxhbiAhPT0gInByZW1pdW0iICYmIHN1Yi5wbGFuICE9PSAicHJlbWl1bV9wbHVzIikgcmV0dXJuIGZhbHNlOwogIGlmICh0eXBlb2Ygc3ViLmVuZHNBdCA9PT0gIm51bWJlciIgJiYgc3ViLmVuZHNBdCA8PSBub3cpIHJldHVybiBmYWxzZTsKICByZXR1cm4gdHJ1ZTsKfQoKLy8gUXVlcnkgdmVyc2lvbiBvZiBpc1VzZXJQcmVtaXVtIGZvciB1c2UgaW4gYWN0aW9ucwpleHBvcnQgY29uc3QgY2hlY2tVc2VySGFzUHJlbWl1bSA9IHF1ZXJ5KHsKICBhcmdzOiB7IHVzZXJJZDogdi5pZCgidXNlcnMiKSB9LAogIGhhbmRsZXI6IGFzeW5jIChjdHgsIGFyZ3MpID0+IHsKICAgIHJldHVybiBhd2FpdCBpc1VzZXJQcmVtaXVtKGN0eCwgYXJncy51c2VySWQpOwogIH0sCn0pOwoKYXN5bmMgZnVuY3Rpb24gZW5zdXJlRGFpbHlVc2FnZShjdHg6IGFueSwgdXNlcklkOiBhbnksIG5vd01zOiBudW1iZXIpIHsKICBjb25zdCBkYXlLZXkgPSBnZXREYXlLZXlVdGMobm93TXMpOwogIGNvbnN0IGV4aXN0aW5nID0gYXdhaXQgY3R4LmRiCiAgICAucXVlcnkoImRhaWx5VXNhZ2UiKQogICAgLndpdGhJbmRleCgidXNlckRheSIsIChxOiBhbnkpID0+IHEuZXEoInVzZXJJZCIsIHVzZXJJZCkuZXEoImRheUtleSIsIGRheUtleSkpCiAgICAuZmlyc3QoKTsKCiAgaWYgKGV4aXN0aW5nKSByZXR1cm4gZXhpc3Rpbmc7CgogIC8vIElmIGNhbGxlZCBmcm9tIGEgbXV0YXRpb24gY29udGV4dCwgaW5zZXJ0IG5ldyByZWNvcmQKICBpZiAoY3R4LmRiLmluc2VydCkgewogICAgY29uc3QgaWQgPSBhd2FpdCBjdHguZGIuaW5zZXJ0KCJkYWlseVVzYWdlIiwgewogICAgICB1c2VySWQsCiAgICAgIGRheUtleSwKICAgICAgbGlrZXM6IDAsCiAgICAgIHN1cGVyTGlrZXM6IDAsCiAgICAgIHVwZGF0ZWRBdDogbm93TXMsCiAgICB9KTsKCiAgICBjb25zdCBkb2MgPSBhd2FpdCBjdHguZGIuZ2V0KGlkKTsKICAgIGlmICghZG9jKSB0aHJvdyBuZXcgRXJyb3IoIkZhaWxlZCB0byBpbml0aWFsaXplIGRhaWx5IHVzYWdlIik7CiAgICByZXR1cm4gZG9jOwogIH0KCiAgLy8gSWYgY2FsbGVkIGZyb20gYSBxdWVyeSBjb250ZXh0LCByZXR1cm4gZGVmYXVsdCB2YWx1ZXMKICByZXR1cm4gewogICAgdXNlcklkLAogICAgZGF5S2V5LAogICAgbGlrZXM6IDAsCiAgICBzdXBlckxpa2VzOiAwLAogICAgdXBkYXRlZEF0OiBub3dNcywKICB9Owp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gY29uc3VtZUxpa2UoY3R4OiBhbnksIHVzZXJJZDogYW55KSB7CiAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsKICBjb25zdCBwcmVtaXVtID0gYXdhaXQgaXNVc2VyUHJlbWl1bShjdHgsIHVzZXJJZCk7CiAgY29uc3QgbGltaXRzID0gewogICAgZGFpbHlMaWtlc0xpbWl0OiBwcmVtaXVtID8gOTk5OTk5IDogMTAsCiAgfTsKCiAgY29uc3QgdXNhZ2UgPSBhd2FpdCBlbnN1cmVEYWlseVVzYWdlKGN0eCwgdXNlcklkLCBub3cpOwogIGlmICh1c2FnZS5saWtlcyA+PSBsaW1pdHMuZGFpbHlMaWtlc0xpbWl0KSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIkRhaWx5IGxpa2UgbGltaXQgcmVhY2hlZC4gVXBncmFkZSB0byBQcmVtaXVtIHRvIGtlZXAgc3dpcGluZy4iKTsKICB9CgogIGF3YWl0IGN0eC5kYi5wYXRjaCh1c2FnZS5faWQsIHsKICAgIGxpa2VzOiB1c2FnZS5saWtlcyArIDEsCiAgICB1cGRhdGVkQXQ6IG5vdywKICB9KTsKfQoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNvbnN1bWVTdXBlckxpa2UoY3R4OiBhbnksIHVzZXJJZDogYW55KSB7CiAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsKICBjb25zdCBwcmVtaXVtID0gYXdhaXQgaXNVc2VyUHJlbWl1bShjdHgsIHVzZXJJZCk7CiAgaWYgKCFwcmVtaXVtKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIlN1cGVyIExpa2VzIGFyZSBhIFByZW1pdW0gZmVhdHVyZS4gVXBncmFkZSB0byBjb250aW51ZS4iKTsKICB9CgogIC8vIENoZWNrIGFkZC1vbiBzdGF0dXMgZm9yIFByZW1pdW0gUGx1cwogIGNvbnN0IGFjdGl2ZUFkZG9uID0gYXdhaXQgY3R4LmRiCiAgICAucXVlcnkoInByZW1pdW1BZGRvbnMiKQogICAgLndpdGhJbmRleCgidXNlclN0YXR1cyIsIChxOiBhbnkpID0+IHEuZXEoInVzZXJJZCIsIHVzZXJJZCkuZXEoInN0YXR1cyIsICJhY3RpdmUiKSkKICAgIC5vcmRlcigiZGVzYyIpCiAgICAuZmlyc3QoKTsKICBjb25zdCBwbGFuID0gYWN0aXZlQWRkb24gJiYgKGFjdGl2ZUFkZG9uLmVuZHNBdCA/PyAwKSA+IG5vdyAmJiBhY3RpdmVBZGRvbi5hZGRvblR5cGUgPT09ICJwcmVtaXVtX3BsdXMiID8gInByZW1pdW1fcGx1cyIgOiAicHJlbWl1bSI7CgogIGNvbnN0IGxpbWl0cyA9IHsKICAgIC8vIFByZW1pdW06IDUvZGF5LCBQcmVtaXVtIFBsdXMgKHZpYSBkYWlseSBhZGQtb24pOiAxMC9kYXkKICAgIGRhaWx5U3VwZXJMaWtlc0xpbWl0OiBwbGFuID09PSAicHJlbWl1bV9wbHVzIiA/IDEwIDogNSwKICB9OwoKICBjb25zdCB1c2FnZSA9IGF3YWl0IGVuc3VyZURhaWx5VXNhZ2UoY3R4LCB1c2VySWQsIG5vdyk7CiAgaWYgKHVzYWdlLnN1cGVyTGlrZXMgPj0gbGltaXRzLmRhaWx5U3VwZXJMaWtlc0xpbWl0KSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIkRhaWx5IFN1cGVyIExpa2UgbGltaXQgcmVhY2hlZC4gVHJ5IGFnYWluIHRvbW9ycm93LiIpOwogIH0KCiAgYXdhaXQgY3R4LmRiLnBhdGNoKHVzYWdlLl9pZCwgewogICAgc3VwZXJMaWtlczogdXNhZ2Uuc3VwZXJMaWtlcyArIDEsCiAgICB1cGRhdGVkQXQ6IG5vdywKICB9KTsKfQoKZXhwb3J0IGNvbnN0IGdldE15RW50aXRsZW1lbnRzID0gcXVlcnkoewogIGFyZ3M6IHsgdXNlcklkOiB2LmlkKCJ1c2VycyIpIH0sCiAgaGFuZGxlcjogYXN5bmMgKGN0eCwgYXJncykgPT4gewogICAgY29uc3QgcHJlbWl1bSA9IGF3YWl0IGlzVXNlclByZW1pdW0oY3R4LCBhcmdzLnVzZXJJZCk7CiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpOwogICAgY29uc3QgdXNhZ2UgPSBhd2FpdCBlbnN1cmVEYWlseVVzYWdlKGN0eCwgYXJncy51c2VySWQsIG5vdyk7CgogICAgY29uc3Qgc3ViID0gYXdhaXQgY3R4LmRiCiAgICAgIC5xdWVyeSgic3Vic2NyaXB0aW9ucyIpCiAgICAgIC53aXRoSW5kZXgoInVzZXJJZCIsIChxKSA9PiBxLmVxKCJ1c2VySWQiLCBhcmdzLnVzZXJJZCkpCiAgICAgIC5vcmRlcigiZGVzYyIpCiAgICAgIC5maXJzdCgpOwogICAgLy8gRGFpbHkgYWRkLW9uIGNhbiB0ZW1wb3JhcmlseSB1cGdyYWRlIFByZW1pdW0gdG8gUHJlbWl1bSBQbHVzCiAgICBjb25zdCBhY3RpdmVBZGRvbiA9IGF3YWl0IGN0eC5kYgogICAgICAucXVlcnkoInByZW1pdW1BZGRvbnMiKQogICAgICAud2l0aEluZGV4KCJ1c2VyU3RhdHVzIiwgKHE6IGFueSkgPT4gcS5lcSgidXNlcklkIiwgYXJncy51c2VySWQpLmVxKCJzdGF0dXMiLCAiYWN0aXZlIikpCiAgICAgIC5vcmRlcigiZGVzYyIpCiAgICAgIC5maXJzdCgpOwoKICAgIGNvbnN0IGhhc0FjdGl2ZUFkZG9uID0gISFhY3RpdmVBZGRvbiAmJiAoYWN0aXZlQWRkb24uZW5kc0F0ID8/IDApID4gbm93ICYmIGFjdGl2ZUFkZG9uLmFkZG9uVHlwZSA9PT0gInByZW1pdW1fcGx1cyI7CgogICAgY29uc3QgcGxhbiA9IHByZW1pdW0gPyAoaGFzQWN0aXZlQWRkb24gPyAicHJlbWl1bV9wbHVzIiA6IChzdWI/LnBsYW4gPz8gInByZW1pdW0iKSkgOiAiZnJlZSI7CiAgICAKICAgIHJldHVybiB7CiAgICAgIHBsYW4sCiAgICAgIGlzUHJlbWl1bTogcHJlbWl1bSwKICAgICAgaGFzRGFpbHlBZGRvbjogaGFzQWN0aXZlQWRkb24sCiAgICAgIGRhaWx5QWRkb25FbmRzQXQ6IGhhc0FjdGl2ZUFkZG9uID8gYWN0aXZlQWRkb24uZW5kc0F0IDogbnVsbCwKICAgICAgZGFpbHlMaWtlc0xpbWl0OiBwcmVtaXVtID8gOTk5OTk5IDogMTAsCiAgICAgIGRhaWx5TGlrZXNVc2VkOiB1c2FnZS5saWtlcywKICAgICAgZGFpbHlTdXBlckxpa2VzTGltaXQ6IHBsYW4gPT09ICJwcmVtaXVtX3BsdXMiID8gMTAgOiBwcmVtaXVtID8gNSA6IDAsCiAgICAgIGRhaWx5U3VwZXJMaWtlc1VzZWQ6IHVzYWdlLnN1cGVyTGlrZXMsCiAgICAgIGNhblN1cGVyTGlrZTogcHJlbWl1bSwKICAgICAgY2FuUmV3aW5kOiBwcmVtaXVtLAogICAgfTsKICB9LAp9KTsKCmV4cG9ydCBjb25zdCBnZXRNeVN1YnNjcmlwdGlvbiA9IHF1ZXJ5KHsKICBhcmdzOiB7IHVzZXJJZDogdi5pZCgidXNlcnMiKSB9LAogIGhhbmRsZXI6IGFzeW5jIChjdHgsIGFyZ3MpID0+IHsKICAgIGNvbnN0IHN1YiA9IGF3YWl0IGN0eC5kYgogICAgICAucXVlcnkoInN1YnNjcmlwdGlvbnMiKQogICAgICAud2l0aEluZGV4KCJ1c2VySWQiLCAocSkgPT4gcS5lcSgidXNlcklkIiwgYXJncy51c2VySWQpKQogICAgICAub3JkZXIoImRlc2MiKQogICAgICAuZmlyc3QoKTsKICAgIHJldHVybiBzdWIgPz8gbnVsbDsKICB9LAp9KTsKCmV4cG9ydCBjb25zdCBjYW5jZWxTdWJzY3JpcHRpb24gPSBtdXRhdGlvbih7CiAgYXJnczogewogICAgdXNlcklkOiB2LmlkKCJ1c2VycyIpLAogICAgcmVhc29uOiB2Lm9wdGlvbmFsKHYuc3RyaW5nKCkpLAogICAgaW1tZWRpYXRlOiB2Lm9wdGlvbmFsKHYuYm9vbGVhbigpKSwKICB9LAogIGhhbmRsZXI6IGFzeW5jIChjdHgsIGFyZ3MpID0+IHsKICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7CiAgICBjb25zdCBzdWIgPSBhd2FpdCBjdHguZGIKICAgICAgLnF1ZXJ5KCJzdWJzY3JpcHRpb25zIikKICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIGFyZ3MudXNlcklkKSkKICAgICAgLm9yZGVyKCJkZXNjIikKICAgICAgLmZpcnN0KCk7CiAgICBpZiAoIXN1YikgdGhyb3cgbmV3IEVycm9yKCJObyBzdWJzY3JpcHRpb24gZm91bmQiKTsKICAgIGlmIChzdWIuc3RhdHVzICE9PSAiYWN0aXZlIikgcmV0dXJuIHsgc3RhdHVzOiBzdWIuc3RhdHVzLCBlbmRzQXQ6IHN1Yi5lbmRzQXQgPz8gc3ViLmN1cnJlbnRQZXJpb2RFbmRzID8/IG51bGwgfTsKCiAgICBjb25zdCBlbmRBdCA9IGFyZ3MuaW1tZWRpYXRlID8gbm93IDogKHN1Yi5jdXJyZW50UGVyaW9kRW5kcyA/PyBzdWIuZW5kc0F0ID8/IG5vdyk7CiAgICBhd2FpdCBjdHguZGIucGF0Y2goc3ViLl9pZCwgewogICAgICBzdGF0dXM6ICJjYW5jZWxlZCIsCiAgICAgIGF1dG9SZW5ldzogZmFsc2UsCiAgICAgIGNhbmNlbGVkQXQ6IG5vdywKICAgICAgY2FuY2VsbGF0aW9uUmVhc29uOiBhcmdzLnJlYXNvbiwKICAgICAgZW5kc0F0OiBlbmRBdCwKICAgICAgdXBkYXRlZEF0OiBub3csCiAgICB9KTsKCiAgICByZXR1cm4geyBzdGF0dXM6ICJjYW5jZWxlZCIsIGVuZHNBdDogZW5kQXQgfTsKICB9LAp9KTsKCi8vIFBoYXNlIDI6IEJvb3N0IEZlYXR1cmUKZXhwb3J0IGNvbnN0IGFjdGl2YXRlQm9vc3QgPSBtdXRhdGlvbih7CiAgYXJnczogeyB1c2VySWQ6IHYuaWQoInVzZXJzIikgfSwKICBoYW5kbGVyOiBhc3luYyAoY3R4LCBhcmdzKSA9PiB7CiAgICBjb25zdCBwcmVtaXVtID0gYXdhaXQgaXNVc2VyUHJlbWl1bShjdHgsIGFyZ3MudXNlcklkKTsKICAgIGlmICghcHJlbWl1bSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkJvb3N0cyBhcmUgYSBQcmVtaXVtIGZlYXR1cmUuIFVwZ3JhZGUgdG8gdXNlIGJvb3N0cy4iKTsKICAgIH0KCiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpOwogICAgCiAgICAvLyBDaGVjayBpZiB1c2VyIGFscmVhZHkgaGFzIGFuIGFjdGl2ZSBib29zdAogICAgY29uc3QgYWN0aXZlQm9vc3QgPSBhd2FpdCBjdHguZGIKICAgICAgLnF1ZXJ5KCJib29zdHMiKQogICAgICAud2l0aEluZGV4KCJ1c2VySWQiLCAocSkgPT4gcS5lcSgidXNlcklkIiwgYXJncy51c2VySWQpKQogICAgICAuZmlsdGVyKChxKSA9PiBxLmVxKHEuZmllbGQoInN0YXR1cyIpLCAiYWN0aXZlIikpCiAgICAgIC5maXJzdCgpOwoKICAgIGlmIChhY3RpdmVCb29zdCAmJiBhY3RpdmVCb29zdC5leHBpcmVzQXQgPiBub3cpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3UgYWxyZWFkeSBoYXZlIGFuIGFjdGl2ZSBib29zdC4gV2FpdCB1bnRpbCBpdCBleHBpcmVzLiIpOwogICAgfQoKICAgIC8vIEdldCBzdWJzY3JpcHRpb24gdG8gY2hlY2sgYXZhaWxhYmxlIGJvb3N0cwogICAgY29uc3Qgc3ViID0gYXdhaXQgY3R4LmRiCiAgICAgIC5xdWVyeSgic3Vic2NyaXB0aW9ucyIpCiAgICAgIC53aXRoSW5kZXgoInVzZXJJZCIsIChxKSA9PiBxLmVxKCJ1c2VySWQiLCBhcmdzLnVzZXJJZCkpCiAgICAgIC5vcmRlcigiZGVzYyIpCiAgICAgIC5maXJzdCgpOwoKICAgIGlmICghc3ViKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiU3Vic2NyaXB0aW9uIG5vdCBmb3VuZC4iKTsKICAgIH0KCiAgICAvLyBDcmVhdGUgbmV3IGJvb3N0ICgzMCBtaW51dGVzIGR1cmF0aW9uKQogICAgY29uc3QgYm9vc3RJZCA9IGF3YWl0IGN0eC5kYi5pbnNlcnQoImJvb3N0cyIsIHsKICAgICAgdXNlcklkOiBhcmdzLnVzZXJJZCwKICAgICAgYWN0aXZhdGVkQXQ6IG5vdywKICAgICAgZXhwaXJlc0F0OiBub3cgKyAzMCAqIDYwICogMTAwMCwgLy8gMzAgbWludXRlcwogICAgICBpbXByZXNzaW9uczogMCwKICAgICAgbGlrZXM6IDAsCiAgICAgIHN0YXR1czogImFjdGl2ZSIsCiAgICB9KTsKCiAgICAvLyBVcGRhdGUgcHJvZmlsZSB3aXRoIGJvb3N0IGVuZCB0aW1lCiAgICBjb25zdCBwcm9maWxlID0gYXdhaXQgY3R4LmRiCiAgICAgIC5xdWVyeSgicHJvZmlsZXMiKQogICAgICAud2l0aEluZGV4KCJ1c2VySWQiLCAocSkgPT4gcS5lcSgidXNlcklkIiwgYXJncy51c2VySWQpKQogICAgICAuZmlyc3QoKTsKCiAgICBpZiAocHJvZmlsZSkgewogICAgICBhd2FpdCBjdHguZGIucGF0Y2gocHJvZmlsZS5faWQsIHsKICAgICAgICBib29zdEVuZHNBdDogbm93ICsgMzAgKiA2MCAqIDEwMDAsCiAgICAgICAgdmlzaWJpbGl0eVNjb3JlOiAocHJvZmlsZS52aXNpYmlsaXR5U2NvcmUgfHwgMTAwKSAqIDEwLCAvLyAxMHggdmlzaWJpbGl0eQogICAgICB9KTsKICAgIH0KCiAgICByZXR1cm4geyBib29zdElkLCBleHBpcmVzQXQ6IG5vdyArIDMwICogNjAgKiAxMDAwIH07CiAgfSwKfSk7CgpleHBvcnQgY29uc3QgZ2V0Qm9vc3RTdGF0dXMgPSBxdWVyeSh7CiAgYXJnczogeyB1c2VySWQ6IHYuaWQoInVzZXJzIikgfSwKICBoYW5kbGVyOiBhc3luYyAoY3R4LCBhcmdzKSA9PiB7CiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpOwogICAgY29uc3QgcHJlbWl1bSA9IGF3YWl0IGlzVXNlclByZW1pdW0oY3R4LCBhcmdzLnVzZXJJZCk7CiAgICAKICAgIC8vIEdldCBhY3RpdmUgYm9vc3QKICAgIGNvbnN0IGFjdGl2ZUJvb3N0ID0gYXdhaXQgY3R4LmRiCiAgICAgIC5xdWVyeSgiYm9vc3RzIikKICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIGFyZ3MudXNlcklkKSkKICAgICAgLmZpbHRlcigocSkgPT4gcS5lcShxLmZpZWxkKCJzdGF0dXMiKSwgImFjdGl2ZSIpKQogICAgICAuZmlyc3QoKTsKCiAgICBjb25zdCBpc0FjdGl2ZSA9IGFjdGl2ZUJvb3N0ICYmIGFjdGl2ZUJvb3N0LmV4cGlyZXNBdCA+IG5vdzsKCiAgICAvLyBDb3VudCBhdmFpbGFibGUgYm9vc3RzIChQcmVtaXVtOiAxL21vbnRoLCBQcmVtaXVtKzogMi9tb250aCkKICAgIGNvbnN0IGN1cnJlbnRNb250aCA9IG5ldyBEYXRlKG5vdykuZ2V0VVRDTW9udGgoKTsKICAgIGNvbnN0IGN1cnJlbnRZZWFyID0gbmV3IERhdGUobm93KS5nZXRVVENGdWxsWWVhcigpOwogICAgCiAgICBjb25zdCBib29zdHNUaGlzTW9udGggPSBhd2FpdCBjdHguZGIKICAgICAgLnF1ZXJ5KCJib29zdHMiKQogICAgICAud2l0aEluZGV4KCJ1c2VySWQiLCAocSkgPT4gcS5lcSgidXNlcklkIiwgYXJncy51c2VySWQpKQogICAgICAuY29sbGVjdCgpOwoKICAgIGNvbnN0IG1vbnRobHlCb29zdHMgPSBib29zdHNUaGlzTW9udGguZmlsdGVyKChiKSA9PiB7CiAgICAgIGNvbnN0IGJvb3N0RGF0ZSA9IG5ldyBEYXRlKGIuYWN0aXZhdGVkQXQpOwogICAgICByZXR1cm4gKAogICAgICAgIGJvb3N0RGF0ZS5nZXRVVENNb250aCgpID09PSBjdXJyZW50TW9udGggJiYKICAgICAgICBib29zdERhdGUuZ2V0VVRDRnVsbFllYXIoKSA9PT0gY3VycmVudFllYXIKICAgICAgKTsKICAgIH0pOwoKICAgIC8vIFByZW1pdW06IDEvbW9udGgsIFByZW1pdW0gUGx1cyAodmlhIGRhaWx5IGFkZC1vbik6IDIvbW9udGgKICAgIGNvbnN0IGFjdGl2ZUFkZG9uID0gYXdhaXQgY3R4LmRiCiAgICAgIC5xdWVyeSgicHJlbWl1bUFkZG9ucyIpCiAgICAgIC53aXRoSW5kZXgoInVzZXJTdGF0dXMiLCAocTogYW55KSA9PiBxLmVxKCJ1c2VySWQiLCBhcmdzLnVzZXJJZCkuZXEoInN0YXR1cyIsICJhY3RpdmUiKSkKICAgICAgLm9yZGVyKCJkZXNjIikKICAgICAgLmZpcnN0KCk7CiAgICBjb25zdCBoYXNBY3RpdmVBZGRvbiA9ICEhYWN0aXZlQWRkb24gJiYgKGFjdGl2ZUFkZG9uLmVuZHNBdCA/PyAwKSA+IG5vdyAmJiBhY3RpdmVBZGRvbi5hZGRvblR5cGUgPT09ICJwcmVtaXVtX3BsdXMiOwogICAgY29uc3QgbW9udGhseUxpbWl0ID0gaGFzQWN0aXZlQWRkb24gPyAyIDogMTsKCiAgICBjb25zdCBhdmFpbGFibGVCb29zdHMgPSBwcmVtaXVtID8gTWF0aC5tYXgoMCwgbW9udGhseUxpbWl0IC0gbW9udGhseUJvb3N0cy5sZW5ndGgpIDogMDsKCiAgICByZXR1cm4gewogICAgICBpc0FjdGl2ZSwKICAgICAgZW5kc0F0OiBpc0FjdGl2ZSAmJiBhY3RpdmVCb29zdCA/IGFjdGl2ZUJvb3N0LmV4cGlyZXNBdCA6IG51bGwsCiAgICAgIGF2YWlsYWJsZUJvb3N0cywKICAgICAgY3VycmVudEJvb3N0OiBhY3RpdmVCb29zdCB8fCBudWxsLAogICAgfTsKICB9LAp9KTsKCmV4cG9ydCBjb25zdCBleHBpcmVCb29zdHMgPSBtdXRhdGlvbih7CiAgYXJnczoge30sCiAgaGFuZGxlcjogYXN5bmMgKGN0eCkgPT4gewogICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsKICAgIAogICAgLy8gRmluZCBhbGwgYWN0aXZlIGJvb3N0cyB0aGF0IGhhdmUgZXhwaXJlZAogICAgY29uc3QgZXhwaXJlZEJvb3N0cyA9IGF3YWl0IGN0eC5kYgogICAgICAucXVlcnkoImJvb3N0cyIpCiAgICAgIC5maWx0ZXIoKHEpID0+IAogICAgICAgIHEuYW5kKAogICAgICAgICAgcS5lcShxLmZpZWxkKCJzdGF0dXMiKSwgImFjdGl2ZSIpLAogICAgICAgICAgcS5sdChxLmZpZWxkKCJleHBpcmVzQXQiKSwgbm93KQogICAgICAgICkKICAgICAgKQogICAgICAuY29sbGVjdCgpOwoKICAgIC8vIFVwZGF0ZSBlYWNoIGV4cGlyZWQgYm9vc3QgYW5kIHJlc2V0IHByb2ZpbGUgdmlzaWJpbGl0eQogICAgZm9yIChjb25zdCBib29zdCBvZiBleHBpcmVkQm9vc3RzKSB7CiAgICAgIGF3YWl0IGN0eC5kYi5wYXRjaChib29zdC5faWQsIHsgc3RhdHVzOiAiZXhwaXJlZCIgfSk7CgogICAgICBjb25zdCBwcm9maWxlID0gYXdhaXQgY3R4LmRiCiAgICAgICAgLnF1ZXJ5KCJwcm9maWxlcyIpCiAgICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIGJvb3N0LnVzZXJJZCkpCiAgICAgICAgLmZpcnN0KCk7CgogICAgICBpZiAocHJvZmlsZSAmJiBwcm9maWxlLmJvb3N0RW5kc0F0ICYmIHByb2ZpbGUuYm9vc3RFbmRzQXQgPD0gbm93KSB7CiAgICAgICAgYXdhaXQgY3R4LmRiLnBhdGNoKHByb2ZpbGUuX2lkLCB7CiAgICAgICAgICBib29zdEVuZHNBdDogdW5kZWZpbmVkLAogICAgICAgICAgdmlzaWJpbGl0eVNjb3JlOiBNYXRoLmZsb29yKChwcm9maWxlLnZpc2liaWxpdHlTY29yZSB8fCAxMDAwKSAvIDEwKSwgLy8gUmVzZXQgdmlzaWJpbGl0eQogICAgICAgIH0pOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHsgZXhwaXJlZENvdW50OiBleHBpcmVkQm9vc3RzLmxlbmd0aCB9OwogIH0sCn0pOwo="}