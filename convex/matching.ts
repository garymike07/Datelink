{"data":"aW1wb3J0IHsgdiB9IGZyb20gImNvbnZleC92YWx1ZXMiOwppbXBvcnQgeyBtdXRhdGlvbiwgcXVlcnkgfSBmcm9tICIuL19nZW5lcmF0ZWQvc2VydmVyIjsKaW1wb3J0IHsgY29uc3VtZUxpa2UsIGNvbnN1bWVTdXBlckxpa2UsIGlzVXNlclByZW1pdW0gfSBmcm9tICIuL3N1YnNjcmlwdGlvbnMiOwppbXBvcnQgeyBpbnNlcnROb3RpZmljYXRpb24gfSBmcm9tICIuL25vdGlmaWNhdGlvbnMiOwoKZnVuY3Rpb24gaGF2ZXJzaW5lS20oYUxhdDogbnVtYmVyLCBhTG9uOiBudW1iZXIsIGJMYXQ6IG51bWJlciwgYkxvbjogbnVtYmVyKTogbnVtYmVyIHsKICAgIGNvbnN0IHRvUmFkID0gKGQ6IG51bWJlcikgPT4gKGQgKiBNYXRoLlBJKSAvIDE4MDsKICAgIGNvbnN0IFIgPSA2MzcxOwogICAgY29uc3QgZExhdCA9IHRvUmFkKGJMYXQgLSBhTGF0KTsKICAgIGNvbnN0IGRMb24gPSB0b1JhZChiTG9uIC0gYUxvbik7CiAgICBjb25zdCBzTGF0ID0gdG9SYWQoYUxhdCk7CiAgICBjb25zdCBlTGF0ID0gdG9SYWQoYkxhdCk7CiAgICBjb25zdCBoID0KICAgICAgICBNYXRoLnNpbihkTGF0IC8gMikgKiBNYXRoLnNpbihkTGF0IC8gMikgKwogICAgICAgIE1hdGguY29zKHNMYXQpICogTWF0aC5jb3MoZUxhdCkgKiBNYXRoLnNpbihkTG9uIC8gMikgKiBNYXRoLnNpbihkTG9uIC8gMik7CiAgICByZXR1cm4gMiAqIFIgKiBNYXRoLmFzaW4oTWF0aC5zcXJ0KGgpKTsKfQoKZnVuY3Rpb24gZ2V0RWZmZWN0aXZlTG9jYXRpb24ocHJvZmlsZTogYW55KTogeyBsYXQ/OiBudW1iZXI7IGxvbj86IG51bWJlcjsgY2l0eT86IHN0cmluZzsgaXNQYXNzcG9ydDogYm9vbGVhbiB9IHsKICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7CiAgICBjb25zdCBwYXNzcG9ydEFjdGl2ZSA9CiAgICAgICAgcHJvZmlsZS5wYXNzcG9ydExhdCAhPT0gdW5kZWZpbmVkICYmCiAgICAgICAgcHJvZmlsZS5wYXNzcG9ydExvbiAhPT0gdW5kZWZpbmVkICYmCiAgICAgICAgcHJvZmlsZS5wYXNzcG9ydEV4cGlyZXNBdCAhPT0gdW5kZWZpbmVkICYmCiAgICAgICAgcHJvZmlsZS5wYXNzcG9ydEV4cGlyZXNBdCA+IG5vdzsKCiAgICBpZiAocGFzc3BvcnRBY3RpdmUpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBsYXQ6IHByb2ZpbGUucGFzc3BvcnRMYXQsCiAgICAgICAgICAgIGxvbjogcHJvZmlsZS5wYXNzcG9ydExvbiwKICAgICAgICAgICAgY2l0eTogcHJvZmlsZS5wYXNzcG9ydENpdHkgfHwgcHJvZmlsZS5sb2NhdGlvbiwKICAgICAgICAgICAgaXNQYXNzcG9ydDogdHJ1ZSwKICAgICAgICB9OwogICAgfQoKICAgIHJldHVybiB7CiAgICAgICAgbGF0OiBwcm9maWxlLmxhdGl0dWRlLAogICAgICAgIGxvbjogcHJvZmlsZS5sb25naXR1ZGUsCiAgICAgICAgY2l0eTogcHJvZmlsZS5sb2NhdGlvbiwKICAgICAgICBpc1Bhc3Nwb3J0OiBmYWxzZSwKICAgIH07Cn0KCmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZVBob3RvQW5hbHl0aWNzKAogICAgY3R4OiBhbnksCiAgICBwaG90b0lkOiBhbnksCiAgICBvd25lclVzZXJJZDogYW55LAogICAgYWN0aW9uOiAiaW1wcmVzc2lvbiIgfCAibGlrZSIgfCAicGFzcyIKKSB7CiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpOwogICAgY29uc3QgZXhpc3RpbmcgPSBhd2FpdCBjdHguZGIKICAgICAgICAucXVlcnkoInBob3RvQW5hbHl0aWNzIikKICAgICAgICAud2l0aEluZGV4KCJwaG90b0lkIiwgKHE6IGFueSkgPT4gcS5lcSgicGhvdG9JZCIsIHBob3RvSWQpKQogICAgICAgIC5maXJzdCgpOwoKICAgIGNvbnN0IGluYyA9IHsKICAgICAgICBpbXByZXNzaW9uczogYWN0aW9uID09PSAiaW1wcmVzc2lvbiIgPyAxIDogMCwKICAgICAgICBsaWtlczogYWN0aW9uID09PSAibGlrZSIgPyAxIDogMCwKICAgICAgICBwYXNzZXM6IGFjdGlvbiA9PT0gInBhc3MiID8gMSA6IDAsCiAgICB9OwoKICAgIGlmICghZXhpc3RpbmcpIHsKICAgICAgICBjb25zdCBpbXByZXNzaW9ucyA9IGluYy5pbXByZXNzaW9uczsKICAgICAgICBjb25zdCBsaWtlcyA9IGluYy5saWtlczsKICAgICAgICBjb25zdCBwYXNzZXMgPSBpbmMucGFzc2VzOwogICAgICAgIGNvbnN0IGxpa2VSYXRlID0gaW1wcmVzc2lvbnMgPiAwID8gbGlrZXMgLyBpbXByZXNzaW9ucyA6IDA7CiAgICAgICAgYXdhaXQgY3R4LmRiLmluc2VydCgicGhvdG9BbmFseXRpY3MiLCB7CiAgICAgICAgICAgIHBob3RvSWQsCiAgICAgICAgICAgIHVzZXJJZDogb3duZXJVc2VySWQsCiAgICAgICAgICAgIGltcHJlc3Npb25zLAogICAgICAgICAgICBsaWtlcywKICAgICAgICAgICAgcGFzc2VzLAogICAgICAgICAgICBsaWtlUmF0ZSwKICAgICAgICAgICAgY3JlYXRlZEF0OiBub3csCiAgICAgICAgICAgIHVwZGF0ZWRBdDogbm93LAogICAgICAgIH0pOwogICAgICAgIHJldHVybjsKICAgIH0KCiAgICBjb25zdCBpbXByZXNzaW9ucyA9IGV4aXN0aW5nLmltcHJlc3Npb25zICsgaW5jLmltcHJlc3Npb25zOwogICAgY29uc3QgbGlrZXMgPSBleGlzdGluZy5saWtlcyArIGluYy5saWtlczsKICAgIGNvbnN0IHBhc3NlcyA9IGV4aXN0aW5nLnBhc3NlcyArIGluYy5wYXNzZXM7CiAgICBjb25zdCBsaWtlUmF0ZSA9IGltcHJlc3Npb25zID4gMCA/IGxpa2VzIC8gaW1wcmVzc2lvbnMgOiAwOwogICAgYXdhaXQgY3R4LmRiLnBhdGNoKGV4aXN0aW5nLl9pZCwgewogICAgICAgIGltcHJlc3Npb25zLAogICAgICAgIGxpa2VzLAogICAgICAgIHBhc3NlcywKICAgICAgICBsaWtlUmF0ZSwKICAgICAgICB1cGRhdGVkQXQ6IG5vdywKICAgIH0pOwp9Cgphc3luYyBmdW5jdGlvbiB1cGRhdGVFbG9Pbk1hdGNoKGN0eDogYW55LCB1c2VyQUlkOiBhbnksIHVzZXJCSWQ6IGFueSkgewogICAgY29uc3QgYSA9IGF3YWl0IGN0eC5kYi5xdWVyeSgicHJvZmlsZXMiKS53aXRoSW5kZXgoInVzZXJJZCIsIChxOiBhbnkpID0+IHEuZXEoInVzZXJJZCIsIHVzZXJBSWQpKS5maXJzdCgpOwogICAgY29uc3QgYiA9IGF3YWl0IGN0eC5kYi5xdWVyeSgicHJvZmlsZXMiKS53aXRoSW5kZXgoInVzZXJJZCIsIChxOiBhbnkpID0+IHEuZXEoInVzZXJJZCIsIHVzZXJCSWQpKS5maXJzdCgpOwogICAgaWYgKCFhIHx8ICFiKSByZXR1cm47CgogICAgY29uc3QgYUVsbyA9IGEuZWxvID8/IDE1MDA7CiAgICBjb25zdCBiRWxvID0gYi5lbG8gPz8gMTUwMDsKICAgIGNvbnN0IGV4cGVjdGVkQSA9IDEgLyAoMSArIE1hdGgucG93KDEwLCAoYkVsbyAtIGFFbG8pIC8gNDAwKSk7CiAgICBjb25zdCBleHBlY3RlZEIgPSAxIC0gZXhwZWN0ZWRBOwogICAgY29uc3QgSyA9IDE2OwogICAgY29uc3QgbmV3QUVsbyA9IE1hdGgucm91bmQoYUVsbyArIEsgKiAoMSAtIGV4cGVjdGVkQSkpOwogICAgY29uc3QgbmV3QkVsbyA9IE1hdGgucm91bmQoYkVsbyArIEsgKiAoMSAtIGV4cGVjdGVkQikpOwoKICAgIGF3YWl0IGN0eC5kYi5wYXRjaChhLl9pZCwgeyBlbG86IE1hdGgubWF4KDEwMCwgTWF0aC5taW4oMzAwMCwgbmV3QUVsbykpIH0pOwogICAgYXdhaXQgY3R4LmRiLnBhdGNoKGIuX2lkLCB7IGVsbzogTWF0aC5tYXgoMTAwLCBNYXRoLm1pbigzMDAwLCBuZXdCRWxvKSkgfSk7Cn0KCi8vIEhlbHBlciBmdW5jdGlvbiB0byBjYWxjdWxhdGUgbWF0Y2ggc2NvcmUKZnVuY3Rpb24gY2FsY3VsYXRlTWF0Y2hTY29yZSgKICAgIG15UHJvZmlsZTogYW55LAogICAgbXlJbnRlcmVzdHM6IHN0cmluZ1tdLAogICAgY2FuZGlkYXRlUHJvZmlsZTogYW55LAogICAgY2FuZGlkYXRlSW50ZXJlc3RzOiBzdHJpbmdbXSwKICAgIGNhbmRpZGF0ZUFjdGl2aXR5OiBudW1iZXIKKTogbnVtYmVyIHsKICAgIGxldCBzY29yZSA9IDA7CgogICAgLy8gMS4gTXV0dWFsIGludGVyZXN0cyAoNDAlKQogICAgY29uc3QgY29tbW9uSW50ZXJlc3RzID0gbXlJbnRlcmVzdHMuZmlsdGVyKGkgPT4gY2FuZGlkYXRlSW50ZXJlc3RzLmluY2x1ZGVzKGkpKTsKICAgIGNvbnN0IGludGVyZXN0U2NvcmUgPSBjb21tb25JbnRlcmVzdHMubGVuZ3RoIC8gTWF0aC5tYXgobXlJbnRlcmVzdHMubGVuZ3RoLCAxKTsKICAgIHNjb3JlICs9IGludGVyZXN0U2NvcmUgKiA0MDsKCiAgICAvLyAyLiBEaXN0YW5jZSBwcm94aW1pdHkgKDMwJSkgLSBmb3Igbm93LCBzYW1lIGxvY2F0aW9uIGdldHMgZnVsbCBzY29yZQogICAgaWYgKG15UHJvZmlsZS5sb2NhdGlvbiA9PT0gY2FuZGlkYXRlUHJvZmlsZS5sb2NhdGlvbikgewogICAgICAgIHNjb3JlICs9IDMwOwogICAgfSBlbHNlIHsKICAgICAgICBzY29yZSArPSAxNTsgLy8gRGlmZmVyZW50IGxvY2F0aW9uIGdldHMgaGFsZgogICAgfQoKICAgIC8vIDMuIFByb2ZpbGUgY29tcGxldGVuZXNzICgxNSUpCiAgICBjb25zdCBjb21wbGV0ZW5lc3NTY29yZSA9IChjYW5kaWRhdGVQcm9maWxlLmNvbXBsZXRlbmVzcyB8fCAwKSAvIDEwMDsKICAgIHNjb3JlICs9IGNvbXBsZXRlbmVzc1Njb3JlICogMTU7CgogICAgLy8gNC4gUmVjZW50IGFjdGl2aXR5ICgxMCUpIC0gYWN0aXZlIGluIGxhc3QgNyBkYXlzCiAgICBjb25zdCBzZXZlbkRheXNBZ28gPSBEYXRlLm5vdygpIC0gNyAqIDI0ICogNjAgKiA2MCAqIDEwMDA7CiAgICBpZiAoY2FuZGlkYXRlQWN0aXZpdHkgPiBzZXZlbkRheXNBZ28pIHsKICAgICAgICBzY29yZSArPSAxMDsKICAgIH0gZWxzZSBpZiAoY2FuZGlkYXRlQWN0aXZpdHkgPiBzZXZlbkRheXNBZ28gLSA3ICogMjQgKiA2MCAqIDYwICogMTAwMCkgewogICAgICAgIHNjb3JlICs9IDU7IC8vIEFjdGl2ZSBpbiBsYXN0IDE0IGRheXMKICAgIH0KCiAgICAvLyA1LiBQaG90byBxdWFsaXR5IHNjb3JlICg1JSkgLSBtb3JlIHBob3RvcyA9IGhpZ2hlciBzY29yZQogICAgY29uc3QgcGhvdG9TY29yZSA9IE1hdGgubWluKGNhbmRpZGF0ZVByb2ZpbGUucGhvdG9zPy5sZW5ndGggfHwgMCwgNikgLyA2OwogICAgc2NvcmUgKz0gcGhvdG9TY29yZSAqIDU7CgogICAgcmV0dXJuIHNjb3JlOwp9CgovLyBHZXQgcHJvZmlsZXMgZm9yIGRpc2NvdmVyeS9zd2lwZSBpbnRlcmZhY2Ugd2l0aCBzbWFydCByYW5raW5nCmV4cG9ydCBjb25zdCBnZXREaXNjb3ZlcnlQcm9maWxlcyA9IHF1ZXJ5KHsKICAgIGFyZ3M6IHsKICAgICAgICB1c2VySWQ6IHYuaWQoInVzZXJzIiksCiAgICAgICAgbGltaXQ6IHYub3B0aW9uYWwodi5udW1iZXIoKSksCiAgICB9LAogICAgaGFuZGxlcjogYXN5bmMgKGN0eCwgYXJncykgPT4gewogICAgICAgIGNvbnN0IGxpbWl0ID0gYXJncy5saW1pdCB8fCAxMDsKCiAgICAgICAgY29uc3QgcHJlZmVyZW5jZXMgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgLnF1ZXJ5KCJwcmVmZXJlbmNlcyIpCiAgICAgICAgICAgIC53aXRoSW5kZXgoInVzZXJJZCIsIChxKSA9PiBxLmVxKCJ1c2VySWQiLCBhcmdzLnVzZXJJZCkpCiAgICAgICAgICAgIC5maXJzdCgpOwoKICAgICAgICAvLyBHZXQgdXNlcidzIHByb2ZpbGUgKHJlcXVpcmVkIHRvIGV4Y2x1ZGUgc2VsZikKICAgICAgICBjb25zdCBteVByb2ZpbGUgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgLnF1ZXJ5KCJwcm9maWxlcyIpCiAgICAgICAgICAgIC53aXRoSW5kZXgoInVzZXJJZCIsIChxKSA9PiBxLmVxKCJ1c2VySWQiLCBhcmdzLnVzZXJJZCkpCiAgICAgICAgICAgIC5maXJzdCgpOwoKICAgICAgICBpZiAoIW15UHJvZmlsZSkgewogICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgfQoKICAgICAgICAvLyBHZXQgbXkgaW50ZXJlc3RzCiAgICAgICAgY29uc3QgbXlJbnRlcmVzdHMgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgLnF1ZXJ5KCJpbnRlcmVzdHMiKQogICAgICAgICAgICAud2l0aEluZGV4KCJ1c2VySWQiLCAocSkgPT4gcS5lcSgidXNlcklkIiwgYXJncy51c2VySWQpKQogICAgICAgICAgICAuY29sbGVjdCgpOwogICAgICAgIGNvbnN0IG15SW50ZXJlc3RzTGlzdCA9IG15SW50ZXJlc3RzLm1hcCgoaSkgPT4gaS5pbnRlcmVzdCk7CgogICAgICAgIC8vIEdldCB1c2VycyBJJ3ZlIGFscmVhZHkgbGlrZWQKICAgICAgICBjb25zdCBteUxpa2VzID0gYXdhaXQgY3R4LmRiCiAgICAgICAgICAgIC5xdWVyeSgibGlrZXMiKQogICAgICAgICAgICAud2l0aEluZGV4KCJ1c2VySWQiLCAocSkgPT4gcS5lcSgidXNlcklkIiwgYXJncy51c2VySWQpKQogICAgICAgICAgICAuY29sbGVjdCgpOwogICAgICAgIGNvbnN0IGxpa2VkVXNlcklkcyA9IG5ldyBTZXQobXlMaWtlcy5tYXAoKGwpID0+IGwubGlrZWRVc2VySWQpKTsKCiAgICAgICAgLy8gR2V0IHVzZXJzIEkndmUgcGFzc2VkIChvbmx5IHJlY2VudCAtIGxhc3QgNyBkYXlzKQogICAgICAgIGNvbnN0IHNldmVuRGF5c0FnbyA9IERhdGUubm93KCkgLSA3ICogMjQgKiA2MCAqIDYwICogMTAwMDsKICAgICAgICBjb25zdCBteVBhc3NlcyA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAucXVlcnkoInBhc3NlcyIpCiAgICAgICAgICAgIC53aXRoSW5kZXgoInVzZXJJZCIsIChxKSA9PiBxLmVxKCJ1c2VySWQiLCBhcmdzLnVzZXJJZCkpCiAgICAgICAgICAgIC5jb2xsZWN0KCk7CiAgICAgICAgY29uc3QgcGFzc2VkVXNlcklkcyA9IG5ldyBTZXQoCiAgICAgICAgICAgIG15UGFzc2VzCiAgICAgICAgICAgICAgICAuZmlsdGVyKHAgPT4gcC5jcmVhdGVkQXQgPiBzZXZlbkRheXNBZ28pCiAgICAgICAgICAgICAgICAubWFwKChwKSA9PiBwLnBhc3NlZFVzZXJJZCkKICAgICAgICApOwoKICAgICAgICAvLyBHZXQgdXNlcnMgSSd2ZSBibG9ja2VkIG9yIHdobyBibG9ja2VkIG1lCiAgICAgICAgY29uc3QgbXlCbG9ja3MgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgLnF1ZXJ5KCJibG9ja3MiKQogICAgICAgICAgICAud2l0aEluZGV4KCJibG9ja2VySWQiLCAocSkgPT4gcS5lcSgiYmxvY2tlcklkIiwgYXJncy51c2VySWQpKQogICAgICAgICAgICAuY29sbGVjdCgpOwogICAgICAgIGNvbnN0IGJsb2NrZWRCeU1lID0gbmV3IFNldChteUJsb2Nrcy5tYXAoKGIpID0+IGIuYmxvY2tlZFVzZXJJZCkpOwoKICAgICAgICBjb25zdCBibG9ja3NPbk1lID0gYXdhaXQgY3R4LmRiCiAgICAgICAgICAgIC5xdWVyeSgiYmxvY2tzIikKICAgICAgICAgICAgLndpdGhJbmRleCgiYmxvY2tlZFVzZXJJZCIsIChxKSA9PiBxLmVxKCJibG9ja2VkVXNlcklkIiwgYXJncy51c2VySWQpKQogICAgICAgICAgICAuY29sbGVjdCgpOwogICAgICAgIGNvbnN0IGJsb2NrZWRNZSA9IG5ldyBTZXQoYmxvY2tzT25NZS5tYXAoKGIpID0+IGIuYmxvY2tlcklkKSk7CgogICAgICAgIGNvbnN0IG15TG9jID0gZ2V0RWZmZWN0aXZlTG9jYXRpb24obXlQcm9maWxlKTsKCiAgICAgICAgLy8gU2hvdyBhbGwgb3RoZXIgcmVnaXN0ZXJlZCBwcm9maWxlcyB0byBhbGxvdyBzd2lwZSB3b3JrZmxvdyBhY3Jvc3MgYWxsIHVzZXJzLgogICAgICAgIGNvbnN0IGFsbFByb2ZpbGVzID0gYXdhaXQgY3R4LmRiLnF1ZXJ5KCJwcm9maWxlcyIpLmNvbGxlY3QoKTsKCiAgICAgICAgY29uc3QgY2FuZGlkYXRlcyA9IFtdOwogICAgICAgIGZvciAoY29uc3QgcHJvZmlsZSBvZiBhbGxQcm9maWxlcykgewogICAgICAgICAgICBpZiAocHJvZmlsZS51c2VySWQgPT09IGFyZ3MudXNlcklkKSBjb250aW51ZTsKICAgICAgICAgICAgaWYgKGxpa2VkVXNlcklkcy5oYXMocHJvZmlsZS51c2VySWQpKSBjb250aW51ZTsKICAgICAgICAgICAgaWYgKHBhc3NlZFVzZXJJZHMuaGFzKHByb2ZpbGUudXNlcklkKSkgY29udGludWU7CiAgICAgICAgICAgIGlmIChibG9ja2VkQnlNZS5oYXMocHJvZmlsZS51c2VySWQpKSBjb250aW51ZTsKICAgICAgICAgICAgaWYgKGJsb2NrZWRNZS5oYXMocHJvZmlsZS51c2VySWQpKSBjb250aW51ZTsKCiAgICAgICAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBjdHguZGIuZ2V0KHByb2ZpbGUudXNlcklkKTsKCiAgICAgICAgICAgIGNvbnN0IHBob3RvcyA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAgICAgLnF1ZXJ5KCJwaG90b3MiKQogICAgICAgICAgICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIHByb2ZpbGUudXNlcklkKSkKICAgICAgICAgICAgICAgIC5jb2xsZWN0KCk7CgogICAgICAgICAgICAvLyBQcmVmZXJlbmNlcyBhcmUgaW50ZW50aW9uYWxseSBub3QgYXBwbGllZCBmb3IgdGhlIG1haW4gZGlzY292ZXJ5IGZlZWQKICAgICAgICAgICAgLy8gc28gdXNlcnMgY2FuIGJyb3dzZSBhbGwgcmVnaXN0ZXJlZCBwcm9maWxlcy4KCiAgICAgICAgICAgIGNvbnN0IGludGVyZXN0cyA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAgICAgLnF1ZXJ5KCJpbnRlcmVzdHMiKQogICAgICAgICAgICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIHByb2ZpbGUudXNlcklkKSkKICAgICAgICAgICAgICAgIC5jb2xsZWN0KCk7CgogICAgICAgICAgICBjb25zdCBjYW5kaWRhdGVJc1ByZW1pdW0gPSBhd2FpdCBpc1VzZXJQcmVtaXVtKGN0eCwgcHJvZmlsZS51c2VySWQpOwogICAgICAgICAgICBjb25zdCBjYW5kaWRhdGVJbnRlcmVzdHMgPSBpbnRlcmVzdHMubWFwKChpKSA9PiBpLmludGVyZXN0KTsKCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBtYXRjaCBzY29yZQogICAgICAgICAgICBjb25zdCBzY29yZSA9IGNhbGN1bGF0ZU1hdGNoU2NvcmUoCiAgICAgICAgICAgICAgICBteVByb2ZpbGUsCiAgICAgICAgICAgICAgICBteUludGVyZXN0c0xpc3QsCiAgICAgICAgICAgICAgICB7IC4uLnByb2ZpbGUsIHBob3RvcyB9LAogICAgICAgICAgICAgICAgY2FuZGlkYXRlSW50ZXJlc3RzLAogICAgICAgICAgICAgICAgdXNlcj8ubGFzdFNlZW5BdCB8fCAwCiAgICAgICAgICAgICk7CgogICAgICAgICAgICBjYW5kaWRhdGVzLnB1c2goewogICAgICAgICAgICAgICAgLi4ucHJvZmlsZSwKICAgICAgICAgICAgICAgIG5hbWU6IHVzZXI/Lm5hbWUsCiAgICAgICAgICAgICAgICBwaG90b3M6IHBob3Rvcy5zb3J0KChhLCBiKSA9PiBhLm9yZGVyIC0gYi5vcmRlciksCiAgICAgICAgICAgICAgICBpbnRlcmVzdHM6IGNhbmRpZGF0ZUludGVyZXN0cywKICAgICAgICAgICAgICAgIGlzUHJlbWl1bTogY2FuZGlkYXRlSXNQcmVtaXVtLAogICAgICAgICAgICAgICAgbWF0Y2hTY29yZTogc2NvcmUsCiAgICAgICAgICAgICAgICBkaXN0YW5jZUttOgogICAgICAgICAgICAgICAgICAgIG15TG9jLmxhdCAhPT0gdW5kZWZpbmVkICYmIG15TG9jLmxvbiAhPT0gdW5kZWZpbmVkICYmIHByb2ZpbGUubGF0aXR1ZGUgIT09IHVuZGVmaW5lZCAmJiBwcm9maWxlLmxvbmdpdHVkZSAhPT0gdW5kZWZpbmVkCiAgICAgICAgICAgICAgICAgICAgICAgID8gaGF2ZXJzaW5lS20obXlMb2MubGF0LCBteUxvYy5sb24sIHByb2ZpbGUubGF0aXR1ZGUsIHByb2ZpbGUubG9uZ2l0dWRlKQogICAgICAgICAgICAgICAgICAgICAgICA6IG51bGwsCiAgICAgICAgICAgICAgICBkaXN0YW5jZUNpdHk6IHByb2ZpbGUubG9jYXRpb24sCiAgICAgICAgICAgICAgICBwYXNzcG9ydE1vZGU6IG15TG9jLmlzUGFzc3BvcnQsCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gU29ydCBieSBtYXRjaCBzY29yZSAoaGlnaGVzdCBmaXJzdCkKICAgICAgICBjYW5kaWRhdGVzLnNvcnQoKGEsIGIpID0+IGIubWF0Y2hTY29yZSAtIGEubWF0Y2hTY29yZSk7CgogICAgICAgIC8vIFJldHVybiB0b3AgbWF0Y2hlcyB1cCB0byBsaW1pdAogICAgICAgIHJldHVybiBjYW5kaWRhdGVzLnNsaWNlKDAsIGxpbWl0KTsKICAgIH0sCn0pOwoKLy8gUGhhc2UgNDogRGlzY292ZXJ5IHF1ZXJ5IHdpdGggZXhwbGljaXQgYWR2YW5jZWQgZmlsdGVycyAocHJlbWl1bSkKZXhwb3J0IGNvbnN0IGdldEZpbHRlcmVkRGlzY292ZXJ5UHJvZmlsZXMgPSBxdWVyeSh7CiAgICBhcmdzOiB7CiAgICAgICAgdXNlcklkOiB2LmlkKCJ1c2VycyIpLAogICAgICAgIGZpbHRlcnM6IHYub3B0aW9uYWwoCiAgICAgICAgICAgIHYub2JqZWN0KHsKICAgICAgICAgICAgICAgIGFnZU1pbjogdi5vcHRpb25hbCh2Lm51bWJlcigpKSwKICAgICAgICAgICAgICAgIGFnZU1heDogdi5vcHRpb25hbCh2Lm51bWJlcigpKSwKICAgICAgICAgICAgICAgIGRpc3RhbmNlTWF4OiB2Lm9wdGlvbmFsKHYubnVtYmVyKCkpLAogICAgICAgICAgICAgICAgaGVpZ2h0TWluOiB2Lm9wdGlvbmFsKHYubnVtYmVyKCkpLAogICAgICAgICAgICAgICAgaGVpZ2h0TWF4OiB2Lm9wdGlvbmFsKHYubnVtYmVyKCkpLAogICAgICAgICAgICAgICAgZWR1Y2F0aW9uOiB2Lm9wdGlvbmFsKHYuYXJyYXkodi5zdHJpbmcoKSkpLAogICAgICAgICAgICAgICAgZHJpbmtpbmc6IHYub3B0aW9uYWwodi5hcnJheSh2LnN0cmluZygpKSksCiAgICAgICAgICAgICAgICBzbW9raW5nOiB2Lm9wdGlvbmFsKHYuYXJyYXkodi5zdHJpbmcoKSkpLAogICAgICAgICAgICAgICAgcmVsYXRpb25zaGlwR29hbDogdi5vcHRpb25hbCh2LmFycmF5KHYuc3RyaW5nKCkpKSwKICAgICAgICAgICAgICAgIGhhc0NoaWxkcmVuOiB2Lm9wdGlvbmFsKHYuYm9vbGVhbigpKSwKICAgICAgICAgICAgICAgIHdhbnRzQ2hpbGRyZW46IHYub3B0aW9uYWwodi5ib29sZWFuKCkpLAogICAgICAgICAgICAgICAgcmVsaWdpb246IHYub3B0aW9uYWwodi5hcnJheSh2LnN0cmluZygpKSksCiAgICAgICAgICAgICAgICBtdXN0QmVWZXJpZmllZDogdi5vcHRpb25hbCh2LmJvb2xlYW4oKSksCiAgICAgICAgICAgIH0pCiAgICAgICAgKSwKICAgICAgICBsaW1pdDogdi5vcHRpb25hbCh2Lm51bWJlcigpKSwKICAgIH0sCiAgICBoYW5kbGVyOiBhc3luYyAoY3R4LCBhcmdzKSA9PiB7CiAgICAgICAgY29uc3QgcHJlbWl1bSA9IGF3YWl0IGlzVXNlclByZW1pdW0oY3R4LCBhcmdzLnVzZXJJZCk7CiAgICAgICAgaWYgKGFyZ3MuZmlsdGVycyAmJiAhcHJlbWl1bSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlByZW1pdW0gcmVxdWlyZWQgZm9yIGFkdmFuY2VkIGZpbHRlcnMiKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IGxpbWl0ID0gYXJncy5saW1pdCB8fCAxMDsKCiAgICAgICAgLy8gQmFzZSBwcmVmZXJlbmNlcyAoZ2VuZGVyIHByZWZzIGV0Yy4pCiAgICAgICAgY29uc3QgYmFzZVByZWZlcmVuY2VzID0gYXdhaXQgY3R4LmRiCiAgICAgICAgICAgIC5xdWVyeSgicHJlZmVyZW5jZXMiKQogICAgICAgICAgICAud2l0aEluZGV4KCJ1c2VySWQiLCAocSkgPT4gcS5lcSgidXNlcklkIiwgYXJncy51c2VySWQpKQogICAgICAgICAgICAuZmlyc3QoKTsKCiAgICAgICAgY29uc3QgcHJlZmVyZW5jZXM6IGFueSA9IHsgLi4uKGJhc2VQcmVmZXJlbmNlcyB8fCB7fSkgfTsKICAgICAgICBpZiAoYXJncy5maWx0ZXJzKSB7CiAgICAgICAgICAgIGlmIChhcmdzLmZpbHRlcnMuYWdlTWluICE9PSB1bmRlZmluZWQpIHByZWZlcmVuY2VzLm1pbkFnZSA9IGFyZ3MuZmlsdGVycy5hZ2VNaW47CiAgICAgICAgICAgIGlmIChhcmdzLmZpbHRlcnMuYWdlTWF4ICE9PSB1bmRlZmluZWQpIHByZWZlcmVuY2VzLm1heEFnZSA9IGFyZ3MuZmlsdGVycy5hZ2VNYXg7CiAgICAgICAgICAgIGlmIChhcmdzLmZpbHRlcnMuZGlzdGFuY2VNYXggIT09IHVuZGVmaW5lZCkgcHJlZmVyZW5jZXMubWF4RGlzdGFuY2UgPSBhcmdzLmZpbHRlcnMuZGlzdGFuY2VNYXg7CiAgICAgICAgICAgIGlmIChhcmdzLmZpbHRlcnMuaGVpZ2h0TWluICE9PSB1bmRlZmluZWQpIHByZWZlcmVuY2VzLm1pbkhlaWdodCA9IGFyZ3MuZmlsdGVycy5oZWlnaHRNaW47CiAgICAgICAgICAgIGlmIChhcmdzLmZpbHRlcnMuaGVpZ2h0TWF4ICE9PSB1bmRlZmluZWQpIHByZWZlcmVuY2VzLm1heEhlaWdodCA9IGFyZ3MuZmlsdGVycy5oZWlnaHRNYXg7CiAgICAgICAgICAgIGlmIChhcmdzLmZpbHRlcnMuZWR1Y2F0aW9uICE9PSB1bmRlZmluZWQpIHByZWZlcmVuY2VzLmVkdWNhdGlvbiA9IGFyZ3MuZmlsdGVycy5lZHVjYXRpb247CiAgICAgICAgICAgIGlmIChhcmdzLmZpbHRlcnMuZHJpbmtpbmcgIT09IHVuZGVmaW5lZCkgcHJlZmVyZW5jZXMuZHJpbmtpbmcgPSBhcmdzLmZpbHRlcnMuZHJpbmtpbmc7CiAgICAgICAgICAgIGlmIChhcmdzLmZpbHRlcnMuc21va2luZyAhPT0gdW5kZWZpbmVkKSBwcmVmZXJlbmNlcy5zbW9raW5nID0gYXJncy5maWx0ZXJzLnNtb2tpbmc7CiAgICAgICAgICAgIGlmIChhcmdzLmZpbHRlcnMucmVsYXRpb25zaGlwR29hbCAhPT0gdW5kZWZpbmVkKSBwcmVmZXJlbmNlcy5yZWxhdGlvbnNoaXBHb2FscyA9IGFyZ3MuZmlsdGVycy5yZWxhdGlvbnNoaXBHb2FsOwogICAgICAgICAgICBpZiAoYXJncy5maWx0ZXJzLnJlbGlnaW9uICE9PSB1bmRlZmluZWQpIHByZWZlcmVuY2VzLnJlbGlnaW9ucyA9IGFyZ3MuZmlsdGVycy5yZWxpZ2lvbjsKICAgICAgICAgICAgaWYgKGFyZ3MuZmlsdGVycy5oYXNDaGlsZHJlbiAhPT0gdW5kZWZpbmVkKSBwcmVmZXJlbmNlcy5oYXNLaWRzID0gYXJncy5maWx0ZXJzLmhhc0NoaWxkcmVuOwogICAgICAgICAgICBpZiAoYXJncy5maWx0ZXJzLndhbnRzQ2hpbGRyZW4gIT09IHVuZGVmaW5lZCkgcHJlZmVyZW5jZXMud2FudHNLaWRzID0gYXJncy5maWx0ZXJzLndhbnRzQ2hpbGRyZW47CiAgICAgICAgICAgIGlmIChhcmdzLmZpbHRlcnMubXVzdEJlVmVyaWZpZWQgIT09IHVuZGVmaW5lZCkgcHJlZmVyZW5jZXMubXVzdEJlVmVyaWZpZWQgPSBhcmdzLmZpbHRlcnMubXVzdEJlVmVyaWZpZWQ7CiAgICAgICAgfQoKICAgICAgICBjb25zdCBteVByb2ZpbGUgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgLnF1ZXJ5KCJwcm9maWxlcyIpCiAgICAgICAgICAgIC53aXRoSW5kZXgoInVzZXJJZCIsIChxKSA9PiBxLmVxKCJ1c2VySWQiLCBhcmdzLnVzZXJJZCkpCiAgICAgICAgICAgIC5maXJzdCgpOwoKICAgICAgICBpZiAoIW15UHJvZmlsZSkgcmV0dXJuIFtdOwoKICAgICAgICBjb25zdCBteUxvYyA9IGdldEVmZmVjdGl2ZUxvY2F0aW9uKG15UHJvZmlsZSk7CgogICAgICAgIC8vIEludGVyZXN0cwogICAgICAgIGNvbnN0IG15SW50ZXJlc3RzID0gYXdhaXQgY3R4LmRiCiAgICAgICAgICAgIC5xdWVyeSgiaW50ZXJlc3RzIikKICAgICAgICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIGFyZ3MudXNlcklkKSkKICAgICAgICAgICAgLmNvbGxlY3QoKTsKICAgICAgICBjb25zdCBteUludGVyZXN0c0xpc3QgPSBteUludGVyZXN0cy5tYXAoKGkpID0+IGkuaW50ZXJlc3QpOwoKICAgICAgICAvLyBFeGNsdXNpb25zCiAgICAgICAgY29uc3QgbXlMaWtlcyA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAucXVlcnkoImxpa2VzIikKICAgICAgICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIGFyZ3MudXNlcklkKSkKICAgICAgICAgICAgLmNvbGxlY3QoKTsKICAgICAgICBjb25zdCBsaWtlZFVzZXJJZHMgPSBuZXcgU2V0KG15TGlrZXMubWFwKChsKSA9PiBsLmxpa2VkVXNlcklkKSk7CgogICAgICAgIGNvbnN0IHNldmVuRGF5c0FnbyA9IERhdGUubm93KCkgLSA3ICogMjQgKiA2MCAqIDYwICogMTAwMDsKICAgICAgICBjb25zdCBteVBhc3NlcyA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAucXVlcnkoInBhc3NlcyIpCiAgICAgICAgICAgIC53aXRoSW5kZXgoInVzZXJJZCIsIChxKSA9PiBxLmVxKCJ1c2VySWQiLCBhcmdzLnVzZXJJZCkpCiAgICAgICAgICAgIC5jb2xsZWN0KCk7CiAgICAgICAgY29uc3QgcGFzc2VkVXNlcklkcyA9IG5ldyBTZXQobXlQYXNzZXMuZmlsdGVyKChwKSA9PiBwLmNyZWF0ZWRBdCA+IHNldmVuRGF5c0FnbykubWFwKChwKSA9PiBwLnBhc3NlZFVzZXJJZCkpOwoKICAgICAgICBjb25zdCBteUJsb2NrcyA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAucXVlcnkoImJsb2NrcyIpCiAgICAgICAgICAgIC53aXRoSW5kZXgoImJsb2NrZXJJZCIsIChxKSA9PiBxLmVxKCJibG9ja2VySWQiLCBhcmdzLnVzZXJJZCkpCiAgICAgICAgICAgIC5jb2xsZWN0KCk7CiAgICAgICAgY29uc3QgYmxvY2tlZEJ5TWUgPSBuZXcgU2V0KG15QmxvY2tzLm1hcCgoYikgPT4gYi5ibG9ja2VkVXNlcklkKSk7CgogICAgICAgIGNvbnN0IGJsb2Nrc09uTWUgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgLnF1ZXJ5KCJibG9ja3MiKQogICAgICAgICAgICAud2l0aEluZGV4KCJibG9ja2VkVXNlcklkIiwgKHEpID0+IHEuZXEoImJsb2NrZWRVc2VySWQiLCBhcmdzLnVzZXJJZCkpCiAgICAgICAgICAgIC5jb2xsZWN0KCk7CiAgICAgICAgY29uc3QgYmxvY2tlZE1lID0gbmV3IFNldChibG9ja3NPbk1lLm1hcCgoYikgPT4gYi5ibG9ja2VySWQpKTsKCiAgICAgICAgY29uc3QgYWxsUHJvZmlsZXMgPSBhd2FpdCBjdHguZGIucXVlcnkoInByb2ZpbGVzIikuY29sbGVjdCgpOwogICAgICAgIGNvbnN0IGNhbmRpZGF0ZXM6IGFueVtdID0gW107CgogICAgICAgIGZvciAoY29uc3QgcHJvZmlsZSBvZiBhbGxQcm9maWxlcykgewogICAgICAgICAgICBpZiAocHJvZmlsZS51c2VySWQgPT09IGFyZ3MudXNlcklkKSBjb250aW51ZTsKICAgICAgICAgICAgaWYgKGxpa2VkVXNlcklkcy5oYXMocHJvZmlsZS51c2VySWQpKSBjb250aW51ZTsKICAgICAgICAgICAgaWYgKHBhc3NlZFVzZXJJZHMuaGFzKHByb2ZpbGUudXNlcklkKSkgY29udGludWU7CiAgICAgICAgICAgIGlmIChibG9ja2VkQnlNZS5oYXMocHJvZmlsZS51c2VySWQpKSBjb250aW51ZTsKICAgICAgICAgICAgaWYgKGJsb2NrZWRNZS5oYXMocHJvZmlsZS51c2VySWQpKSBjb250aW51ZTsKCiAgICAgICAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBjdHguZGIuZ2V0KHByb2ZpbGUudXNlcklkKTsKICAgICAgICAgICAgY29uc3QgcGhvdG9zID0gYXdhaXQgY3R4LmRiCiAgICAgICAgICAgICAgICAucXVlcnkoInBob3RvcyIpCiAgICAgICAgICAgICAgICAud2l0aEluZGV4KCJ1c2VySWQiLCAocSkgPT4gcS5lcSgidXNlcklkIiwgcHJvZmlsZS51c2VySWQpKQogICAgICAgICAgICAgICAgLmNvbGxlY3QoKTsKCiAgICAgICAgICAgIC8vIEFwcGx5IGZpbHRlcnMKICAgICAgICAgICAgaWYgKHByZWZlcmVuY2VzLm1pbkFnZSAhPT0gdW5kZWZpbmVkICYmIHByb2ZpbGUuYWdlIDwgcHJlZmVyZW5jZXMubWluQWdlKSBjb250aW51ZTsKICAgICAgICAgICAgaWYgKHByZWZlcmVuY2VzLm1heEFnZSAhPT0gdW5kZWZpbmVkICYmIHByb2ZpbGUuYWdlID4gcHJlZmVyZW5jZXMubWF4QWdlKSBjb250aW51ZTsKICAgICAgICAgICAgaWYgKHByZWZlcmVuY2VzLmdlbmRlclByZWZlcmVuY2U/Lmxlbmd0aCAmJiAhcHJlZmVyZW5jZXMuZ2VuZGVyUHJlZmVyZW5jZS5pbmNsdWRlcyhwcm9maWxlLmdlbmRlcikpIGNvbnRpbnVlOwogICAgICAgICAgICBpZiAocHJlZmVyZW5jZXMubXVzdEJlVmVyaWZpZWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGlzVmVyaWZpZWQgPSAodXNlciBhcyBhbnkpPy5pc1ZlcmlmaWVkIHx8ICh1c2VyIGFzIGFueSk/LnZlcmlmaWNhdGlvblN0YXR1cyA9PT0gInZlcmlmaWVkIjsKICAgICAgICAgICAgICAgIGlmICghaXNWZXJpZmllZCkgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKChwcmVmZXJlbmNlcyBhcyBhbnkpLm11c3RIYXZlUGhvdG9zICYmIHBob3Rvcy5sZW5ndGggPT09IDApIGNvbnRpbnVlOwogICAgICAgICAgICBpZiAoKHByZWZlcmVuY2VzIGFzIGFueSkubXVzdEhhdmVCaW8gJiYgIShwcm9maWxlLmJpbyAmJiBwcm9maWxlLmJpby50cmltKCkubGVuZ3RoID4gMCkpIGNvbnRpbnVlOwogICAgICAgICAgICBpZiAoKHByZWZlcmVuY2VzIGFzIGFueSkuYWN0aXZlSW5MYXN0N0RheXMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHNldmVuRGF5c0FnbzIgPSBEYXRlLm5vdygpIC0gNyAqIDI0ICogNjAgKiA2MCAqIDEwMDA7CiAgICAgICAgICAgICAgICBjb25zdCBsYXN0QWN0aXZlID0gcHJvZmlsZS5sYXN0QWN0aXZlQXQgfHwgKHVzZXIgYXMgYW55KT8ubGFzdFNlZW5BdCB8fCAwOwogICAgICAgICAgICAgICAgaWYgKGxhc3RBY3RpdmUgPCBzZXZlbkRheXNBZ28yKSBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJlZmVyZW5jZXMubWluSGVpZ2h0ICE9PSB1bmRlZmluZWQgJiYgKHByb2ZpbGUuaGVpZ2h0ID8/IDApIDwgcHJlZmVyZW5jZXMubWluSGVpZ2h0KSBjb250aW51ZTsKICAgICAgICAgICAgaWYgKHByZWZlcmVuY2VzLm1heEhlaWdodCAhPT0gdW5kZWZpbmVkICYmIChwcm9maWxlLmhlaWdodCA/PyA5OTk5KSA+IHByZWZlcmVuY2VzLm1heEhlaWdodCkgY29udGludWU7CiAgICAgICAgICAgIGlmIChwcmVmZXJlbmNlcy5lZHVjYXRpb24/Lmxlbmd0aCAmJiBwcm9maWxlLmVkdWNhdGlvbiAmJiAhcHJlZmVyZW5jZXMuZWR1Y2F0aW9uLmluY2x1ZGVzKHByb2ZpbGUuZWR1Y2F0aW9uKSkgY29udGludWU7CiAgICAgICAgICAgIGlmIChwcmVmZXJlbmNlcy5kcmlua2luZz8ubGVuZ3RoICYmIHByb2ZpbGUuZHJpbmtpbmcgJiYgIXByZWZlcmVuY2VzLmRyaW5raW5nLmluY2x1ZGVzKHByb2ZpbGUuZHJpbmtpbmcpKSBjb250aW51ZTsKICAgICAgICAgICAgaWYgKHByZWZlcmVuY2VzLnNtb2tpbmc/Lmxlbmd0aCAmJiBwcm9maWxlLnNtb2tpbmcgJiYgIXByZWZlcmVuY2VzLnNtb2tpbmcuaW5jbHVkZXMocHJvZmlsZS5zbW9raW5nKSkgY29udGludWU7CiAgICAgICAgICAgIGlmIChwcmVmZXJlbmNlcy5yZWxhdGlvbnNoaXBHb2Fscz8ubGVuZ3RoICYmIHByb2ZpbGUucmVsYXRpb25zaGlwR29hbCAmJiAhcHJlZmVyZW5jZXMucmVsYXRpb25zaGlwR29hbHMuaW5jbHVkZXMocHJvZmlsZS5yZWxhdGlvbnNoaXBHb2FsKSkgY29udGludWU7CiAgICAgICAgICAgIGlmIChwcmVmZXJlbmNlcy5yZWxpZ2lvbnM/Lmxlbmd0aCAmJiBwcm9maWxlLnJlbGlnaW9uICYmICFwcmVmZXJlbmNlcy5yZWxpZ2lvbnMuaW5jbHVkZXMocHJvZmlsZS5yZWxpZ2lvbikpIGNvbnRpbnVlOwogICAgICAgICAgICBpZiAocHJlZmVyZW5jZXMuaGFzS2lkcyAhPT0gdW5kZWZpbmVkICYmIHByb2ZpbGUuaGFzS2lkcyAhPT0gcHJlZmVyZW5jZXMuaGFzS2lkcykgY29udGludWU7CiAgICAgICAgICAgIGlmIChwcmVmZXJlbmNlcy53YW50c0tpZHMgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgY29uc3Qgd2FudHMgPSBwcm9maWxlLndhbnRzS2lkczsKICAgICAgICAgICAgICAgIGlmIChwcmVmZXJlbmNlcy53YW50c0tpZHMgPT09IHRydWUgJiYgd2FudHMgPT09ICJubyIpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgaWYgKHByZWZlcmVuY2VzLndhbnRzS2lkcyA9PT0gZmFsc2UgJiYgd2FudHMgIT09ICJubyIpIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcmVmZXJlbmNlcy5tYXhEaXN0YW5jZSAhPT0gdW5kZWZpbmVkICYmIG15TG9jLmxhdCAhPT0gdW5kZWZpbmVkICYmIG15TG9jLmxvbiAhPT0gdW5kZWZpbmVkICYmIHByb2ZpbGUubGF0aXR1ZGUgIT09IHVuZGVmaW5lZCAmJiBwcm9maWxlLmxvbmdpdHVkZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkID0gaGF2ZXJzaW5lS20obXlMb2MubGF0LCBteUxvYy5sb24sIHByb2ZpbGUubGF0aXR1ZGUsIHByb2ZpbGUubG9uZ2l0dWRlKTsKICAgICAgICAgICAgICAgIGlmIChkID4gcHJlZmVyZW5jZXMubWF4RGlzdGFuY2UpIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBpbnRlcmVzdHMgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgICAgIC5xdWVyeSgiaW50ZXJlc3RzIikKICAgICAgICAgICAgICAgIC53aXRoSW5kZXgoInVzZXJJZCIsIChxKSA9PiBxLmVxKCJ1c2VySWQiLCBwcm9maWxlLnVzZXJJZCkpCiAgICAgICAgICAgICAgICAuY29sbGVjdCgpOwogICAgICAgICAgICBjb25zdCBjYW5kaWRhdGVJc1ByZW1pdW0gPSBhd2FpdCBpc1VzZXJQcmVtaXVtKGN0eCwgcHJvZmlsZS51c2VySWQpOwogICAgICAgICAgICBjb25zdCBjYW5kaWRhdGVJbnRlcmVzdHMgPSBpbnRlcmVzdHMubWFwKChpKSA9PiBpLmludGVyZXN0KTsKCiAgICAgICAgICAgIGNvbnN0IHNjb3JlID0gY2FsY3VsYXRlTWF0Y2hTY29yZSgKICAgICAgICAgICAgICAgIG15UHJvZmlsZSwKICAgICAgICAgICAgICAgIG15SW50ZXJlc3RzTGlzdCwKICAgICAgICAgICAgICAgIHsgLi4ucHJvZmlsZSwgcGhvdG9zIH0sCiAgICAgICAgICAgICAgICBjYW5kaWRhdGVJbnRlcmVzdHMsCiAgICAgICAgICAgICAgICB1c2VyPy5sYXN0U2VlbkF0IHx8IDAKICAgICAgICAgICAgKTsKCiAgICAgICAgICAgIGNhbmRpZGF0ZXMucHVzaCh7CiAgICAgICAgICAgICAgICAuLi5wcm9maWxlLAogICAgICAgICAgICAgICAgbmFtZTogdXNlcj8ubmFtZSwKICAgICAgICAgICAgICAgIHBob3RvczogcGhvdG9zLnNvcnQoKGEsIGIpID0+IGEub3JkZXIgLSBiLm9yZGVyKSwKICAgICAgICAgICAgICAgIGludGVyZXN0czogY2FuZGlkYXRlSW50ZXJlc3RzLAogICAgICAgICAgICAgICAgaXNQcmVtaXVtOiBjYW5kaWRhdGVJc1ByZW1pdW0sCiAgICAgICAgICAgICAgICBtYXRjaFNjb3JlOiBzY29yZSwKICAgICAgICAgICAgICAgIGRpc3RhbmNlS206CiAgICAgICAgICAgICAgICAgICAgbXlMb2MubGF0ICE9PSB1bmRlZmluZWQgJiYgbXlMb2MubG9uICE9PSB1bmRlZmluZWQgJiYgcHJvZmlsZS5sYXRpdHVkZSAhPT0gdW5kZWZpbmVkICYmIHByb2ZpbGUubG9uZ2l0dWRlICE9PSB1bmRlZmluZWQKICAgICAgICAgICAgICAgICAgICAgICAgPyBoYXZlcnNpbmVLbShteUxvYy5sYXQsIG15TG9jLmxvbiwgcHJvZmlsZS5sYXRpdHVkZSwgcHJvZmlsZS5sb25naXR1ZGUpCiAgICAgICAgICAgICAgICAgICAgICAgIDogbnVsbCwKICAgICAgICAgICAgICAgIGRpc3RhbmNlQ2l0eTogcHJvZmlsZS5sb2NhdGlvbiwKICAgICAgICAgICAgICAgIHBhc3Nwb3J0TW9kZTogbXlMb2MuaXNQYXNzcG9ydCwKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBjYW5kaWRhdGVzLnNvcnQoKGEsIGIpID0+IGIubWF0Y2hTY29yZSAtIGEubWF0Y2hTY29yZSk7CiAgICAgICAgcmV0dXJuIGNhbmRpZGF0ZXMuc2xpY2UoMCwgbGltaXQpOwogICAgfSwKfSk7CgovLyBMaWtlIGEgcHJvZmlsZQpleHBvcnQgY29uc3QgbGlrZVByb2ZpbGUgPSBtdXRhdGlvbih7CiAgICBhcmdzOiB7CiAgICAgICAgdXNlcklkOiB2LmlkKCJ1c2VycyIpLAogICAgICAgIGxpa2VkVXNlcklkOiB2LmlkKCJ1c2VycyIpLAogICAgfSwKICAgIGhhbmRsZXI6IGFzeW5jIChjdHgsIGFyZ3MpID0+IHsKICAgICAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpOwoKICAgICAgICBhd2FpdCBjb25zdW1lTGlrZShjdHgsIGFyZ3MudXNlcklkKTsKCiAgICAgICAgLy8gSWYgYWxyZWFkeSBtYXRjaGVkLCBkbyBub3RoaW5nCiAgICAgICAgY29uc3QgW3VzZXIxLCB1c2VyMl0gPSBbYXJncy51c2VySWQsIGFyZ3MubGlrZWRVc2VySWRdLnNvcnQoKTsKICAgICAgICBjb25zdCBleGlzdGluZ01hdGNoID0gYXdhaXQgY3R4LmRiCiAgICAgICAgICAgIC5xdWVyeSgibWF0Y2hlcyIpCiAgICAgICAgICAgIC53aXRoSW5kZXgoInVzZXJzIiwgKHEpID0+IHEuZXEoInVzZXIxSWQiLCB1c2VyMSkuZXEoInVzZXIySWQiLCB1c2VyMikpCiAgICAgICAgICAgIC5maXJzdCgpOwoKICAgICAgICBpZiAoZXhpc3RpbmdNYXRjaCkgewogICAgICAgICAgICByZXR1cm4geyBtYXRjaGVkOiB0cnVlLCBtYXRjaElkOiBleGlzdGluZ01hdGNoLl9pZCB9OwogICAgICAgIH0KCiAgICAgICAgLy8gQ2hlY2sgaWYgYWxyZWFkeSBsaWtlZAogICAgICAgIGNvbnN0IGV4aXN0aW5nID0gYXdhaXQgY3R4LmRiCiAgICAgICAgICAgIC5xdWVyeSgibGlrZXMiKQogICAgICAgICAgICAud2l0aEluZGV4KCJwYWlyIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIGFyZ3MudXNlcklkKS5lcSgibGlrZWRVc2VySWQiLCBhcmdzLmxpa2VkVXNlcklkKSkKICAgICAgICAgICAgLmZpcnN0KCk7CgogICAgICAgIGlmIChleGlzdGluZykgewogICAgICAgICAgICByZXR1cm4geyBtYXRjaGVkOiBmYWxzZSB9OyAvLyBBbHJlYWR5IGxpa2VkCiAgICAgICAgfQoKICAgICAgICAvLyBDcmVhdGUgbGlrZQogICAgICAgIGF3YWl0IGN0eC5kYi5pbnNlcnQoImxpa2VzIiwgewogICAgICAgICAgICB1c2VySWQ6IGFyZ3MudXNlcklkLAogICAgICAgICAgICBsaWtlZFVzZXJJZDogYXJncy5saWtlZFVzZXJJZCwKICAgICAgICAgICAgY3JlYXRlZEF0OiBub3csCiAgICAgICAgfSk7CgogICAgICAgIC8vIFBob3RvIGFuYWx5dGljczogcmVjb3JkIGxpa2UgYWdhaW5zdCBwcmltYXJ5IHBob3RvCiAgICAgICAgY29uc3QgbGlrZWRQaG90b3MgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgLnF1ZXJ5KCJwaG90b3MiKQogICAgICAgICAgICAud2l0aEluZGV4KCJ1c2VySWQiLCAocSkgPT4gcS5lcSgidXNlcklkIiwgYXJncy5saWtlZFVzZXJJZCkpCiAgICAgICAgICAgIC5jb2xsZWN0KCk7CiAgICAgICAgY29uc3QgbGlrZWRQcmltYXJ5ID0gbGlrZWRQaG90b3MuZmluZCgocDogYW55KSA9PiBwLmlzUHJpbWFyeSkgfHwgbGlrZWRQaG90b3Muc29ydCgoYTogYW55LCBiOiBhbnkpID0+IGEub3JkZXIgLSBiLm9yZGVyKVswXTsKICAgICAgICBpZiAobGlrZWRQcmltYXJ5KSB7CiAgICAgICAgICAgIGF3YWl0IHVwZGF0ZVBob3RvQW5hbHl0aWNzKGN0eCwgbGlrZWRQcmltYXJ5Ll9pZCwgYXJncy5saWtlZFVzZXJJZCwgImxpa2UiKTsKICAgICAgICB9CgogICAgICAgIC8vIENoZWNrIGlmIHRoZXkgbGlrZWQgbWUgYmFjayAobXV0dWFsIGxpa2UgPSBtYXRjaCkKICAgICAgICBjb25zdCB0aGVpckxpa2UgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgLnF1ZXJ5KCJsaWtlcyIpCiAgICAgICAgICAgIC53aXRoSW5kZXgoInBhaXIiLCAocSkgPT4gcS5lcSgidXNlcklkIiwgYXJncy5saWtlZFVzZXJJZCkuZXEoImxpa2VkVXNlcklkIiwgYXJncy51c2VySWQpKQogICAgICAgICAgICAuZmlyc3QoKTsKCiAgICAgICAgaWYgKHRoZWlyTGlrZSkgewogICAgICAgICAgICAvLyBDcmVhdGUgbWF0Y2ghCiAgICAgICAgICAgIGNvbnN0IG1hdGNoSWQgPSBhd2FpdCBjdHguZGIuaW5zZXJ0KCJtYXRjaGVzIiwgewogICAgICAgICAgICAgICAgdXNlcjFJZDogdXNlcjEsCiAgICAgICAgICAgICAgICB1c2VyMklkOiB1c2VyMiwKICAgICAgICAgICAgICAgIG1hdGNoZWRBdDogbm93LAogICAgICAgICAgICAgICAgdXNlcjFVbnJlYWQ6IDAsCiAgICAgICAgICAgICAgICB1c2VyMlVucmVhZDogMCwKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBHZXQgdXNlciBuYW1lcyBmb3IgYmV0dGVyIG5vdGlmaWNhdGlvbgogICAgICAgICAgICBjb25zdCBzZW5kZXIgPSBhd2FpdCBjdHguZGIuZ2V0KGFyZ3MudXNlcklkKTsKICAgICAgICAgICAgY29uc3QgcmVjZWl2ZXIgPSBhd2FpdCBjdHguZGIuZ2V0KGFyZ3MubGlrZWRVc2VySWQpOwogICAgICAgICAgICAKICAgICAgICAgICAgYXdhaXQgaW5zZXJ0Tm90aWZpY2F0aW9uKGN0eCwgewogICAgICAgICAgICAgICAgdXNlcklkOiBhcmdzLnVzZXJJZCwKICAgICAgICAgICAgICAgIHR5cGU6ICJtYXRjaCIsCiAgICAgICAgICAgICAgICB0aXRsZTogIkl0J3MgYSBNYXRjaCEg8J+SlSIsCiAgICAgICAgICAgICAgICBib2R5OiBgWW91IGFuZCAke3JlY2VpdmVyPy5uYW1lIHx8ICJzb21lb25lIn0gbGlrZWQgZWFjaCBvdGhlciFgLAogICAgICAgICAgICAgICAgcHJpb3JpdHk6ICJjcml0aWNhbCIsCiAgICAgICAgICAgICAgICBjYXRlZ29yeTogInNvY2lhbCIsCiAgICAgICAgICAgICAgICBpY29uOiAi8J+SlSIsCiAgICAgICAgICAgICAgICByZWxhdGVkVXNlcklkOiBhcmdzLmxpa2VkVXNlcklkLAogICAgICAgICAgICAgICAgcmVsYXRlZE1hdGNoSWQ6IG1hdGNoSWQsCiAgICAgICAgICAgICAgICBsaW5rOiBgL21hdGNoZXMvJHttYXRjaElkfWAsCiAgICAgICAgICAgICAgICBhY3Rpb25CdXR0b25zOiBbCiAgICAgICAgICAgICAgICAgICAgeyBsYWJlbDogIlNlbmQgTWVzc2FnZSIsIGFjdGlvbjogIm5hdmlnYXRlIiwgbGluazogYC9jaGF0LyR7bWF0Y2hJZH1gIH0sCiAgICAgICAgICAgICAgICAgICAgeyBsYWJlbDogIlZpZXcgUHJvZmlsZSIsIGFjdGlvbjogIm5hdmlnYXRlIiwgbGluazogYC9wcm9maWxlLyR7YXJncy5saWtlZFVzZXJJZH1gIH0sCiAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgYXdhaXQgaW5zZXJ0Tm90aWZpY2F0aW9uKGN0eCwgewogICAgICAgICAgICAgICAgdXNlcklkOiBhcmdzLmxpa2VkVXNlcklkLAogICAgICAgICAgICAgICAgdHlwZTogIm1hdGNoIiwKICAgICAgICAgICAgICAgIHRpdGxlOiAiSXQncyBhIE1hdGNoISDwn5KVIiwKICAgICAgICAgICAgICAgIGJvZHk6IGBZb3UgYW5kICR7c2VuZGVyPy5uYW1lIHx8ICJzb21lb25lIn0gbGlrZWQgZWFjaCBvdGhlciFgLAogICAgICAgICAgICAgICAgcHJpb3JpdHk6ICJjcml0aWNhbCIsCiAgICAgICAgICAgICAgICBjYXRlZ29yeTogInNvY2lhbCIsCiAgICAgICAgICAgICAgICBpY29uOiAi8J+SlSIsCiAgICAgICAgICAgICAgICByZWxhdGVkVXNlcklkOiBhcmdzLnVzZXJJZCwKICAgICAgICAgICAgICAgIHJlbGF0ZWRNYXRjaElkOiBtYXRjaElkLAogICAgICAgICAgICAgICAgbGluazogYC9tYXRjaGVzLyR7bWF0Y2hJZH1gLAogICAgICAgICAgICAgICAgYWN0aW9uQnV0dG9uczogWwogICAgICAgICAgICAgICAgICAgIHsgbGFiZWw6ICJTZW5kIE1lc3NhZ2UiLCBhY3Rpb246ICJuYXZpZ2F0ZSIsIGxpbms6IGAvY2hhdC8ke21hdGNoSWR9YCB9LAogICAgICAgICAgICAgICAgICAgIHsgbGFiZWw6ICJWaWV3IFByb2ZpbGUiLCBhY3Rpb246ICJuYXZpZ2F0ZSIsIGxpbms6IGAvcHJvZmlsZS8ke2FyZ3MudXNlcklkfWAgfSwKICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gUGhhc2UgMzogU2VuZCBwdXNoIG5vdGlmaWNhdGlvbnMgZm9yIG1hdGNoCiAgICAgICAgICAgIGF3YWl0IGN0eC5zY2hlZHVsZXIucnVuQWZ0ZXIoMCwgInB1c2hOb3RpZmljYXRpb25zOm5vdGlmeU5ld01hdGNoIiBhcyBhbnksIHsKICAgICAgICAgICAgICAgIG1hdGNoSWQsCiAgICAgICAgICAgICAgICB1c2VySWQ6IGFyZ3MudXNlcklkLAogICAgICAgICAgICAgICAgb3RoZXJVc2VySWQ6IGFyZ3MubGlrZWRVc2VySWQsCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBhd2FpdCBjdHguc2NoZWR1bGVyLnJ1bkFmdGVyKDAsICJwdXNoTm90aWZpY2F0aW9uczpub3RpZnlOZXdNYXRjaCIgYXMgYW55LCB7CiAgICAgICAgICAgICAgICBtYXRjaElkLAogICAgICAgICAgICAgICAgdXNlcklkOiBhcmdzLmxpa2VkVXNlcklkLAogICAgICAgICAgICAgICAgb3RoZXJVc2VySWQ6IGFyZ3MudXNlcklkLAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGF3YWl0IHVwZGF0ZUVsb09uTWF0Y2goY3R4LCBhcmdzLnVzZXJJZCwgYXJncy5saWtlZFVzZXJJZCk7CgogICAgICAgICAgICByZXR1cm4geyBtYXRjaGVkOiB0cnVlLCBtYXRjaElkIH07CiAgICAgICAgfQoKICAgICAgICAvLyBOb3RpZnkgdGhlIGxpa2VkIHVzZXIgKG5vbi1tdXR1YWwgbGlrZSkKICAgICAgICBjb25zdCBsaWtlciA9IGF3YWl0IGN0eC5kYi5nZXQoYXJncy51c2VySWQpOwogICAgICAgIGF3YWl0IGluc2VydE5vdGlmaWNhdGlvbihjdHgsIHsKICAgICAgICAgICAgdXNlcklkOiBhcmdzLmxpa2VkVXNlcklkLAogICAgICAgICAgICB0eXBlOiAibGlrZSIsCiAgICAgICAgICAgIHRpdGxlOiAiTmV3IGxpa2UhIPCfkpYiLAogICAgICAgICAgICBib2R5OiBgJHtsaWtlcj8ubmFtZSB8fCAiU29tZW9uZSJ9IGxpa2VkIHlvdXIgcHJvZmlsZWAsCiAgICAgICAgICAgIHByaW9yaXR5OiAibWVkaXVtIiwKICAgICAgICAgICAgY2F0ZWdvcnk6ICJzb2NpYWwiLAogICAgICAgICAgICBpY29uOiAi8J+SliIsCiAgICAgICAgICAgIHJlbGF0ZWRVc2VySWQ6IGFyZ3MudXNlcklkLAogICAgICAgICAgICBsaW5rOiAiL2xpa2VzIiwKICAgICAgICAgICAgYWN0aW9uQnV0dG9uczogWwogICAgICAgICAgICAgICAgeyBsYWJlbDogIlZpZXciLCBhY3Rpb246ICJuYXZpZ2F0ZSIsIGxpbms6ICIvbGlrZXMiIH0sCiAgICAgICAgICAgIF0sCiAgICAgICAgfSk7CgogICAgICAgIC8vIFB1c2ggbm90aWZpY2F0aW9uIGZvciBsaWtlIHJlY2VpdmVkCiAgICAgICAgYXdhaXQgY3R4LnNjaGVkdWxlci5ydW5BZnRlcigwLCAicHVzaE5vdGlmaWNhdGlvbnM6bm90aWZ5TGlrZVJlY2VpdmVkIiBhcyBhbnksIHsKICAgICAgICAgICAgcmVjaXBpZW50SWQ6IGFyZ3MubGlrZWRVc2VySWQsCiAgICAgICAgICAgIGxpa2VySWQ6IGFyZ3MudXNlcklkLAogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4geyBtYXRjaGVkOiBmYWxzZSB9OwogICAgfSwKfSk7CgovLyBQYXNzIG9uIGEgcHJvZmlsZQpleHBvcnQgY29uc3QgcGFzc1Byb2ZpbGUgPSBtdXRhdGlvbih7CiAgICBhcmdzOiB7CiAgICAgICAgdXNlcklkOiB2LmlkKCJ1c2VycyIpLAogICAgICAgIHBhc3NlZFVzZXJJZDogdi5pZCgidXNlcnMiKSwKICAgIH0sCiAgICBoYW5kbGVyOiBhc3luYyAoY3R4LCBhcmdzKSA9PiB7CiAgICAgICAgLy8gQ2hlY2sgaWYgYWxyZWFkeSBwYXNzZWQKICAgICAgICBjb25zdCBleGlzdGluZyA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAucXVlcnkoInBhc3NlcyIpCiAgICAgICAgICAgIC53aXRoSW5kZXgoInBhaXIiLCAocSkgPT4gcS5lcSgidXNlcklkIiwgYXJncy51c2VySWQpLmVxKCJwYXNzZWRVc2VySWQiLCBhcmdzLnBhc3NlZFVzZXJJZCkpCiAgICAgICAgICAgIC5maXJzdCgpOwoKICAgICAgICBpZiAoZXhpc3RpbmcpIHsKICAgICAgICAgICAgcmV0dXJuOyAvLyBBbHJlYWR5IHBhc3NlZAogICAgICAgIH0KCiAgICAgICAgYXdhaXQgY3R4LmRiLmluc2VydCgicGFzc2VzIiwgewogICAgICAgICAgICB1c2VySWQ6IGFyZ3MudXNlcklkLAogICAgICAgICAgICBwYXNzZWRVc2VySWQ6IGFyZ3MucGFzc2VkVXNlcklkLAogICAgICAgICAgICBjcmVhdGVkQXQ6IERhdGUubm93KCksCiAgICAgICAgfSk7CgogICAgICAgIC8vIFBob3RvIGFuYWx5dGljczogcmVjb3JkIHBhc3MgYWdhaW5zdCBwcmltYXJ5IHBob3RvCiAgICAgICAgY29uc3QgcGhvdG9zID0gYXdhaXQgY3R4LmRiCiAgICAgICAgICAgIC5xdWVyeSgicGhvdG9zIikKICAgICAgICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIGFyZ3MucGFzc2VkVXNlcklkKSkKICAgICAgICAgICAgLmNvbGxlY3QoKTsKICAgICAgICBjb25zdCBwcmltYXJ5ID0gcGhvdG9zLmZpbmQoKHA6IGFueSkgPT4gcC5pc1ByaW1hcnkpIHx8IHBob3Rvcy5zb3J0KChhOiBhbnksIGI6IGFueSkgPT4gYS5vcmRlciAtIGIub3JkZXIpWzBdOwogICAgICAgIGlmIChwcmltYXJ5KSB7CiAgICAgICAgICAgIGF3YWl0IHVwZGF0ZVBob3RvQW5hbHl0aWNzKGN0eCwgcHJpbWFyeS5faWQsIGFyZ3MucGFzc2VkVXNlcklkLCAicGFzcyIpOwogICAgICAgIH0KICAgIH0sCn0pOwoKLy8gR2V0IHVzZXIncyBtYXRjaGVzCmV4cG9ydCBjb25zdCBnZXRNYXRjaGVzID0gcXVlcnkoewogICAgYXJnczogeyB1c2VySWQ6IHYuaWQoInVzZXJzIikgfSwKICAgIGhhbmRsZXI6IGFzeW5jIChjdHgsIGFyZ3MpID0+IHsKICAgICAgICAvLyBHZXQgbWF0Y2hlcyB3aGVyZSB1c2VyIGlzIGVpdGhlciB1c2VyMSBvciB1c2VyMgogICAgICAgIGNvbnN0IG1hdGNoZXMxID0gYXdhaXQgY3R4LmRiCiAgICAgICAgICAgIC5xdWVyeSgibWF0Y2hlcyIpCiAgICAgICAgICAgIC53aXRoSW5kZXgoInVzZXIxSWQiLCAocSkgPT4gcS5lcSgidXNlcjFJZCIsIGFyZ3MudXNlcklkKSkKICAgICAgICAgICAgLmNvbGxlY3QoKTsKCiAgICAgICAgY29uc3QgbWF0Y2hlczIgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgLnF1ZXJ5KCJtYXRjaGVzIikKICAgICAgICAgICAgLndpdGhJbmRleCgidXNlcjJJZCIsIChxKSA9PiBxLmVxKCJ1c2VyMklkIiwgYXJncy51c2VySWQpKQogICAgICAgICAgICAuY29sbGVjdCgpOwoKICAgICAgICBjb25zdCBhbGxNYXRjaGVzID0gWy4uLm1hdGNoZXMxLCAuLi5tYXRjaGVzMl07CgogICAgICAgIC8vIEdldCBwcm9maWxlIGluZm8gZm9yIGVhY2ggbWF0Y2gKICAgICAgICBjb25zdCBtYXRjaGVzV2l0aFByb2ZpbGVzID0gW107CiAgICAgICAgZm9yIChjb25zdCBtYXRjaCBvZiBhbGxNYXRjaGVzKSB7CiAgICAgICAgICAgIGNvbnN0IG90aGVyVXNlcklkID0gbWF0Y2gudXNlcjFJZCA9PT0gYXJncy51c2VySWQgPyBtYXRjaC51c2VyMklkIDogbWF0Y2gudXNlcjFJZDsKCiAgICAgICAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBjdHguZGIuZ2V0KG90aGVyVXNlcklkKTsKICAgICAgICAgICAgY29uc3QgcHJvZmlsZSA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAgICAgLnF1ZXJ5KCJwcm9maWxlcyIpCiAgICAgICAgICAgICAgICAud2l0aEluZGV4KCJ1c2VySWQiLCAocSkgPT4gcS5lcSgidXNlcklkIiwgb3RoZXJVc2VySWQpKQogICAgICAgICAgICAgICAgLmZpcnN0KCk7CgogICAgICAgICAgICBpZiAoIXByb2ZpbGUpIGNvbnRpbnVlOwoKICAgICAgICAgICAgY29uc3QgcGhvdG9zID0gYXdhaXQgY3R4LmRiCiAgICAgICAgICAgICAgICAucXVlcnkoInBob3RvcyIpCiAgICAgICAgICAgICAgICAud2l0aEluZGV4KCJ1c2VySWQiLCAocSkgPT4gcS5lcSgidXNlcklkIiwgb3RoZXJVc2VySWQpKQogICAgICAgICAgICAgICAgLmNvbGxlY3QoKTsKCiAgICAgICAgICAgIGNvbnN0IGludGVyZXN0cyA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAgICAgLnF1ZXJ5KCJpbnRlcmVzdHMiKQogICAgICAgICAgICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIG90aGVyVXNlcklkKSkKICAgICAgICAgICAgICAgIC5jb2xsZWN0KCk7CgogICAgICAgICAgICBjb25zdCBzb3J0ZWRQaG90b3MgPSBwaG90b3Muc29ydCgoYSwgYikgPT4gYS5vcmRlciAtIGIub3JkZXIpOwogICAgICAgICAgICBjb25zdCBwcmltYXJ5UGhvdG8gPSBzb3J0ZWRQaG90b3MuZmluZCgocCkgPT4gcC5pc1ByaW1hcnkpIHx8IHNvcnRlZFBob3Rvc1swXTsKCiAgICAgICAgICAgIG1hdGNoZXNXaXRoUHJvZmlsZXMucHVzaCh7CiAgICAgICAgICAgICAgICBtYXRjaElkOiBtYXRjaC5faWQsCiAgICAgICAgICAgICAgICB1c2VySWQ6IG90aGVyVXNlcklkLAogICAgICAgICAgICAgICAgbmFtZTogdXNlcj8ubmFtZSwKICAgICAgICAgICAgICAgIG1hdGNoZWRBdDogbWF0Y2gubWF0Y2hlZEF0LAogICAgICAgICAgICAgICAgbGFzdE1lc3NhZ2VBdDogbWF0Y2gubGFzdE1lc3NhZ2VBdCwKICAgICAgICAgICAgICAgIHVucmVhZENvdW50OiBtYXRjaC51c2VyMUlkID09PSBhcmdzLnVzZXJJZCA/IG1hdGNoLnVzZXIxVW5yZWFkIDogbWF0Y2gudXNlcjJVbnJlYWQsCiAgICAgICAgICAgICAgICBwcm9maWxlOiB7CiAgICAgICAgICAgICAgICAgICAgLi4ucHJvZmlsZSwKICAgICAgICAgICAgICAgICAgICBwaG90b3M6IHNvcnRlZFBob3RvcywKICAgICAgICAgICAgICAgICAgICBpbnRlcmVzdHM6IGludGVyZXN0cy5tYXAoKGkpID0+IGkuaW50ZXJlc3QpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHByaW1hcnlQaG90bzogcHJpbWFyeVBob3RvPy51cmwsCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gU29ydCBieSBtb3N0IHJlY2VudCBhY3Rpdml0eQogICAgICAgIG1hdGNoZXNXaXRoUHJvZmlsZXMuc29ydCgoYSwgYikgPT4gewogICAgICAgICAgICBjb25zdCBhVGltZSA9IGEubGFzdE1lc3NhZ2VBdCB8fCBhLm1hdGNoZWRBdDsKICAgICAgICAgICAgY29uc3QgYlRpbWUgPSBiLmxhc3RNZXNzYWdlQXQgfHwgYi5tYXRjaGVkQXQ7CiAgICAgICAgICAgIHJldHVybiBiVGltZSAtIGFUaW1lOwogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gbWF0Y2hlc1dpdGhQcm9maWxlczsKICAgIH0sCn0pOwoKLy8gR2V0IHByb2ZpbGVzIHVzZXIgaGFzIGxpa2VkCmV4cG9ydCBjb25zdCBnZXRMaWtlcyA9IHF1ZXJ5KHsKICAgIGFyZ3M6IHsgdXNlcklkOiB2LmlkKCJ1c2VycyIpIH0sCiAgICBoYW5kbGVyOiBhc3luYyAoY3R4LCBhcmdzKSA9PiB7CiAgICAgICAgY29uc3QgbGlrZXMgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgLnF1ZXJ5KCJsaWtlcyIpCiAgICAgICAgICAgIC53aXRoSW5kZXgoInVzZXJJZCIsIChxKSA9PiBxLmVxKCJ1c2VySWQiLCBhcmdzLnVzZXJJZCkpCiAgICAgICAgICAgIC5jb2xsZWN0KCk7CgogICAgICAgIGNvbnN0IGxpa2VkUHJvZmlsZXMgPSBbXTsKICAgICAgICBmb3IgKGNvbnN0IGxpa2Ugb2YgbGlrZXMpIHsKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgdGhpcyBiZWNhbWUgYSBtYXRjaAogICAgICAgICAgICBjb25zdCBtYXRjaCA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAgICAgLnF1ZXJ5KCJtYXRjaGVzIikKICAgICAgICAgICAgICAgIC53aXRoSW5kZXgoInVzZXJzIiwgKHEpID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBbdXNlcjEsIHVzZXIyXSA9IFthcmdzLnVzZXJJZCwgbGlrZS5saWtlZFVzZXJJZF0uc29ydCgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBxLmVxKCJ1c2VyMUlkIiwgdXNlcjEpLmVxKCJ1c2VyMklkIiwgdXNlcjIpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC5maXJzdCgpOwoKICAgICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IGN0eC5kYi5nZXQobGlrZS5saWtlZFVzZXJJZCk7CgogICAgICAgICAgICBjb25zdCBwcm9maWxlID0gYXdhaXQgY3R4LmRiCiAgICAgICAgICAgICAgICAucXVlcnkoInByb2ZpbGVzIikKICAgICAgICAgICAgICAgIC53aXRoSW5kZXgoInVzZXJJZCIsIChxKSA9PiBxLmVxKCJ1c2VySWQiLCBsaWtlLmxpa2VkVXNlcklkKSkKICAgICAgICAgICAgICAgIC5maXJzdCgpOwoKICAgICAgICAgICAgaWYgKCFwcm9maWxlKSBjb250aW51ZTsKCiAgICAgICAgICAgIGNvbnN0IHBob3RvcyA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAgICAgLnF1ZXJ5KCJwaG90b3MiKQogICAgICAgICAgICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIGxpa2UubGlrZWRVc2VySWQpKQogICAgICAgICAgICAgICAgLmNvbGxlY3QoKTsKCiAgICAgICAgICAgIGNvbnN0IGludGVyZXN0cyA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAgICAgLnF1ZXJ5KCJpbnRlcmVzdHMiKQogICAgICAgICAgICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIGxpa2UubGlrZWRVc2VySWQpKQogICAgICAgICAgICAgICAgLmNvbGxlY3QoKTsKCiAgICAgICAgICAgIGNvbnN0IHNvcnRlZFBob3RvcyA9IHBob3Rvcy5zb3J0KChhLCBiKSA9PiBhLm9yZGVyIC0gYi5vcmRlcik7CgogICAgICAgICAgICBjb25zdCBwcmltYXJ5UGhvdG8gPSBzb3J0ZWRQaG90b3MuZmluZCgocCkgPT4gcC5pc1ByaW1hcnkpIHx8IHNvcnRlZFBob3Rvc1swXTsKCiAgICAgICAgICAgIGxpa2VkUHJvZmlsZXMucHVzaCh7CiAgICAgICAgICAgICAgICBtYXRjaElkOiBtYXRjaD8uX2lkLAogICAgICAgICAgICAgICAgdXNlcklkOiBsaWtlLmxpa2VkVXNlcklkLAogICAgICAgICAgICAgICAgbmFtZTogdXNlcj8ubmFtZSwKICAgICAgICAgICAgICAgIHByaW1hcnlQaG90bzogcHJpbWFyeVBob3RvPy51cmwsCiAgICAgICAgICAgICAgICBwcm9maWxlOiB7CiAgICAgICAgICAgICAgICAgICAgLi4ucHJvZmlsZSwKICAgICAgICAgICAgICAgICAgICBwaG90b3M6IHNvcnRlZFBob3RvcywKICAgICAgICAgICAgICAgICAgICBpbnRlcmVzdHM6IGludGVyZXN0cy5tYXAoKGkpID0+IGkuaW50ZXJlc3QpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGxpa2VkQXQ6IGxpa2UuY3JlYXRlZEF0LAogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBsaWtlZFByb2ZpbGVzOwogICAgfSwKfSk7CgoKLy8gR2V0IG1hdGNoIGJ5IElECmV4cG9ydCBjb25zdCBnZXRNYXRjaEJ5SWQgPSBxdWVyeSh7CiAgICBhcmdzOiB7CiAgICAgICAgbWF0Y2hJZDogdi5pZCgibWF0Y2hlcyIpLAogICAgICAgIHVzZXJJZDogdi5pZCgidXNlcnMiKSwKICAgIH0sCiAgICBoYW5kbGVyOiBhc3luYyAoY3R4LCBhcmdzKSA9PiB7CiAgICAgICAgY29uc3QgbWF0Y2ggPSBhd2FpdCBjdHguZGIuZ2V0KGFyZ3MubWF0Y2hJZCk7CgogICAgICAgIGlmICghbWF0Y2gpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICAvLyBWZXJpZnkgdXNlciBpcyBwYXJ0IG9mIHRoaXMgbWF0Y2gKICAgICAgICBpZiAobWF0Y2gudXNlcjFJZCAhPT0gYXJncy51c2VySWQgJiYgbWF0Y2gudXNlcjJJZCAhPT0gYXJncy51c2VySWQpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICBjb25zdCBvdGhlclVzZXJJZCA9IG1hdGNoLnVzZXIxSWQgPT09IGFyZ3MudXNlcklkID8gbWF0Y2gudXNlcjJJZCA6IG1hdGNoLnVzZXIxSWQ7CgogICAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBjdHguZGIuZ2V0KG90aGVyVXNlcklkKTsKCiAgICAgICAgY29uc3Qgb3RoZXJVc2VyU2V0dGluZ3MgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgLnF1ZXJ5KCJ1c2VyU2V0dGluZ3MiKQogICAgICAgICAgICAud2l0aEluZGV4KCJ1c2VySWQiLCAocSkgPT4gcS5lcSgidXNlcklkIiwgb3RoZXJVc2VySWQpKQogICAgICAgICAgICAuZmlyc3QoKTsKCiAgICAgICAgY29uc3Qgc2hvd09ubGluZVN0YXR1cyA9IG90aGVyVXNlclNldHRpbmdzPy5zaG93T25saW5lU3RhdHVzID8/IHRydWU7CgogICAgICAgIGNvbnN0IHByb2ZpbGUgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgLnF1ZXJ5KCJwcm9maWxlcyIpCiAgICAgICAgICAgIC53aXRoSW5kZXgoInVzZXJJZCIsIChxKSA9PiBxLmVxKCJ1c2VySWQiLCBvdGhlclVzZXJJZCkpCiAgICAgICAgICAgIC5maXJzdCgpOwoKICAgICAgICBpZiAoIXByb2ZpbGUpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICBjb25zdCBwaG90b3MgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgLnF1ZXJ5KCJwaG90b3MiKQogICAgICAgICAgICAud2l0aEluZGV4KCJ1c2VySWQiLCAocSkgPT4gcS5lcSgidXNlcklkIiwgb3RoZXJVc2VySWQpKQogICAgICAgICAgICAuY29sbGVjdCgpOwoKICAgICAgICBjb25zdCBpbnRlcmVzdHMgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgLnF1ZXJ5KCJpbnRlcmVzdHMiKQogICAgICAgICAgICAud2l0aEluZGV4KCJ1c2VySWQiLCAocSkgPT4gcS5lcSgidXNlcklkIiwgb3RoZXJVc2VySWQpKQogICAgICAgICAgICAuY29sbGVjdCgpOwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBtYXRjaElkOiBtYXRjaC5faWQsCiAgICAgICAgICAgIHVzZXJJZDogb3RoZXJVc2VySWQsCiAgICAgICAgICAgIGxhc3RTZWVuQXQ6IHNob3dPbmxpbmVTdGF0dXMgPyB1c2VyPy5sYXN0U2VlbkF0IDogbnVsbCwKICAgICAgICAgICAgc2hvd09ubGluZVN0YXR1cywKICAgICAgICAgICAgcHJvZmlsZTogewogICAgICAgICAgICAgICAgLi4ucHJvZmlsZSwKICAgICAgICAgICAgICAgIG5hbWU6IHVzZXI/Lm5hbWUsCiAgICAgICAgICAgICAgICBwaG90b3M6IHBob3Rvcy5zb3J0KChhLCBiKSA9PiBhLm9yZGVyIC0gYi5vcmRlciksCiAgICAgICAgICAgICAgICBpbnRlcmVzdHM6IGludGVyZXN0cy5tYXAoKGkpID0+IGkuaW50ZXJlc3QpLAogICAgICAgICAgICB9LAogICAgICAgICAgICBtYXRjaGVkQXQ6IG1hdGNoLm1hdGNoZWRBdCwKICAgICAgICB9OwogICAgfSwKfSk7CgovLyBTdXBlci1saWtlIGEgcHJvZmlsZSAocHJlbWl1bSBmZWF0dXJlKQpleHBvcnQgY29uc3Qgc3VwZXJMaWtlUHJvZmlsZSA9IG11dGF0aW9uKHsKICAgIGFyZ3M6IHsKICAgICAgICB1c2VySWQ6IHYuaWQoInVzZXJzIiksCiAgICAgICAgc3VwZXJMaWtlZFVzZXJJZDogdi5pZCgidXNlcnMiKSwKICAgIH0sCiAgICBoYW5kbGVyOiBhc3luYyAoY3R4LCBhcmdzKSA9PiB7CiAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsKCiAgICAgICAgYXdhaXQgY29uc3VtZVN1cGVyTGlrZShjdHgsIGFyZ3MudXNlcklkKTsKCiAgICAgICAgLy8gSWYgYWxyZWFkeSBtYXRjaGVkLCBkbyBub3RoaW5nCiAgICAgICAgY29uc3QgW3VzZXIxLCB1c2VyMl0gPSBbYXJncy51c2VySWQsIGFyZ3Muc3VwZXJMaWtlZFVzZXJJZF0uc29ydCgpOwogICAgICAgIGNvbnN0IGV4aXN0aW5nTWF0Y2ggPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgLnF1ZXJ5KCJtYXRjaGVzIikKICAgICAgICAgICAgLndpdGhJbmRleCgidXNlcnMiLCAocSkgPT4gcS5lcSgidXNlcjFJZCIsIHVzZXIxKS5lcSgidXNlcjJJZCIsIHVzZXIyKSkKICAgICAgICAgICAgLmZpcnN0KCk7CgogICAgICAgIGlmIChleGlzdGluZ01hdGNoKSB7CiAgICAgICAgICAgIHJldHVybiB7IG1hdGNoZWQ6IHRydWUsIG1hdGNoSWQ6IGV4aXN0aW5nTWF0Y2guX2lkIH07CiAgICAgICAgfQoKICAgICAgICAvLyBDaGVjayBpZiBhbHJlYWR5IHN1cGVyLWxpa2VkCiAgICAgICAgY29uc3QgZXhpc3RpbmcgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgLnF1ZXJ5KCJzdXBlckxpa2VzIikKICAgICAgICAgICAgLndpdGhJbmRleCgicGFpciIsIChxKSA9PiBxLmVxKCJ1c2VySWQiLCBhcmdzLnVzZXJJZCkuZXEoInN1cGVyTGlrZWRVc2VySWQiLCBhcmdzLnN1cGVyTGlrZWRVc2VySWQpKQogICAgICAgICAgICAuZmlyc3QoKTsKCiAgICAgICAgaWYgKGV4aXN0aW5nKSB7CiAgICAgICAgICAgIHJldHVybiB7IG1hdGNoZWQ6IGZhbHNlIH07IC8vIEFscmVhZHkgc3VwZXItbGlrZWQKICAgICAgICB9CgogICAgICAgIC8vIENyZWF0ZSBzdXBlci1saWtlCiAgICAgICAgYXdhaXQgY3R4LmRiLmluc2VydCgic3VwZXJMaWtlcyIsIHsKICAgICAgICAgICAgdXNlcklkOiBhcmdzLnVzZXJJZCwKICAgICAgICAgICAgc3VwZXJMaWtlZFVzZXJJZDogYXJncy5zdXBlckxpa2VkVXNlcklkLAogICAgICAgICAgICBjcmVhdGVkQXQ6IG5vdywKICAgICAgICB9KTsKCiAgICAgICAgLy8gQWxzbyBjcmVhdGUgYSByZWd1bGFyIGxpa2UKICAgICAgICBjb25zdCByZWd1bGFyTGlrZSA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAucXVlcnkoImxpa2VzIikKICAgICAgICAgICAgLndpdGhJbmRleCgicGFpciIsIChxKSA9PiBxLmVxKCJ1c2VySWQiLCBhcmdzLnVzZXJJZCkuZXEoImxpa2VkVXNlcklkIiwgYXJncy5zdXBlckxpa2VkVXNlcklkKSkKICAgICAgICAgICAgLmZpcnN0KCk7CgogICAgICAgIGlmICghcmVndWxhckxpa2UpIHsKICAgICAgICAgICAgYXdhaXQgY3R4LmRiLmluc2VydCgibGlrZXMiLCB7CiAgICAgICAgICAgICAgICB1c2VySWQ6IGFyZ3MudXNlcklkLAogICAgICAgICAgICAgICAgbGlrZWRVc2VySWQ6IGFyZ3Muc3VwZXJMaWtlZFVzZXJJZCwKICAgICAgICAgICAgICAgIGNyZWF0ZWRBdDogbm93LAogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIFBob3RvIGFuYWx5dGljczogcmVjb3JkIGxpa2UgYWdhaW5zdCBwcmltYXJ5IHBob3RvCiAgICAgICAgY29uc3QgbGlrZWRQaG90b3MgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgLnF1ZXJ5KCJwaG90b3MiKQogICAgICAgICAgICAud2l0aEluZGV4KCJ1c2VySWQiLCAocSkgPT4gcS5lcSgidXNlcklkIiwgYXJncy5zdXBlckxpa2VkVXNlcklkKSkKICAgICAgICAgICAgLmNvbGxlY3QoKTsKICAgICAgICBjb25zdCBsaWtlZFByaW1hcnkgPSBsaWtlZFBob3Rvcy5maW5kKChwOiBhbnkpID0+IHAuaXNQcmltYXJ5KSB8fCBsaWtlZFBob3Rvcy5zb3J0KChhOiBhbnksIGI6IGFueSkgPT4gYS5vcmRlciAtIGIub3JkZXIpWzBdOwogICAgICAgIGlmIChsaWtlZFByaW1hcnkpIHsKICAgICAgICAgICAgYXdhaXQgdXBkYXRlUGhvdG9BbmFseXRpY3MoY3R4LCBsaWtlZFByaW1hcnkuX2lkLCBhcmdzLnN1cGVyTGlrZWRVc2VySWQsICJsaWtlIik7CiAgICAgICAgfQoKICAgICAgICAvLyBDaGVjayBpZiB0aGV5IGxpa2VkIG1lIGJhY2sgKG11dHVhbCBsaWtlID0gbWF0Y2gpCiAgICAgICAgY29uc3QgdGhlaXJMaWtlID0gYXdhaXQgY3R4LmRiCiAgICAgICAgICAgIC5xdWVyeSgibGlrZXMiKQogICAgICAgICAgICAud2l0aEluZGV4KCJwYWlyIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIGFyZ3Muc3VwZXJMaWtlZFVzZXJJZCkuZXEoImxpa2VkVXNlcklkIiwgYXJncy51c2VySWQpKQogICAgICAgICAgICAuZmlyc3QoKTsKCiAgICAgICAgaWYgKHRoZWlyTGlrZSkgewogICAgICAgICAgICAvLyBDcmVhdGUgbWF0Y2ghCiAgICAgICAgICAgIGNvbnN0IG1hdGNoSWQgPSBhd2FpdCBjdHguZGIuaW5zZXJ0KCJtYXRjaGVzIiwgewogICAgICAgICAgICAgICAgdXNlcjFJZDogdXNlcjEsCiAgICAgICAgICAgICAgICB1c2VyMklkOiB1c2VyMiwKICAgICAgICAgICAgICAgIG1hdGNoZWRBdDogbm93LAogICAgICAgICAgICAgICAgdXNlcjFVbnJlYWQ6IDAsCiAgICAgICAgICAgICAgICB1c2VyMlVucmVhZDogMCwKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBHZXQgdXNlciBuYW1lcyBmb3IgYmV0dGVyIG5vdGlmaWNhdGlvbgogICAgICAgICAgICBjb25zdCBzZW5kZXIgPSBhd2FpdCBjdHguZGIuZ2V0KGFyZ3MudXNlcklkKTsKICAgICAgICAgICAgY29uc3QgcmVjZWl2ZXIgPSBhd2FpdCBjdHguZGIuZ2V0KGFyZ3Muc3VwZXJMaWtlZFVzZXJJZCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBhd2FpdCBpbnNlcnROb3RpZmljYXRpb24oY3R4LCB7CiAgICAgICAgICAgICAgICB1c2VySWQ6IGFyZ3MudXNlcklkLAogICAgICAgICAgICAgICAgdHlwZTogIm1hdGNoIiwKICAgICAgICAgICAgICAgIHRpdGxlOiAiSXQncyBhIE1hdGNoISDwn5KVIiwKICAgICAgICAgICAgICAgIGJvZHk6IGBZb3UgYW5kICR7cmVjZWl2ZXI/Lm5hbWUgfHwgInNvbWVvbmUifSBsaWtlZCBlYWNoIG90aGVyIWAsCiAgICAgICAgICAgICAgICBwcmlvcml0eTogImNyaXRpY2FsIiwKICAgICAgICAgICAgICAgIGNhdGVnb3J5OiAic29jaWFsIiwKICAgICAgICAgICAgICAgIGljb246ICLwn5KVIiwKICAgICAgICAgICAgICAgIHJlbGF0ZWRVc2VySWQ6IGFyZ3Muc3VwZXJMaWtlZFVzZXJJZCwKICAgICAgICAgICAgICAgIHJlbGF0ZWRNYXRjaElkOiBtYXRjaElkLAogICAgICAgICAgICAgICAgbGluazogYC9tYXRjaGVzLyR7bWF0Y2hJZH1gLAogICAgICAgICAgICAgICAgYWN0aW9uQnV0dG9uczogWwogICAgICAgICAgICAgICAgICAgIHsgbGFiZWw6ICJTZW5kIE1lc3NhZ2UiLCBhY3Rpb246ICJuYXZpZ2F0ZSIsIGxpbms6IGAvY2hhdC8ke21hdGNoSWR9YCB9LAogICAgICAgICAgICAgICAgICAgIHsgbGFiZWw6ICJWaWV3IFByb2ZpbGUiLCBhY3Rpb246ICJuYXZpZ2F0ZSIsIGxpbms6IGAvcHJvZmlsZS8ke2FyZ3Muc3VwZXJMaWtlZFVzZXJJZH1gIH0sCiAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgYXdhaXQgaW5zZXJ0Tm90aWZpY2F0aW9uKGN0eCwgewogICAgICAgICAgICAgICAgdXNlcklkOiBhcmdzLnN1cGVyTGlrZWRVc2VySWQsCiAgICAgICAgICAgICAgICB0eXBlOiAibWF0Y2giLAogICAgICAgICAgICAgICAgdGl0bGU6ICJTdXBlciBNYXRjaCEg4q2Q8J+SlSIsCiAgICAgICAgICAgICAgICBib2R5OiBgJHtzZW5kZXI/Lm5hbWUgfHwgIlNvbWVvbmUifSBzdXBlciBsaWtlZCB5b3UgYW5kIHlvdSBtYXRjaGVkIWAsCiAgICAgICAgICAgICAgICBwcmlvcml0eTogImNyaXRpY2FsIiwKICAgICAgICAgICAgICAgIGNhdGVnb3J5OiAic29jaWFsIiwKICAgICAgICAgICAgICAgIGljb246ICLirZAiLAogICAgICAgICAgICAgICAgcmVsYXRlZFVzZXJJZDogYXJncy51c2VySWQsCiAgICAgICAgICAgICAgICByZWxhdGVkTWF0Y2hJZDogbWF0Y2hJZCwKICAgICAgICAgICAgICAgIGxpbms6IGAvbWF0Y2hlcy8ke21hdGNoSWR9YCwKICAgICAgICAgICAgICAgIGFjdGlvbkJ1dHRvbnM6IFsKICAgICAgICAgICAgICAgICAgICB7IGxhYmVsOiAiU2VuZCBNZXNzYWdlIiwgYWN0aW9uOiAibmF2aWdhdGUiLCBsaW5rOiBgL2NoYXQvJHttYXRjaElkfWAgfSwKICAgICAgICAgICAgICAgICAgICB7IGxhYmVsOiAiVmlldyBQcm9maWxlIiwgYWN0aW9uOiAibmF2aWdhdGUiLCBsaW5rOiBgL3Byb2ZpbGUvJHthcmdzLnVzZXJJZH1gIH0sCiAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGF3YWl0IHVwZGF0ZUVsb09uTWF0Y2goY3R4LCBhcmdzLnVzZXJJZCwgYXJncy5zdXBlckxpa2VkVXNlcklkKTsKCiAgICAgICAgICAgIHJldHVybiB7IG1hdGNoZWQ6IHRydWUsIG1hdGNoSWQgfTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB7IG1hdGNoZWQ6IGZhbHNlIH07CiAgICB9LAp9KTsKCi8vIEdldCBwcm9maWxlcyB1c2VyIGhhcyBzdXBlci1saWtlZApleHBvcnQgY29uc3QgZ2V0U3VwZXJMaWtlcyA9IHF1ZXJ5KHsKICAgIGFyZ3M6IHsgdXNlcklkOiB2LmlkKCJ1c2VycyIpIH0sCiAgICBoYW5kbGVyOiBhc3luYyAoY3R4LCBhcmdzKSA9PiB7CiAgICAgICAgY29uc3Qgc3VwZXJMaWtlcyA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAucXVlcnkoInN1cGVyTGlrZXMiKQogICAgICAgICAgICAud2l0aEluZGV4KCJ1c2VySWQiLCAocSkgPT4gcS5lcSgidXNlcklkIiwgYXJncy51c2VySWQpKQogICAgICAgICAgICAuY29sbGVjdCgpOwoKICAgICAgICBjb25zdCBzdXBlckxpa2VkUHJvZmlsZXMgPSBbXTsKICAgICAgICBmb3IgKGNvbnN0IHN1cGVyTGlrZSBvZiBzdXBlckxpa2VzKSB7CiAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoaXMgYmVjYW1lIGEgbWF0Y2gKICAgICAgICAgICAgY29uc3QgbWF0Y2ggPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgICAgIC5xdWVyeSgibWF0Y2hlcyIpCiAgICAgICAgICAgICAgICAud2l0aEluZGV4KCJ1c2VycyIsIChxKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgW3VzZXIxLCB1c2VyMl0gPSBbYXJncy51c2VySWQsIHN1cGVyTGlrZS5zdXBlckxpa2VkVXNlcklkXS5zb3J0KCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHEuZXEoInVzZXIxSWQiLCB1c2VyMSkuZXEoInVzZXIySWQiLCB1c2VyMik7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLmZpcnN0KCk7CgogICAgICAgICAgICBpZiAobWF0Y2gpIGNvbnRpbnVlOyAvLyBTa2lwIG1hdGNoZXMKCiAgICAgICAgICAgIGNvbnN0IHByb2ZpbGUgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgICAgIC5xdWVyeSgicHJvZmlsZXMiKQogICAgICAgICAgICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIHN1cGVyTGlrZS5zdXBlckxpa2VkVXNlcklkKSkKICAgICAgICAgICAgICAgIC5maXJzdCgpOwoKICAgICAgICAgICAgaWYgKCFwcm9maWxlKSBjb250aW51ZTsKCiAgICAgICAgICAgIGNvbnN0IHBob3RvcyA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAgICAgLnF1ZXJ5KCJwaG90b3MiKQogICAgICAgICAgICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIHN1cGVyTGlrZS5zdXBlckxpa2VkVXNlcklkKSkKICAgICAgICAgICAgICAgIC5jb2xsZWN0KCk7CgogICAgICAgICAgICBjb25zdCBwcmltYXJ5UGhvdG8gPSBwaG90b3MuZmluZCgocCkgPT4gcC5pc1ByaW1hcnkpIHx8IHBob3Rvc1swXTsKCiAgICAgICAgICAgIHN1cGVyTGlrZWRQcm9maWxlcy5wdXNoKHsKICAgICAgICAgICAgICAgIHVzZXJJZDogc3VwZXJMaWtlLnN1cGVyTGlrZWRVc2VySWQsCiAgICAgICAgICAgICAgICBhZ2U6IHByb2ZpbGUuYWdlLAogICAgICAgICAgICAgICAgbG9jYXRpb246IHByb2ZpbGUubG9jYXRpb24sCiAgICAgICAgICAgICAgICBwaG90bzogcHJpbWFyeVBob3RvPy51cmwsCiAgICAgICAgICAgICAgICBzdXBlckxpa2VkQXQ6IHN1cGVyTGlrZS5jcmVhdGVkQXQsCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHN1cGVyTGlrZWRQcm9maWxlczsKICAgIH0sCn0pOwoKLy8gR2V0IHVzZXJzIHdobyBzdXBlci1saWtlZCB5b3UKZXhwb3J0IGNvbnN0IGdldFdob1N1cGVyTGlrZWRZb3UgPSBxdWVyeSh7CiAgICBhcmdzOiB7IHVzZXJJZDogdi5pZCgidXNlcnMiKSB9LAogICAgaGFuZGxlcjogYXN5bmMgKGN0eCwgYXJncykgPT4gewogICAgICAgIGNvbnN0IHN1cGVyTGlrZXMgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgLnF1ZXJ5KCJzdXBlckxpa2VzIikKICAgICAgICAgICAgLndpdGhJbmRleCgic3VwZXJMaWtlZFVzZXJJZCIsIChxKSA9PiBxLmVxKCJzdXBlckxpa2VkVXNlcklkIiwgYXJncy51c2VySWQpKQogICAgICAgICAgICAuY29sbGVjdCgpOwoKICAgICAgICBjb25zdCBwcm9maWxlcyA9IFtdOwogICAgICAgIGZvciAoY29uc3Qgc3VwZXJMaWtlIG9mIHN1cGVyTGlrZXMpIHsKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgYWxyZWFkeSBtYXRjaGVkCiAgICAgICAgICAgIGNvbnN0IG1hdGNoID0gYXdhaXQgY3R4LmRiCiAgICAgICAgICAgICAgICAucXVlcnkoIm1hdGNoZXMiKQogICAgICAgICAgICAgICAgLndpdGhJbmRleCgidXNlcnMiLCAocSkgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IFt1c2VyMSwgdXNlcjJdID0gW2FyZ3MudXNlcklkLCBzdXBlckxpa2UudXNlcklkXS5zb3J0KCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHEuZXEoInVzZXIxSWQiLCB1c2VyMSkuZXEoInVzZXIySWQiLCB1c2VyMik7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLmZpcnN0KCk7CgogICAgICAgICAgICBpZiAobWF0Y2gpIGNvbnRpbnVlOyAvLyBTa2lwIG1hdGNoZXMKCiAgICAgICAgICAgIGNvbnN0IHByb2ZpbGUgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgICAgIC5xdWVyeSgicHJvZmlsZXMiKQogICAgICAgICAgICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIHN1cGVyTGlrZS51c2VySWQpKQogICAgICAgICAgICAgICAgLmZpcnN0KCk7CgogICAgICAgICAgICBpZiAoIXByb2ZpbGUpIGNvbnRpbnVlOwoKICAgICAgICAgICAgY29uc3QgcGhvdG9zID0gYXdhaXQgY3R4LmRiCiAgICAgICAgICAgICAgICAucXVlcnkoInBob3RvcyIpCiAgICAgICAgICAgICAgICAud2l0aEluZGV4KCJ1c2VySWQiLCAocSkgPT4gcS5lcSgidXNlcklkIiwgc3VwZXJMaWtlLnVzZXJJZCkpCiAgICAgICAgICAgICAgICAuY29sbGVjdCgpOwoKICAgICAgICAgICAgY29uc3QgcHJpbWFyeVBob3RvID0gcGhvdG9zLmZpbmQoKHApID0+IHAuaXNQcmltYXJ5KSB8fCBwaG90b3NbMF07CgogICAgICAgICAgICBwcm9maWxlcy5wdXNoKHsKICAgICAgICAgICAgICAgIHVzZXJJZDogc3VwZXJMaWtlLnVzZXJJZCwKICAgICAgICAgICAgICAgIGFnZTogcHJvZmlsZS5hZ2UsCiAgICAgICAgICAgICAgICBsb2NhdGlvbjogcHJvZmlsZS5sb2NhdGlvbiwKICAgICAgICAgICAgICAgIHBob3RvOiBwcmltYXJ5UGhvdG8/LnVybCwKICAgICAgICAgICAgICAgIHN1cGVyTGlrZWRBdDogc3VwZXJMaWtlLmNyZWF0ZWRBdCwKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcHJvZmlsZXM7CiAgICB9LAp9KTsKCi8vIFJld2luZCBsYXN0IGFjdGlvbiAodW5kbyBsYXN0IHN3aXBlKQpleHBvcnQgY29uc3QgcmV3aW5kTGFzdEFjdGlvbiA9IG11dGF0aW9uKHsKICAgIGFyZ3M6IHsKICAgICAgICB1c2VySWQ6IHYuaWQoInVzZXJzIiksCiAgICB9LAogICAgaGFuZGxlcjogYXN5bmMgKGN0eCwgYXJncykgPT4gewogICAgICAgIGNvbnN0IGlzUHJlbWl1bSA9IGF3YWl0IGlzVXNlclByZW1pdW0oY3R4LCBhcmdzLnVzZXJJZCk7CiAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsKICAgICAgICBjb25zdCBmaXZlTWludXRlc0FnbyA9IG5vdyAtIDUgKiA2MCAqIDEwMDA7CgogICAgICAgIC8vIEdldCB0aGUgbW9zdCByZWNlbnQgbGlrZSBvciBwYXNzIHdpdGhpbiB0aGUgbGFzdCA1IG1pbnV0ZXMKICAgICAgICBjb25zdCByZWNlbnRMaWtlcyA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAucXVlcnkoImxpa2VzIikKICAgICAgICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIGFyZ3MudXNlcklkKSkKICAgICAgICAgICAgLmNvbGxlY3QoKTsKICAgICAgICAKICAgICAgICBjb25zdCByZWNlbnRQYXNzZXMgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgLnF1ZXJ5KCJwYXNzZXMiKQogICAgICAgICAgICAud2l0aEluZGV4KCJ1c2VySWQiLCAocSkgPT4gcS5lcSgidXNlcklkIiwgYXJncy51c2VySWQpKQogICAgICAgICAgICAuY29sbGVjdCgpOwoKICAgICAgICAvLyBGaWx0ZXIgZm9yIGxhc3QgNSBtaW51dGVzCiAgICAgICAgY29uc3QgcmVjZW50TGlrZXNGaWx0ZXJlZCA9IHJlY2VudExpa2VzLmZpbHRlcihsID0+IGwuY3JlYXRlZEF0ID4gZml2ZU1pbnV0ZXNBZ28pOwogICAgICAgIGNvbnN0IHJlY2VudFBhc3Nlc0ZpbHRlcmVkID0gcmVjZW50UGFzc2VzLmZpbHRlcihwID0+IHAuY3JlYXRlZEF0ID4gZml2ZU1pbnV0ZXNBZ28pOwoKICAgICAgICAvLyBGaW5kIHRoZSBtb3N0IHJlY2VudCBhY3Rpb24KICAgICAgICBjb25zdCBhbGxSZWNlbnQgPSBbCiAgICAgICAgICAgIC4uLnJlY2VudExpa2VzRmlsdGVyZWQubWFwKGwgPT4gKHsgdHlwZTogJ2xpa2UnIGFzIGNvbnN0LCBpdGVtOiBsLCB0aW1lOiBsLmNyZWF0ZWRBdCB9KSksCiAgICAgICAgICAgIC4uLnJlY2VudFBhc3Nlc0ZpbHRlcmVkLm1hcChwID0+ICh7IHR5cGU6ICdwYXNzJyBhcyBjb25zdCwgaXRlbTogcCwgdGltZTogcC5jcmVhdGVkQXQgfSkpCiAgICAgICAgXS5zb3J0KChhLCBiKSA9PiBiLnRpbWUgLSBhLnRpbWUpOwoKICAgICAgICBpZiAoYWxsUmVjZW50Lmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk5vIHJlY2VudCBhY3Rpb25zIHRvIHJld2luZCIpOwogICAgICAgIH0KCiAgICAgICAgY29uc3QgbGFzdEFjdGlvbiA9IGFsbFJlY2VudFswXTsKCiAgICAgICAgLy8gQ2hlY2sgaWYgZnJlZSB1c2VyIGhhcyBhbHJlYWR5IHVzZWQgdGhlaXIgZGFpbHkgcmV3aW5kCiAgICAgICAgaWYgKCFpc1ByZW1pdW0pIHsKICAgICAgICAgICAgY29uc3QgZGF5S2V5ID0gZ2V0RGF5S2V5VXRjKG5vdyk7CiAgICAgICAgICAgIGNvbnN0IHJld2luZHMgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgICAgIC5xdWVyeSgiZGFpbHlVc2FnZSIpCiAgICAgICAgICAgICAgICAud2l0aEluZGV4KCJ1c2VyRGF5IiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIGFyZ3MudXNlcklkKS5lcSgiZGF5S2V5IiwgZGF5S2V5KSkKICAgICAgICAgICAgICAgIC5maXJzdCgpOwoKICAgICAgICAgICAgLy8gRm9yIGZyZWUgdXNlcnMsIGxpbWl0IHRvIDEgcmV3aW5kIHBlciBkYXkgKHdlJ2xsIGFkZCBhIHJld2luZHMgZmllbGQgaWYgbmVlZGVkKQogICAgICAgICAgICAvLyBGb3Igbm93LCB3ZSdsbCBiZSBsZW5pZW50IGFuZCBhbGxvdyBpdAogICAgICAgIH0KCiAgICAgICAgLy8gRGVsZXRlIHRoZSBhY3Rpb24KICAgICAgICBpZiAobGFzdEFjdGlvbi50eXBlID09PSAnbGlrZScpIHsKICAgICAgICAgICAgYXdhaXQgY3R4LmRiLmRlbGV0ZShsYXN0QWN0aW9uLml0ZW0uX2lkKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFsc28gY2hlY2sgaWYgdGhpcyBjcmVhdGVkIGEgbWF0Y2ggYW5kIGRlbGV0ZSBpdAogICAgICAgICAgICBjb25zdCBsaWtlSXRlbSA9IGxhc3RBY3Rpb24uaXRlbSBhcyBhbnk7CiAgICAgICAgICAgIGNvbnN0IFt1c2VyMSwgdXNlcjJdID0gW2FyZ3MudXNlcklkLCBsaWtlSXRlbS5saWtlZFVzZXJJZF0uc29ydCgpOwogICAgICAgICAgICBjb25zdCBtYXRjaCA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAgICAgLnF1ZXJ5KCJtYXRjaGVzIikKICAgICAgICAgICAgICAgIC53aXRoSW5kZXgoInVzZXJzIiwgKHEpID0+IHEuZXEoInVzZXIxSWQiLCB1c2VyMSkuZXEoInVzZXIySWQiLCB1c2VyMikpCiAgICAgICAgICAgICAgICAuZmlyc3QoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAgICAgYXdhaXQgY3R4LmRiLmRlbGV0ZShtYXRjaC5faWQpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYXdhaXQgY3R4LmRiLmRlbGV0ZShsYXN0QWN0aW9uLml0ZW0uX2lkKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTsKICAgIH0sCn0pOwoKLy8gSGVscGVyIGZvciBkYXkga2V5CmZ1bmN0aW9uIGdldERheUtleVV0Yyhub3dNczogbnVtYmVyKSB7CiAgICBjb25zdCBkID0gbmV3IERhdGUobm93TXMpOwogICAgY29uc3QgeSA9IGQuZ2V0VVRDRnVsbFllYXIoKTsKICAgIGNvbnN0IG0gPSBTdHJpbmcoZC5nZXRVVENNb250aCgpICsgMSkucGFkU3RhcnQoMiwgIjAiKTsKICAgIGNvbnN0IGRheSA9IFN0cmluZyhkLmdldFVUQ0RhdGUoKSkucGFkU3RhcnQoMiwgIjAiKTsKICAgIHJldHVybiBgJHt5fS0ke219LSR7ZGF5fWA7Cn0KCi8vIENoZWNrIGlmIHVzZXIgY2FuIHJld2luZApleHBvcnQgY29uc3QgZ2V0UmV3aW5kQXZhaWxhYmlsaXR5ID0gcXVlcnkoewogICAgYXJnczogewogICAgICAgIHVzZXJJZDogdi5pZCgidXNlcnMiKSwKICAgIH0sCiAgICBoYW5kbGVyOiBhc3luYyAoY3R4LCBhcmdzKSA9PiB7CiAgICAgICAgY29uc3QgaXNQcmVtaXVtID0gYXdhaXQgaXNVc2VyUHJlbWl1bShjdHgsIGFyZ3MudXNlcklkKTsKICAgICAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpOwogICAgICAgIGNvbnN0IGZpdmVNaW51dGVzQWdvID0gbm93IC0gNSAqIDYwICogMTAwMDsKCiAgICAgICAgLy8gR2V0IHRoZSBtb3N0IHJlY2VudCBsaWtlIG9yIHBhc3Mgd2l0aGluIHRoZSBsYXN0IDUgbWludXRlcwogICAgICAgIGNvbnN0IHJlY2VudExpa2VzID0gYXdhaXQgY3R4LmRiCiAgICAgICAgICAgIC5xdWVyeSgibGlrZXMiKQogICAgICAgICAgICAud2l0aEluZGV4KCJ1c2VySWQiLCAocSkgPT4gcS5lcSgidXNlcklkIiwgYXJncy51c2VySWQpKQogICAgICAgICAgICAuY29sbGVjdCgpOwogICAgICAgIAogICAgICAgIGNvbnN0IHJlY2VudFBhc3NlcyA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAucXVlcnkoInBhc3NlcyIpCiAgICAgICAgICAgIC53aXRoSW5kZXgoInVzZXJJZCIsIChxKSA9PiBxLmVxKCJ1c2VySWQiLCBhcmdzLnVzZXJJZCkpCiAgICAgICAgICAgIC5jb2xsZWN0KCk7CgogICAgICAgIC8vIEZpbHRlciBmb3IgbGFzdCA1IG1pbnV0ZXMKICAgICAgICBjb25zdCByZWNlbnRMaWtlc0ZpbHRlcmVkID0gcmVjZW50TGlrZXMuZmlsdGVyKGwgPT4gbC5jcmVhdGVkQXQgPiBmaXZlTWludXRlc0Fnbyk7CiAgICAgICAgY29uc3QgcmVjZW50UGFzc2VzRmlsdGVyZWQgPSByZWNlbnRQYXNzZXMuZmlsdGVyKHAgPT4gcC5jcmVhdGVkQXQgPiBmaXZlTWludXRlc0Fnbyk7CgogICAgICAgIGNvbnN0IGhhc1JlY2VudEFjdGlvbiA9IHJlY2VudExpa2VzRmlsdGVyZWQubGVuZ3RoID4gMCB8fCByZWNlbnRQYXNzZXNGaWx0ZXJlZC5sZW5ndGggPiAwOwoKICAgICAgICBpZiAoIWhhc1JlY2VudEFjdGlvbikgewogICAgICAgICAgICByZXR1cm4geyBjYW5SZXdpbmQ6IGZhbHNlLCByZWFzb246ICJObyByZWNlbnQgc3dpcGVzIHRvIHVuZG8iIH07CiAgICAgICAgfQoKICAgICAgICBpZiAoIWlzUHJlbWl1bSkgewogICAgICAgICAgICByZXR1cm4geyBjYW5SZXdpbmQ6IGZhbHNlLCByZWFzb246ICJSZXdpbmQgaXMgYSBQcmVtaXVtIGZlYXR1cmUiIH07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4geyBjYW5SZXdpbmQ6IHRydWUgfTsKICAgIH0sCn0pOwoKLy8gUGhhc2UgMjogR2V0IHVzZXJzIHdobyBsaWtlZCB5b3UKZXhwb3J0IGNvbnN0IGdldFdob0xpa2VkWW91ID0gcXVlcnkoewogICAgYXJnczogewogICAgICAgIHVzZXJJZDogdi5pZCgidXNlcnMiKSwKICAgICAgICBzb3J0Qnk6IHYub3B0aW9uYWwodi51bmlvbih2LmxpdGVyYWwoInJlY2VudCIpLCB2LmxpdGVyYWwoImRpc3RhbmNlIiksIHYubGl0ZXJhbCgic2NvcmUiKSkpLAogICAgfSwKICAgIGhhbmRsZXI6IGFzeW5jIChjdHgsIGFyZ3MpID0+IHsKICAgICAgICBjb25zdCBpc1ByZW1pdW0gPSBhd2FpdCBpc1VzZXJQcmVtaXVtKGN0eCwgYXJncy51c2VySWQpOwogICAgICAgIAogICAgICAgIC8vIEdldCBhbGwgbGlrZXMgcmVjZWl2ZWQgYnkgdGhpcyB1c2VyCiAgICAgICAgY29uc3QgbGlrZXNSZWNlaXZlZCA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAucXVlcnkoImxpa2VzIikKICAgICAgICAgICAgLndpdGhJbmRleCgibGlrZWRVc2VySWQiLCAocSkgPT4gcS5lcSgibGlrZWRVc2VySWQiLCBhcmdzLnVzZXJJZCkpCiAgICAgICAgICAgIC5jb2xsZWN0KCk7CgogICAgICAgIC8vIEdldCB1c2VycyBJJ3ZlIGFscmVhZHkgbWF0Y2hlZCB3aXRoICh0byBleGNsdWRlIHRoZW0pCiAgICAgICAgY29uc3QgbXlNYXRjaGVzID0gYXdhaXQgY3R4LmRiCiAgICAgICAgICAgIC5xdWVyeSgibWF0Y2hlcyIpCiAgICAgICAgICAgIC5maWx0ZXIoKHEpID0+IAogICAgICAgICAgICAgICAgcS5vcigKICAgICAgICAgICAgICAgICAgICBxLmVxKHEuZmllbGQoInVzZXIxSWQiKSwgYXJncy51c2VySWQpLAogICAgICAgICAgICAgICAgICAgIHEuZXEocS5maWVsZCgidXNlcjJJZCIpLCBhcmdzLnVzZXJJZCkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgKQogICAgICAgICAgICAuY29sbGVjdCgpOwogICAgICAgIAogICAgICAgIGNvbnN0IG1hdGNoZWRVc2VySWRzID0gbmV3IFNldCgKICAgICAgICAgICAgbXlNYXRjaGVzLm1hcChtID0+IAogICAgICAgICAgICAgICAgbS51c2VyMUlkID09PSBhcmdzLnVzZXJJZCA/IG0udXNlcjJJZCA6IG0udXNlcjFJZAogICAgICAgICAgICApCiAgICAgICAgKTsKCiAgICAgICAgLy8gRmlsdGVyIG91dCBhbHJlYWR5IG1hdGNoZWQgdXNlcnMKICAgICAgICBjb25zdCB1bm1hdGNoZWRMaWtlcyA9IGxpa2VzUmVjZWl2ZWQuZmlsdGVyKGxpa2UgPT4gIW1hdGNoZWRVc2VySWRzLmhhcyhsaWtlLnVzZXJJZCkpOwoKICAgICAgICAvLyBGcmVlIHVzZXJzIG9ubHkgZ2V0IHRoZSBjb3VudAogICAgICAgIGlmICghaXNQcmVtaXVtKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBjb3VudDogdW5tYXRjaGVkTGlrZXMubGVuZ3RoLAogICAgICAgICAgICAgICAgcHJvZmlsZXM6IFtdLAogICAgICAgICAgICAgICAgaXNQcmVtaXVtOiBmYWxzZSwKICAgICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIC8vIFByZW1pdW0gdXNlcnMgZ2V0IGZ1bGwgcHJvZmlsZXMKICAgICAgICBjb25zdCBteVByb2ZpbGUgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgLnF1ZXJ5KCJwcm9maWxlcyIpCiAgICAgICAgICAgIC53aXRoSW5kZXgoInVzZXJJZCIsIChxKSA9PiBxLmVxKCJ1c2VySWQiLCBhcmdzLnVzZXJJZCkpCiAgICAgICAgICAgIC5maXJzdCgpOwoKICAgICAgICBpZiAoIW15UHJvZmlsZSkgewogICAgICAgICAgICByZXR1cm4geyBjb3VudDogMCwgcHJvZmlsZXM6IFtdLCBpc1ByZW1pdW06IHRydWUgfTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IG15SW50ZXJlc3RzID0gYXdhaXQgY3R4LmRiCiAgICAgICAgICAgIC5xdWVyeSgiaW50ZXJlc3RzIikKICAgICAgICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIGFyZ3MudXNlcklkKSkKICAgICAgICAgICAgLmNvbGxlY3QoKTsKICAgICAgICBjb25zdCBteUludGVyZXN0c0xpc3QgPSBteUludGVyZXN0cy5tYXAoaSA9PiBpLmludGVyZXN0KTsKCiAgICAgICAgLy8gQnVpbGQgcHJvZmlsZSBkYXRhIGZvciBlYWNoIHVzZXIgd2hvIGxpa2VkIHlvdQogICAgICAgIGNvbnN0IHByb2ZpbGVzID0gYXdhaXQgUHJvbWlzZS5hbGwoCiAgICAgICAgICAgIHVubWF0Y2hlZExpa2VzLm1hcChhc3luYyAobGlrZSkgPT4gewogICAgICAgICAgICAgICAgY29uc3QgcHJvZmlsZSA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAgICAgICAgIC5xdWVyeSgicHJvZmlsZXMiKQogICAgICAgICAgICAgICAgICAgIC53aXRoSW5kZXgoInVzZXJJZCIsIChxKSA9PiBxLmVxKCJ1c2VySWQiLCBsaWtlLnVzZXJJZCkpCiAgICAgICAgICAgICAgICAgICAgLmZpcnN0KCk7CgogICAgICAgICAgICAgICAgaWYgKCFwcm9maWxlKSByZXR1cm4gbnVsbDsKCiAgICAgICAgICAgICAgICBjb25zdCB1c2VyID0gYXdhaXQgY3R4LmRiLmdldChsaWtlLnVzZXJJZCk7CiAgICAgICAgICAgICAgICBpZiAoIXVzZXIpIHJldHVybiBudWxsOwoKICAgICAgICAgICAgICAgIGNvbnN0IHBob3RvcyA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAgICAgICAgIC5xdWVyeSgicGhvdG9zIikKICAgICAgICAgICAgICAgICAgICAud2l0aEluZGV4KCJ1c2VySWQiLCAocSkgPT4gcS5lcSgidXNlcklkIiwgbGlrZS51c2VySWQpKQogICAgICAgICAgICAgICAgICAgIC5jb2xsZWN0KCk7CgogICAgICAgICAgICAgICAgY29uc3QgaW50ZXJlc3RzID0gYXdhaXQgY3R4LmRiCiAgICAgICAgICAgICAgICAgICAgLnF1ZXJ5KCJpbnRlcmVzdHMiKQogICAgICAgICAgICAgICAgICAgIC53aXRoSW5kZXgoInVzZXJJZCIsIChxKSA9PiBxLmVxKCJ1c2VySWQiLCBsaWtlLnVzZXJJZCkpCiAgICAgICAgICAgICAgICAgICAgLmNvbGxlY3QoKTsKICAgICAgICAgICAgICAgIGNvbnN0IGludGVyZXN0c0xpc3QgPSBpbnRlcmVzdHMubWFwKGkgPT4gaS5pbnRlcmVzdCk7CgogICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIG11dHVhbCBpbnRlcmVzdHMKICAgICAgICAgICAgICAgIGNvbnN0IG11dHVhbEludGVyZXN0cyA9IG15SW50ZXJlc3RzTGlzdC5maWx0ZXIoaSA9PiBpbnRlcmVzdHNMaXN0LmluY2x1ZGVzKGkpKTsKCiAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgbWF0Y2ggc2NvcmUKICAgICAgICAgICAgICAgIGNvbnN0IG1hdGNoU2NvcmUgPSBjYWxjdWxhdGVNYXRjaFNjb3JlKAogICAgICAgICAgICAgICAgICAgIG15UHJvZmlsZSwKICAgICAgICAgICAgICAgICAgICBteUludGVyZXN0c0xpc3QsCiAgICAgICAgICAgICAgICAgICAgcHJvZmlsZSwKICAgICAgICAgICAgICAgICAgICBpbnRlcmVzdHNMaXN0LAogICAgICAgICAgICAgICAgICAgIHVzZXIubGFzdFNlZW5BdCB8fCBwcm9maWxlLmNyZWF0ZWRBdAogICAgICAgICAgICAgICAgKTsKCiAgICAgICAgICAgICAgICAvLyBDYWxjdWxhdGUgZGlzdGFuY2UgKHNpbXBsaWZpZWQgLSBzYW1lIGxvY2F0aW9uID0gMGttKQogICAgICAgICAgICAgICAgY29uc3QgZGlzdGFuY2UgPSBteVByb2ZpbGUubG9jYXRpb24gPT09IHByb2ZpbGUubG9jYXRpb24gPyAwIDogNTA7CgogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICB1c2VySWQ6IGxpa2UudXNlcklkLAogICAgICAgICAgICAgICAgICAgIG5hbWU6IHVzZXIubmFtZSwKICAgICAgICAgICAgICAgICAgICBhZ2U6IHByb2ZpbGUuYWdlLAogICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uOiBwcm9maWxlLmxvY2F0aW9uLAogICAgICAgICAgICAgICAgICAgIGJpbzogcHJvZmlsZS5iaW8sCiAgICAgICAgICAgICAgICAgICAgcGhvdG9zOiBwaG90b3Muc29ydCgoYSwgYikgPT4gYS5vcmRlciAtIGIub3JkZXIpLm1hcChwID0+IHAudXJsKSwKICAgICAgICAgICAgICAgICAgICBpbnRlcmVzdHM6IGludGVyZXN0c0xpc3QsCiAgICAgICAgICAgICAgICAgICAgbXV0dWFsSW50ZXJlc3RzLAogICAgICAgICAgICAgICAgICAgIG1hdGNoU2NvcmU6IE1hdGgucm91bmQobWF0Y2hTY29yZSksCiAgICAgICAgICAgICAgICAgICAgZGlzdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgbGlrZWRBdDogbGlrZS5jcmVhdGVkQXQsCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9KQogICAgICAgICk7CgogICAgICAgIGNvbnN0IHZhbGlkUHJvZmlsZXMgPSBwcm9maWxlcy5maWx0ZXIocCA9PiBwICE9PSBudWxsKTsKCiAgICAgICAgLy8gU29ydCBieSBwcmVmZXJlbmNlCiAgICAgICAgY29uc3Qgc29ydEJ5ID0gYXJncy5zb3J0QnkgfHwgInJlY2VudCI7CiAgICAgICAgaWYgKHNvcnRCeSA9PT0gInJlY2VudCIpIHsKICAgICAgICAgICAgdmFsaWRQcm9maWxlcy5zb3J0KChhLCBiKSA9PiAoYj8ubGlrZWRBdCB8fCAwKSAtIChhPy5saWtlZEF0IHx8IDApKTsKICAgICAgICB9IGVsc2UgaWYgKHNvcnRCeSA9PT0gImRpc3RhbmNlIikgewogICAgICAgICAgICB2YWxpZFByb2ZpbGVzLnNvcnQoKGEsIGIpID0+IChhPy5kaXN0YW5jZSB8fCAwKSAtIChiPy5kaXN0YW5jZSB8fCAwKSk7CiAgICAgICAgfSBlbHNlIGlmIChzb3J0QnkgPT09ICJzY29yZSIpIHsKICAgICAgICAgICAgdmFsaWRQcm9maWxlcy5zb3J0KChhLCBiKSA9PiAoYj8ubWF0Y2hTY29yZSB8fCAwKSAtIChhPy5tYXRjaFNjb3JlIHx8IDApKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGNvdW50OiB2YWxpZFByb2ZpbGVzLmxlbmd0aCwKICAgICAgICAgICAgcHJvZmlsZXM6IHZhbGlkUHJvZmlsZXMsCiAgICAgICAgICAgIGlzUHJlbWl1bTogdHJ1ZSwKICAgICAgICB9OwogICAgfSwKfSk7CgovLyBQaGFzZSAyOiBUcmFjayBhY3Rpb24gZm9yIHJld2luZCBjYXBhYmlsaXR5CmV4cG9ydCBjb25zdCB0cmFja0FjdGlvbiA9IG11dGF0aW9uKHsKICAgIGFyZ3M6IHsKICAgICAgICB1c2VySWQ6IHYuaWQoInVzZXJzIiksCiAgICAgICAgYWN0aW9uOiB2LnVuaW9uKHYubGl0ZXJhbCgibGlrZSIpLCB2LmxpdGVyYWwoInBhc3MiKSwgdi5saXRlcmFsKCJzdXBlckxpa2UiKSksCiAgICAgICAgdGFyZ2V0VXNlcklkOiB2LmlkKCJ1c2VycyIpLAogICAgfSwKICAgIGhhbmRsZXI6IGFzeW5jIChjdHgsIGFyZ3MpID0+IHsKICAgICAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpOwogICAgICAgIAogICAgICAgIC8vIFN0b3JlIGFjdGlvbiBpbiBoaXN0b3J5IChrZWVwIGxhc3QgMTAgYWN0aW9ucykKICAgICAgICBhd2FpdCBjdHguZGIuaW5zZXJ0KCJhY3Rpb25IaXN0b3J5IiwgewogICAgICAgICAgICB1c2VySWQ6IGFyZ3MudXNlcklkLAogICAgICAgICAgICBhY3Rpb246IGFyZ3MuYWN0aW9uLAogICAgICAgICAgICB0YXJnZXRVc2VySWQ6IGFyZ3MudGFyZ2V0VXNlcklkLAogICAgICAgICAgICB0aW1lc3RhbXA6IG5vdywKICAgICAgICAgICAgY2FuUmV3aW5kOiB0cnVlLAogICAgICAgIH0pOwoKICAgICAgICAvLyBDbGVhbiB1cCBvbGQgYWN0aW9ucyAoa2VlcCBvbmx5IGxhc3QgMTApCiAgICAgICAgY29uc3QgYWxsQWN0aW9ucyA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAucXVlcnkoImFjdGlvbkhpc3RvcnkiKQogICAgICAgICAgICAud2l0aEluZGV4KCJ1c2VySWQiLCAocSkgPT4gcS5lcSgidXNlcklkIiwgYXJncy51c2VySWQpKQogICAgICAgICAgICAuY29sbGVjdCgpOwoKICAgICAgICBjb25zdCBzb3J0ZWRBY3Rpb25zID0gYWxsQWN0aW9ucy5zb3J0KChhLCBiKSA9PiBiLnRpbWVzdGFtcCAtIGEudGltZXN0YW1wKTsKICAgICAgICAKICAgICAgICAvLyBEZWxldGUgYWN0aW9ucyBiZXlvbmQgdGhlIGxhc3QgMTAKICAgICAgICBmb3IgKGxldCBpID0gMTA7IGkgPCBzb3J0ZWRBY3Rpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGF3YWl0IGN0eC5kYi5kZWxldGUoc29ydGVkQWN0aW9uc1tpXS5faWQpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9OwogICAgfSwKfSk7CgovLyBQaGFzZSAzOiBHZXQgVG9wIFBpY2tzIC0gRGFpbHkgY3VyYXRlZCBtYXRjaGVzCmV4cG9ydCBjb25zdCBnZXRUb3BQaWNrcyA9IHF1ZXJ5KHsKICAgIGFyZ3M6IHsgdXNlcklkOiB2LmlkKCJ1c2VycyIpIH0sCiAgICBoYW5kbGVyOiBhc3luYyAoY3R4LCBhcmdzKSA9PiB7CiAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsKICAgICAgICBjb25zdCBpc1ByZW1pdW0gPSBhd2FpdCBpc1VzZXJQcmVtaXVtKGN0eCwgYXJncy51c2VySWQpOwogICAgICAgIGNvbnN0IGxpbWl0ID0gaXNQcmVtaXVtID8gMTAgOiAzOyAvLyBQcmVtaXVtIGdldHMgMTAsIGZyZWUgZ2V0cyAzCgogICAgICAgIC8vIENoZWNrIGlmIHdlIGhhdmUgYSBjYWNoZWQgdmVyc2lvbiB0aGF0J3Mgc3RpbGwgdmFsaWQgKGV4cGlyZXMgYXQgbWlkbmlnaHQpCiAgICAgICAgY29uc3QgY2FjaGUgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgLnF1ZXJ5KCJ0b3BQaWNrc0NhY2hlIikKICAgICAgICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIGFyZ3MudXNlcklkKSkKICAgICAgICAgICAgLmZpcnN0KCk7CgogICAgICAgIGlmIChjYWNoZSAmJiBjYWNoZS5leHBpcmVzQXQgPiBub3cpIHsKICAgICAgICAgICAgLy8gUmV0dXJuIGNhY2hlZCBwaWNrcwogICAgICAgICAgICBjb25zdCBwcm9maWxlcyA9IFtdOwogICAgICAgICAgICBmb3IgKGNvbnN0IHBpY2tVc2VySWQgb2YgY2FjaGUucGlja3Muc2xpY2UoMCwgbGltaXQpKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwcm9maWxlID0gYXdhaXQgY3R4LmRiCiAgICAgICAgICAgICAgICAgICAgLnF1ZXJ5KCJwcm9maWxlcyIpCiAgICAgICAgICAgICAgICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIHBpY2tVc2VySWQpKQogICAgICAgICAgICAgICAgICAgIC5maXJzdCgpOwoKICAgICAgICAgICAgICAgIGlmICghcHJvZmlsZSkgY29udGludWU7CgogICAgICAgICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IGN0eC5kYi5nZXQocGlja1VzZXJJZCk7CiAgICAgICAgICAgICAgICBjb25zdCBwaG90b3MgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgICAgICAgICAucXVlcnkoInBob3RvcyIpCiAgICAgICAgICAgICAgICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIHBpY2tVc2VySWQpKQogICAgICAgICAgICAgICAgICAgIC5jb2xsZWN0KCk7CgogICAgICAgICAgICAgICAgY29uc3QgaW50ZXJlc3RzID0gYXdhaXQgY3R4LmRiCiAgICAgICAgICAgICAgICAgICAgLnF1ZXJ5KCJpbnRlcmVzdHMiKQogICAgICAgICAgICAgICAgICAgIC53aXRoSW5kZXgoInVzZXJJZCIsIChxKSA9PiBxLmVxKCJ1c2VySWQiLCBwaWNrVXNlcklkKSkKICAgICAgICAgICAgICAgICAgICAuY29sbGVjdCgpOwoKICAgICAgICAgICAgICAgIHByb2ZpbGVzLnB1c2goewogICAgICAgICAgICAgICAgICAgIC4uLnByb2ZpbGUsCiAgICAgICAgICAgICAgICAgICAgbmFtZTogdXNlcj8ubmFtZSwKICAgICAgICAgICAgICAgICAgICBwaG90b3M6IHBob3Rvcy5zb3J0KChhLCBiKSA9PiBhLm9yZGVyIC0gYi5vcmRlciksCiAgICAgICAgICAgICAgICAgICAgaW50ZXJlc3RzOiBpbnRlcmVzdHMubWFwKChpKSA9PiBpLmludGVyZXN0KSwKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4geyBwcm9maWxlcywgcmVmcmVzaGVzQXQ6IGNhY2hlLmV4cGlyZXNBdCB9OwogICAgICAgIH0KCiAgICAgICAgLy8gR2VuZXJhdGUgbmV3IHBpY2tzCiAgICAgICAgY29uc3QgbXlQcm9maWxlID0gYXdhaXQgY3R4LmRiCiAgICAgICAgICAgIC5xdWVyeSgicHJvZmlsZXMiKQogICAgICAgICAgICAud2l0aEluZGV4KCJ1c2VySWQiLCAocSkgPT4gcS5lcSgidXNlcklkIiwgYXJncy51c2VySWQpKQogICAgICAgICAgICAuZmlyc3QoKTsKCiAgICAgICAgaWYgKCFteVByb2ZpbGUpIHsKICAgICAgICAgICAgcmV0dXJuIHsgcHJvZmlsZXM6IFtdLCByZWZyZXNoZXNBdDogMCB9OwogICAgICAgIH0KCiAgICAgICAgLy8gR2V0IG15IGludGVyZXN0cwogICAgICAgIGNvbnN0IG15SW50ZXJlc3RzID0gYXdhaXQgY3R4LmRiCiAgICAgICAgICAgIC5xdWVyeSgiaW50ZXJlc3RzIikKICAgICAgICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIGFyZ3MudXNlcklkKSkKICAgICAgICAgICAgLmNvbGxlY3QoKTsKICAgICAgICBjb25zdCBteUludGVyZXN0c0xpc3QgPSBteUludGVyZXN0cy5tYXAoKGkpID0+IGkuaW50ZXJlc3QpOwoKICAgICAgICAvLyBHZXQgdXNlcnMgSSd2ZSBhbHJlYWR5IGludGVyYWN0ZWQgd2l0aAogICAgICAgIGNvbnN0IG15TGlrZXMgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgLnF1ZXJ5KCJsaWtlcyIpCiAgICAgICAgICAgIC53aXRoSW5kZXgoInVzZXJJZCIsIChxKSA9PiBxLmVxKCJ1c2VySWQiLCBhcmdzLnVzZXJJZCkpCiAgICAgICAgICAgIC5jb2xsZWN0KCk7CiAgICAgICAgY29uc3QgbGlrZWRVc2VySWRzID0gbmV3IFNldChteUxpa2VzLm1hcCgobCkgPT4gbC5saWtlZFVzZXJJZCkpOwoKICAgICAgICBjb25zdCBteVBhc3NlcyA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAucXVlcnkoInBhc3NlcyIpCiAgICAgICAgICAgIC53aXRoSW5kZXgoInVzZXJJZCIsIChxKSA9PiBxLmVxKCJ1c2VySWQiLCBhcmdzLnVzZXJJZCkpCiAgICAgICAgICAgIC5jb2xsZWN0KCk7CiAgICAgICAgY29uc3QgcGFzc2VkVXNlcklkcyA9IG5ldyBTZXQobXlQYXNzZXMubWFwKChwKSA9PiBwLnBhc3NlZFVzZXJJZCkpOwoKICAgICAgICBjb25zdCBteUJsb2NrcyA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAucXVlcnkoImJsb2NrcyIpCiAgICAgICAgICAgIC53aXRoSW5kZXgoImJsb2NrZXJJZCIsIChxKSA9PiBxLmVxKCJibG9ja2VySWQiLCBhcmdzLnVzZXJJZCkpCiAgICAgICAgICAgIC5jb2xsZWN0KCk7CiAgICAgICAgY29uc3QgYmxvY2tlZEJ5TWUgPSBuZXcgU2V0KG15QmxvY2tzLm1hcCgoYikgPT4gYi5ibG9ja2VkVXNlcklkKSk7CgogICAgICAgIGNvbnN0IGJsb2Nrc09uTWUgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgLnF1ZXJ5KCJibG9ja3MiKQogICAgICAgICAgICAud2l0aEluZGV4KCJibG9ja2VkVXNlcklkIiwgKHEpID0+IHEuZXEoImJsb2NrZWRVc2VySWQiLCBhcmdzLnVzZXJJZCkpCiAgICAgICAgICAgIC5jb2xsZWN0KCk7CiAgICAgICAgY29uc3QgYmxvY2tlZE1lID0gbmV3IFNldChibG9ja3NPbk1lLm1hcCgoYikgPT4gYi5ibG9ja2VySWQpKTsKCiAgICAgICAgLy8gR2V0IGFsbCBwb3RlbnRpYWwgcHJvZmlsZXMKICAgICAgICBjb25zdCBhbGxQcm9maWxlcyA9IGF3YWl0IGN0eC5kYi5xdWVyeSgicHJvZmlsZXMiKS5jb2xsZWN0KCk7CgogICAgICAgIGNvbnN0IGNhbmRpZGF0ZXMgPSBbXTsKICAgICAgICBmb3IgKGNvbnN0IHByb2ZpbGUgb2YgYWxsUHJvZmlsZXMpIHsKICAgICAgICAgICAgaWYgKHByb2ZpbGUudXNlcklkID09PSBhcmdzLnVzZXJJZCkgY29udGludWU7CiAgICAgICAgICAgIGlmIChsaWtlZFVzZXJJZHMuaGFzKHByb2ZpbGUudXNlcklkKSkgY29udGludWU7CiAgICAgICAgICAgIGlmIChwYXNzZWRVc2VySWRzLmhhcyhwcm9maWxlLnVzZXJJZCkpIGNvbnRpbnVlOwogICAgICAgICAgICBpZiAoYmxvY2tlZEJ5TWUuaGFzKHByb2ZpbGUudXNlcklkKSkgY29udGludWU7CiAgICAgICAgICAgIGlmIChibG9ja2VkTWUuaGFzKHByb2ZpbGUudXNlcklkKSkgY29udGludWU7CgogICAgICAgICAgICBjb25zdCB1c2VyID0gYXdhaXQgY3R4LmRiLmdldChwcm9maWxlLnVzZXJJZCk7CiAgICAgICAgICAgIGNvbnN0IHBob3RvcyA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAgICAgLnF1ZXJ5KCJwaG90b3MiKQogICAgICAgICAgICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIHByb2ZpbGUudXNlcklkKSkKICAgICAgICAgICAgICAgIC5jb2xsZWN0KCk7CgogICAgICAgICAgICBjb25zdCBpbnRlcmVzdHMgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgICAgIC5xdWVyeSgiaW50ZXJlc3RzIikKICAgICAgICAgICAgICAgIC53aXRoSW5kZXgoInVzZXJJZCIsIChxKSA9PiBxLmVxKCJ1c2VySWQiLCBwcm9maWxlLnVzZXJJZCkpCiAgICAgICAgICAgICAgICAuY29sbGVjdCgpOwogICAgICAgICAgICBjb25zdCBjYW5kaWRhdGVJbnRlcmVzdHMgPSBpbnRlcmVzdHMubWFwKChpKSA9PiBpLmludGVyZXN0KTsKCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBjb21wYXRpYmlsaXR5IHNjb3JlIHdpdGggZW5oYW5jZWQgYWxnb3JpdGhtCiAgICAgICAgICAgIGxldCBzY29yZSA9IDA7CgogICAgICAgICAgICAvLyAxLiBNdXR1YWwgaW50ZXJlc3RzICg0MCUpCiAgICAgICAgICAgIGNvbnN0IGNvbW1vbkludGVyZXN0cyA9IG15SW50ZXJlc3RzTGlzdC5maWx0ZXIoaSA9PiBjYW5kaWRhdGVJbnRlcmVzdHMuaW5jbHVkZXMoaSkpOwogICAgICAgICAgICBjb25zdCBpbnRlcmVzdFNjb3JlID0gY29tbW9uSW50ZXJlc3RzLmxlbmd0aCAvIE1hdGgubWF4KG15SW50ZXJlc3RzTGlzdC5sZW5ndGgsIDEpOwogICAgICAgICAgICBzY29yZSArPSBpbnRlcmVzdFNjb3JlICogNDA7CgogICAgICAgICAgICAvLyAyLiBTaW1pbGFyIGFnZSAoMjAlKQogICAgICAgICAgICBjb25zdCBhZ2VEaWZmID0gTWF0aC5hYnMobXlQcm9maWxlLmFnZSAtIHByb2ZpbGUuYWdlKTsKICAgICAgICAgICAgY29uc3QgYWdlU2NvcmUgPSBNYXRoLm1heCgwLCAxIC0gKGFnZURpZmYgLyAyMCkpOyAvLyBQZXJmZWN0IGF0IDAgZGlmZiwgMCBhdCAyMCsgZGlmZgogICAgICAgICAgICBzY29yZSArPSBhZ2VTY29yZSAqIDIwOwoKICAgICAgICAgICAgLy8gMy4gRGlzdGFuY2UvTG9jYXRpb24gKDIwJSkKICAgICAgICAgICAgaWYgKG15UHJvZmlsZS5sb2NhdGlvbiA9PT0gcHJvZmlsZS5sb2NhdGlvbikgewogICAgICAgICAgICAgICAgc2NvcmUgKz0gMjA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzY29yZSArPSAxMDsgLy8gRGlmZmVyZW50IGxvY2F0aW9uIGdldHMgaGFsZgogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA0LiBBY3Rpdml0eSBsZXZlbCAoMTAlKQogICAgICAgICAgICBjb25zdCBzZXZlbkRheXNBZ28gPSBub3cgLSA3ICogMjQgKiA2MCAqIDYwICogMTAwMDsKICAgICAgICAgICAgaWYgKCh1c2VyPy5sYXN0U2VlbkF0IHx8IDApID4gc2V2ZW5EYXlzQWdvKSB7CiAgICAgICAgICAgICAgICBzY29yZSArPSAxMDsKICAgICAgICAgICAgfSBlbHNlIGlmICgodXNlcj8ubGFzdFNlZW5BdCB8fCAwKSA+IHNldmVuRGF5c0FnbyAtIDcgKiAyNCAqIDYwICogNjAgKiAxMDAwKSB7CiAgICAgICAgICAgICAgICBzY29yZSArPSA1OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyA1LiBQcm9maWxlIHF1YWxpdHkgKDEwJSkKICAgICAgICAgICAgY29uc3QgcXVhbGl0eVNjb3JlID0gKHByb2ZpbGUuY29tcGxldGVuZXNzIHx8IDApIC8gMTAwOwogICAgICAgICAgICBzY29yZSArPSBxdWFsaXR5U2NvcmUgKiAxMDsKCiAgICAgICAgICAgIGNhbmRpZGF0ZXMucHVzaCh7CiAgICAgICAgICAgICAgICB1c2VySWQ6IHByb2ZpbGUudXNlcklkLAogICAgICAgICAgICAgICAgc2NvcmUsCiAgICAgICAgICAgICAgICBjb21tb25JbnRlcmVzdHMsCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gU29ydCBieSBzY29yZSBhbmQgdGFrZSB0b3AgcGlja3MKICAgICAgICBjYW5kaWRhdGVzLnNvcnQoKGEsIGIpID0+IGIuc2NvcmUgLSBhLnNjb3JlKTsKICAgICAgICBjb25zdCB0b3BQaWNrVXNlcklkcyA9IGNhbmRpZGF0ZXMuc2xpY2UoMCwgMTApLm1hcChjID0+IGMudXNlcklkKTsKCiAgICAgICAgLy8gQ2FjaGUgdGhlIHJlc3VsdHMgdW50aWwgZW5kIG9mIGRheSAobm8gd3JpdGVzIGluIHF1ZXJ5KQogICAgICAgIGNvbnN0IGVuZE9mRGF5ID0gbmV3IERhdGUoKTsKICAgICAgICBlbmRPZkRheS5zZXRIb3VycygyMywgNTksIDU5LCA5OTkpOwogICAgICAgIGNvbnN0IGV4cGlyZXNBdCA9IGVuZE9mRGF5LmdldFRpbWUoKTsKCiAgICAgICAgLy8gQnVpbGQgZnVsbCBwcm9maWxlcyBmb3IgcmV0dXJuCiAgICAgICAgY29uc3QgcHJvZmlsZXMgPSBbXTsKICAgICAgICBmb3IgKGNvbnN0IHBpY2tVc2VySWQgb2YgdG9wUGlja1VzZXJJZHMuc2xpY2UoMCwgbGltaXQpKSB7CiAgICAgICAgICAgIGNvbnN0IHByb2ZpbGUgPSBhd2FpdCBjdHguZGIKICAgICAgICAgICAgICAgIC5xdWVyeSgicHJvZmlsZXMiKQogICAgICAgICAgICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIHBpY2tVc2VySWQpKQogICAgICAgICAgICAgICAgLmZpcnN0KCk7CgogICAgICAgICAgICBpZiAoIXByb2ZpbGUpIGNvbnRpbnVlOwoKICAgICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IGN0eC5kYi5nZXQocGlja1VzZXJJZCk7CiAgICAgICAgICAgIGNvbnN0IHBob3RvcyA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAgICAgLnF1ZXJ5KCJwaG90b3MiKQogICAgICAgICAgICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIHBpY2tVc2VySWQpKQogICAgICAgICAgICAgICAgLmNvbGxlY3QoKTsKCiAgICAgICAgICAgIGNvbnN0IGludGVyZXN0cyA9IGF3YWl0IGN0eC5kYgogICAgICAgICAgICAgICAgLnF1ZXJ5KCJpbnRlcmVzdHMiKQogICAgICAgICAgICAgICAgLndpdGhJbmRleCgidXNlcklkIiwgKHEpID0+IHEuZXEoInVzZXJJZCIsIHBpY2tVc2VySWQpKQogICAgICAgICAgICAgICAgLmNvbGxlY3QoKTsKCiAgICAgICAgICAgIGNvbnN0IGNhbmRpZGF0ZSA9IGNhbmRpZGF0ZXMuZmluZChjID0+IGMudXNlcklkID09PSBwaWNrVXNlcklkKTsKCiAgICAgICAgICAgIHByb2ZpbGVzLnB1c2goewogICAgICAgICAgICAgICAgLi4ucHJvZmlsZSwKICAgICAgICAgICAgICAgIG5hbWU6IHVzZXI/Lm5hbWUsCiAgICAgICAgICAgICAgICBwaG90b3M6IHBob3Rvcy5zb3J0KChhLCBiKSA9PiBhLm9yZGVyIC0gYi5vcmRlciksCiAgICAgICAgICAgICAgICBpbnRlcmVzdHM6IGludGVyZXN0cy5tYXAoKGkpID0+IGkuaW50ZXJlc3QpLAogICAgICAgICAgICAgICAgbWF0Y2hTY29yZTogTWF0aC5yb3VuZChjYW5kaWRhdGU/LnNjb3JlIHx8IDApLAogICAgICAgICAgICAgICAgbWF0Y2hSZWFzb246IGNhbmRpZGF0ZSAmJiBjYW5kaWRhdGUuY29tbW9uSW50ZXJlc3RzLmxlbmd0aCA+IDAKICAgICAgICAgICAgICAgICAgICA/IGBZb3UgYm90aCBsb3ZlICR7Y2FuZGlkYXRlLmNvbW1vbkludGVyZXN0c1swXX1gCiAgICAgICAgICAgICAgICAgICAgOiBgR3JlYXQgbWF0Y2ggcG90ZW50aWFsIWAsCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsgcHJvZmlsZXMsIHJlZnJlc2hlc0F0OiBleHBpcmVzQXQgfTsKICAgIH0sCn0pOwoK"}