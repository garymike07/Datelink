<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Push Notification Diagnostics</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 500px;
            overflow-y: auto;
            margin: 20px 0;
            line-height: 1.6;
        }
        .log-entry {
            margin: 8px 0;
            padding: 6px;
            border-left: 3px solid #555;
            padding-left: 12px;
        }
        .log-entry.info { border-color: #3498db; color: #61dafb; }
        .log-entry.success { border-color: #2ecc71; color: #4ade80; }
        .log-entry.error { border-color: #e74c3c; color: #f87171; }
        .log-entry.warn { border-color: #f39c12; color: #fbbf24; }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background 0.3s;
        }
        button:hover { background: #2980b9; }
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .status-badge.ok { background: #d4edda; color: #155724; }
        .status-badge.fail { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Push Notification Diagnostics</h1>
        <p>This tool will help diagnose why push notifications are failing.</p>
        
        <div>
            <button onclick="runFullDiagnostics()">Run Full Diagnostics</button>
            <button onclick="testSubscribe()">Test Subscribe</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>
        
        <div id="log" class="log"></div>
    </div>

    <script>
        const VAPID_PUBLIC_KEY = 'BOPJiExCGVp5Mbi1Mr7Hzcn2HRVX2J7CKvYQWS5Bo0vpvfJhRn09g_l-zMgm3b1jYHnCB0nPh-5zF6gHrd7M0Bc';
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
            const base64 = (base64String + padding)
                .replace(/-/g, '+')
                .replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        async function runFullDiagnostics() {
            clearLog();
            log('üöÄ Starting full diagnostics...', 'info');
            log('', 'info');

            // Check 1: Browser Support
            log('=== STEP 1: Browser Support ===', 'info');
            const hasServiceWorker = 'serviceWorker' in navigator;
            log(`Service Worker: ${hasServiceWorker ? '‚úÖ Supported' : '‚ùå Not Supported'}`, hasServiceWorker ? 'success' : 'error');
            
            const hasPushManager = 'PushManager' in window;
            log(`Push Manager: ${hasPushManager ? '‚úÖ Supported' : '‚ùå Not Supported'}`, hasPushManager ? 'success' : 'error');
            
            const hasNotification = 'Notification' in window;
            log(`Notifications: ${hasNotification ? '‚úÖ Supported' : '‚ùå Not Supported'}`, hasNotification ? 'success' : 'error');
            
            if (!hasServiceWorker || !hasPushManager || !hasNotification) {
                log('‚ùå Browser does not support push notifications', 'error');
                return;
            }
            log('', 'info');

            // Check 2: Notification Permission
            log('=== STEP 2: Notification Permission ===', 'info');
            log(`Current permission: ${Notification.permission}`, 'info');
            
            if (Notification.permission === 'denied') {
                log('‚ùå Notification permission is DENIED. You need to reset site permissions in browser settings.', 'error');
                return;
            }
            
            if (Notification.permission !== 'granted') {
                log('‚ö†Ô∏è  Requesting permission...', 'warn');
                try {
                    const permission = await Notification.requestPermission();
                    log(`Permission result: ${permission}`, permission === 'granted' ? 'success' : 'error');
                    if (permission !== 'granted') {
                        log('‚ùå Permission not granted', 'error');
                        return;
                    }
                } catch (error) {
                    log(`‚ùå Permission request failed: ${error.message}`, 'error');
                    return;
                }
            } else {
                log('‚úÖ Permission already granted', 'success');
            }
            log('', 'info');

            // Check 3: VAPID Key
            log('=== STEP 3: VAPID Configuration ===', 'info');
            log(`VAPID Key: ${VAPID_PUBLIC_KEY.substring(0, 40)}...`, 'info');
            
            if (VAPID_PUBLIC_KEY === 'PLACEHOLDER_VAPID_KEY' || !VAPID_PUBLIC_KEY) {
                log('‚ùå VAPID key is not configured!', 'error');
                return;
            }
            
            try {
                const keyArray = urlBase64ToUint8Array(VAPID_PUBLIC_KEY);
                log(`‚úÖ VAPID key decoded successfully (${keyArray.length} bytes)`, 'success');
            } catch (error) {
                log(`‚ùå Invalid VAPID key format: ${error.message}`, 'error');
                return;
            }
            log('', 'info');

            // Check 4: Service Worker Registration
            log('=== STEP 4: Service Worker Registration ===', 'info');
            try {
                log('Registering service worker...', 'info');
                const registration = await navigator.serviceWorker.register('/sw.js', {
                    scope: '/'
                });
                log(`‚úÖ Service worker registered: ${registration.scope}`, 'success');
                
                log('Waiting for service worker to be ready...', 'info');
                const readyRegistration = await navigator.serviceWorker.ready;
                log('‚úÖ Service worker is ready', 'success');
                
                // Check service worker state
                if (readyRegistration.active) {
                    log(`Service worker state: ${readyRegistration.active.state}`, 'success');
                }
            } catch (error) {
                log(`‚ùå Service worker registration failed: ${error.message}`, 'error');
                log(`Error details: ${JSON.stringify(error, null, 2)}`, 'error');
                return;
            }
            log('', 'info');

            // Check 5: Push Subscription
            log('=== STEP 5: Push Subscription ===', 'info');
            try {
                const registration = await navigator.serviceWorker.ready;
                
                // Check for existing subscription
                let subscription = await registration.pushManager.getSubscription();
                if (subscription) {
                    log('‚ö†Ô∏è  Found existing subscription', 'warn');
                    log(`Endpoint: ${subscription.endpoint.substring(0, 60)}...`, 'info');
                    log('Unsubscribing old subscription...', 'info');
                    await subscription.unsubscribe();
                    log('‚úÖ Old subscription removed', 'success');
                }
                
                log('Creating new push subscription...', 'info');
                const applicationServerKey = urlBase64ToUint8Array(VAPID_PUBLIC_KEY);
                
                subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: applicationServerKey
                });
                
                log('‚úÖ Push subscription created successfully!', 'success');
                log(`Endpoint: ${subscription.endpoint.substring(0, 60)}...`, 'info');
                
                const subJSON = subscription.toJSON();
                log(`Keys present: auth=${!!subJSON.keys?.auth}, p256dh=${!!subJSON.keys?.p256dh}`, 'success');
                
                log('', 'info');
                log('üéâ ALL DIAGNOSTICS PASSED! Push notifications should work.', 'success');
                
            } catch (error) {
                log(`‚ùå Push subscription failed: ${error.name}`, 'error');
                log(`Error message: ${error.message}`, 'error');
                log(`Error stack: ${error.stack}`, 'error');
                
                if (error.name === 'NotAllowedError') {
                    log('üí° This usually means permission was denied or revoked', 'warn');
                } else if (error.name === 'NotSupportedError') {
                    log('üí° Push notifications may not be supported in this context (http vs https)', 'warn');
                } else if (error.name === 'InvalidStateError') {
                    log('üí° Service worker may not be in the correct state', 'warn');
                }
            }
        }

        async function testSubscribe() {
            clearLog();
            log('Testing subscription process (simplified)...', 'info');
            
            try {
                // Quick permission check
                if (Notification.permission !== 'granted') {
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') {
                        log('‚ùå Permission denied', 'error');
                        return;
                    }
                }
                
                // Register and subscribe
                const registration = await navigator.serviceWorker.register('/sw.js');
                await navigator.serviceWorker.ready;
                
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                });
                
                log('‚úÖ Successfully subscribed!', 'success');
                log(`Endpoint: ${subscription.endpoint}`, 'info');
                
                // Show test notification
                await registration.showNotification('Test Notification', {
                    body: 'Push notifications are working!',
                    icon: '/logo.svg',
                    badge: '/favicon.svg'
                });
                
            } catch (error) {
                log(`‚ùå Error: ${error.name} - ${error.message}`, 'error');
            }
        }

        // Auto-run on load
        window.onload = () => {
            log('Diagnostic tool ready. Click "Run Full Diagnostics" to start.', 'info');
        };
    </script>
</body>
</html>
